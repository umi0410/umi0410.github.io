<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>JPA on Jinsu Playground</title><link>https://umi0410.github.io/categories/jpa/</link><description>Recent content in JPA on Jinsu Playground</description><generator>Hugo -- gohugo.io</generator><language>ko-kr</language><lastBuildDate>Wed, 24 Nov 2021 03:46:54 +0900</lastBuildDate><atom:link href="https://umi0410.github.io/categories/jpa/index.xml" rel="self" type="application/rss+xml"/><item><title>ì¿¼ë¦¬ ìµœì í™”í•˜ê¸° - ì¡°íšŒìˆ˜ì™€ ê°™ì€ Count ì„±ê²©ì˜ ì‘ì—… ìµœì í™”í•˜ê¸° (N+1 ë¬¸ì œ ê´€ë ¨, feat. Redis)</title><link>https://umi0410.github.io/blog/optimizing-count-query-strategy/</link><pubDate>Wed, 24 Nov 2021 03:46:54 +0900</pubDate><guid>https://umi0410.github.io/blog/optimizing-count-query-strategy/</guid><description>&lt;img src="https://umi0410.github.io/blog/optimizing-count-query-strategy/index.png" alt="Featured image of post ì¿¼ë¦¬ ìµœì í™”í•˜ê¸° - ì¡°íšŒìˆ˜ì™€ ê°™ì€ Count ì„±ê²©ì˜ ì‘ì—… ìµœì í™”í•˜ê¸° (N+1 ë¬¸ì œ ê´€ë ¨, feat. Redis)" />&lt;h2 id="ì‹œì‘í•˜ë©°">ì‹œì‘í•˜ë©°&lt;/h2>
&lt;p>&lt;img src="https://umi0410.github.io/blog/optimizing-count-query-strategy/monitoring.png"
width="1012"
height="437"
srcset="https://umi0410.github.io/blog/optimizing-count-query-strategy/monitoring_hu3985549258cc81ebaf9b1ddb4dd53245_70044_480x0_resize_box_3.png 480w, https://umi0410.github.io/blog/optimizing-count-query-strategy/monitoring_hu3985549258cc81ebaf9b1ddb4dd53245_70044_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="Sentry monitoring - ëŠë ¤ì§„ API Latency"
class="gallery-image"
data-flex-grow="231"
data-flex-basis="555px"
>&lt;/p>
&lt;p>&lt;strong>ì§§ì€ ì˜ìƒì„ ë°”íƒ•ìœ¼ë¡œ ë°°í‹€ì„ í•  ìˆ˜ ìˆëŠ” ì„œë¹„ìŠ¤ë¥¼ &lt;code>Spring Boot MVC&lt;/code> + &lt;code>JPA&lt;/code>ë¡œ ê°œë°œ&lt;/strong>í•˜ë˜ ì¤‘ ìœ„ì™€ ê°™ì´ API &lt;strong>Latencyê°€ ì²˜ì°¸í•˜ê²Œë„ ëŠë¦° ìš”ì²­&lt;/strong>ë“¤ì´ ê°ì§€ë˜ê¸° ì‹œì‘í–ˆìŠµë‹ˆë‹¤. ê·¸ë™ì•ˆì€ ì¿¼ë¦¬ ìµœì í™”ë³´ë‹¤ëŠ” ë¡œì§ ê°œë°œì´ ë” ìš°ì„ ì‹œí•˜ë‹¤ë³´ë‹ˆ ì¿¼ë¦¬ ìµœì í™”ë¥¼ ë¯¸ë¤„ì™”ëŠ”ë°,
ì´ë²ˆ ê¸°íšŒì— ì´ì— ëŒ€í•´ ë‹¤ë¤„ë³´ë ¤í•©ë‹ˆë‹¤. ê°„ë‹¨í•˜ê²Œ ì½”ë“œë¥¼ ì§œì„œ í…ŒìŠ¤íŠ¸í•´ë³´ëŠë¼ Go ì–¸ì–´ë¥¼ ì´ìš©í–ˆì§€ë§Œ &lt;strong>JPAë¥¼ ì´ìš©í•˜ë“  ë­˜ ì´ìš©í•˜ë“  ë¬¸ì œì™€ ê·¸ì— ëŒ€í•œ í•´ê²°ì±…ì˜ ìš”ì§€ëŠ” ë™ì¼í•  ê²ƒ&lt;/strong>ì…ë‹ˆë‹¤.&lt;/p>
&lt;p>ì•„ë¬´ë˜ë„ ë°±ì—”ë“œì—ì„œ APIë¥¼ ê°œë°œí•˜ë©´ì„œ íŒŒì¼ ë°ì´í„°ë¥¼ ì£¼ê³  ë°›ëŠ” ê²Œ ì•„ë‹ˆë¼ë©´ ì£¼ë¡œ Latencyê°€ ëŠ˜ì–´ë‚˜ëŠ” ì´ìœ ëŠ” ë‹¤ìŒê³¼ ê°™ì„ ê²ƒì…ë‹ˆë‹¤.&lt;/p>
&lt;ul>
&lt;li>ë„ˆë¬´ ë§ì€ Write&lt;/li>
&lt;li>ë¶ˆí•„ìš”í•œ Column(í•„ë“œ) í˜¹ì€ ê´€ê³„ë¥¼ Eager Loading. ì¶”ê°€ì ìœ¼ë¡œ ê²½ìš°ì— ë”°ë¼ &lt;strong>N+1 ì¿¼ë¦¬ ë¬¸ì œ&lt;/strong> ë°œìƒ&lt;/li>
&lt;li>í•„ìš”í•œ Column(í•„ë“œ) í˜¹ì€ ê´€ê³„ë¥¼ ë’¤ëŠ¦ê²Œ Lazy Loading. ì¶”ê°€ì ìœ¼ë¡œ ê²½ìš°ì— ë”°ë¼ &lt;strong>N+1 ì¿¼ë¦¬ ë¬¸ì œ&lt;/strong> ë°œìƒ&lt;/li>
&lt;li>&lt;strong>ìš”ì²­ë§ˆë‹¤ ë§¤ë²ˆ ìˆ˜í–‰ë˜ëŠ” Joinì´ë‚˜ ì¼ì¢…ì˜ ì—°ì‚°ë“¤&lt;/strong>&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>&lt;code>N+1&lt;/code> ì¿¼ë¦¬ ë¬¸ì œ? - Nê°œì˜ ë°ì´í„°ë¥¼ ì¡°íšŒí•œ ê²½ìš°, ê° ë°ì´í„°ë“¤ì˜ ì—°ê´€ ê´€ê³„ë¥¼ ì¶”ê°€ì ìœ¼ë¡œ ì¡°íšŒí•˜ê¸° ìœ„í•´ í•œ ë²ˆì”© ë” ì¡°íšŒí•´ì•¼í•˜ëŠ” ë¬¸ì œ&amp;hellip; ì•„ì£¼ ì•…ëª… ë†’ì€ ë¬¸ì œë¡œ ìë£Œë¥¼ ì‰½ê²Œ ì°¾ì•„ë³¼ ìˆ˜ ìˆë‹¤.&lt;/p>
&lt;/blockquote>
&lt;p>ì‚¬ì‹¤ ì–´ë–»ê²Œ ë³´ë©´ N+1 ì¿¼ë¦¬ ë¬¸ì œê°€ ì›Œë‚™ ì•…ëª…ì´ ë†’ì•„ ê·¸ì— ëŒ€í•œ í•´ê²°ì±…ë“¤ë„ ê°„ë‹¨í•˜ê²ŒëŠ” ë§ì´ ì†Œê°œë˜ëŠ” ê²ƒ ê°™ê¸°ë„ í•©ë‹ˆë‹¤. ë”°ë¼ì„œ ì´ë²ˆ ê¸€ì—ì„œëŠ” ì¡°ê¸ˆì€ íŠ¹ì´í•˜ê²Œ &lt;strong>ì¡°íšŒìˆ˜ë‚˜ ëŒ“ê¸€ ê°œìˆ˜ì²˜ëŸ¼ ì¼ì¢…ì˜ Count ê¸°ëŠ¥ì´ í•„ìš”í•œ ê²½ìš°ì˜ N+1 ì¿¼ë¦¬ ë¬¸ì œë‚˜ ìš”ì²­ë§ˆë‹¤ ë§¤ë²ˆ ìˆ˜í–‰ë˜ëŠ” Joinì´ë‚˜ ì—°ì‚°ë“¤ë¡œ ì¸í•œ
ì˜¤ë²„í—¤ë“œë“¤ì„ ì¤„ì—¬ ìµœì í™”&lt;/strong>í•˜ëŠ” ë°©ë²•ì€ ì–´ë–¤ ê²ƒë“¤ì´ ìˆì„ì§€ì— ëŒ€í•œ ì œ ê³ ë¯¼ì„ ì†Œê°œí•´ë³´ë ¤ í•©ë‹ˆë‹¤.&lt;/p>
&lt;p>&lt;strong>&lt;em>(ì´ ê¸€ì€ RDBë¥¼ ë©”ì¸ DBë¡œ ì‚¬ìš©í•˜ëŠ” ê²½ìš°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì‘ì„±í–ˆìŠµë‹ˆë‹¤.)&lt;/em>&lt;/strong>&lt;/p>
&lt;h2 id="ì˜ìƒ-ì¡°íšŒìˆ˜-ê°™ì€-count-ì„±ê²©ì˜-ê°’ì—-ëŒ€í•œ-ì‘ì—…ì„-ìµœì í™”í•˜ì§€-ì•Šìœ¼ë©´">ì˜ìƒ ì¡°íšŒìˆ˜ ê°™ì€ Count ì„±ê²©ì˜ ê°’ì— ëŒ€í•œ ì‘ì—…ì„ ìµœì í™”í•˜ì§€ ì•Šìœ¼ë©´?!&lt;/h2>
&lt;ul>
&lt;li>ìŸì•„ì§€ëŠ” ì˜ìƒ ì¡°íšŒ ì´ë²¤íŠ¸ë§ˆë‹¤ RDBì— ë°ì´í„°ë¥¼ Write =&amp;gt; RDBì— ë„ˆë¬´ í° ë¶€í•˜&lt;/li>
&lt;li>ë§¤ë²ˆ íŠ¹ì • ì˜ìƒê³¼ ê´€ë ¨ëœ ì¡°íšŒ ë‚´ì—­ì„ RDBì—ì„œ Join í›„ ê·¸ ê°œìˆ˜ë¥¼ ê³„ì‚° =&amp;gt; RDBì— ë¶€í•˜, ëŠë¦° ì‘ì—…&lt;/li>
&lt;li>RDBì— ì˜ìƒ ì¡°íšŒ ì´ë²¤íŠ¸ë¥¼ Writeí•  ë•Œ ì˜ìƒ ì •ë³´ í…Œì´ë¸”ì— view_count ì»¬ëŸ¼ì„ ì¶”ê°€í•œ ë’¤ view_count ì»¬ëŸ¼ì— ì¡°íšŒìˆ˜ë¥¼ ìºì‹œ =&amp;gt; ìºì‹œ ì •í™•ë„ ë¬¸ì œ, í…Œì´ë¸” ì •ì˜ ë³€ê²½ í•„ìš”&lt;/li>
&lt;/ul>
&lt;p>ì˜ìƒ ì¡°íšŒìˆ˜ ê°™ì€ Count ì„±ê²©ì˜ ê°’ì„ ìµœì í™”í•´ì£¼ì§€ ì•Šìœ¼ë©´ ìœ„ì™€ ê°™ì€ ë¬¸ì œë“¤ì´ ë°œìƒí•  ìˆ˜ ìˆë‹¤ê³  ë´…ë‹ˆë‹¤.&lt;/p>
&lt;p>ë”°ë¼ì„œ ì˜ìƒ ì¡°íšŒ ì´ë²¤íŠ¸ì²˜ëŸ¼ ìŸì•„ì§€ëŠ” ë°ì´í„°ëŠ” ë„ˆë¬´ ë§ì€ Write ìš”ì²­ì€ RDBê°€ ì•„ë‹Œ NoSQLì„ ì‚¬ìš©í•˜ëŠ” ê²Œ ì¢‹ì„ ìˆ˜ ìˆì„ ê²ƒì…ë‹ˆë‹¤.&lt;/p>
&lt;p>í•˜ì§€ë§Œ NoSQLì— ì˜ìƒ ì¡°íšŒ ì´ë²¤íŠ¸ë¥¼ ì €ì¥í•œë‹¤ í•´ë„ ë§¤ë²ˆ ì˜ìƒ ì¡°íšŒ ë‚´ì—­ì„ ê°€ì ¸ì˜¨ ë’¤ ê·¸ ê°œìˆ˜ë¥¼ ê³„ì‚°í•˜ëŠ” ë°©ì‹ì€ ì–´ë–¤ DBë¥¼ ì‚¬ìš©í•˜ë˜ ë¶ˆí•„ìš”í•œ Readë„ ë§ì´ ë°œìƒí•  ê²ƒì´ê³ , ë‹¹ì—°íˆ ëŠë¦¬ê² ì£ . ë§Œì•½ ì–´ë–¤ ì˜ìƒì˜ ì¡°íšŒìˆ˜ê°€ 10ë§Œì¸ ê²½ìš° 10ë§Œê°œì˜ ì´ë²¤íŠ¸ë“¤ì„ ì¡°íšŒí•œ ë’¤ ê·¸ ê°œìˆ˜ë¥¼ ì´ìš©í•´ì•¼í• í…Œë‹ˆ ë§ì…ë‹ˆë‹¤.
ê²½ìš°ì— ë”°ë¼ì„œëŠ” ì˜ìƒ ì¡°íšŒ ì‹œ ê° ì˜ìƒì— ëŒ€í•œ ì¡°íšŒ ë‚´ì—­ì„ ì¶”ê°€ì ìœ¼ë¡œ ì¡°íšŒí•˜ê²Œ ë˜ëŠ” N+1 ì¿¼ë¦¬ ë¬¸ì œë¥¼ ê²ªì„ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.&lt;/p>
&lt;p>ë”°ë¼ì„œ &lt;strong>&lt;code>view_count&lt;/code> ê°™ì€ columnì„ ì¶”ê°€ì ìœ¼ë¡œ ë‘ëŠ” ê±´ ì–´ë–¨ê¹Œ&lt;/strong>ì‹¶ê¸°ë„ í•©ë‹ˆë‹¤ë§Œ ì¼ë°˜ì ìœ¼ë¡œëŠ” &lt;strong>ë™ì‹œì„± ì´ìŠˆë¡œ ì¸í•´ view_countì˜ ì •í™•ë„ê°€ ë–¨ì–´ì§€ê²Œ ë  ê²ƒ&lt;/strong>ì…ë‹ˆë‹¤. ë˜í•œ &lt;strong>ìŠ¤í‚¤ë§ˆê°€ ê°•ìš”ë˜ëŠ” RDBì˜ íŠ¹ì„±ì— ì˜í•´ í…Œì´ë¸” ì •ì˜ê°€ ë³€ê²½ë˜ì–´ì•¼í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤&lt;/strong>.&lt;/p>
&lt;blockquote>
&lt;p>ë™ì‹œì„± ì´ìŠˆ - ë§Œì•½ 100ëª…ì˜ ìœ ì €ì— ëŒ€í•œ ì˜ìƒ ì¡°íšŒë¥¼ ë™ì‹œì— ì²˜ë¦¬í•˜ëŠ” ê²½ìš° 100ê°œì˜ ìŠ¤ë ˆë“œëŠ” ëª¨ë‘ view_count=0 ìœ¼ë¡œ ì¡°íšŒë¥¼ í•œ ë’¤ ìì‹ ì˜ ì¡°íšŒ ì´ë²¤íŠ¸ë¡œ ì¸í•œ +1ì„ ë”í•´ view_count=1ë¡œ ì—…ë°ì´íŠ¸ ì»¤ë§¨ë“œë¥¼ ë‚ ë¦¬ê² ì§€ë§Œ ì‚¬ì‹¤ view_countëŠ” 1ì´ ì•„ë‹Œ 100ì´ ë˜ì–´ì•¼ ì •í™•í•œ ê²ƒì´ë‹¤.&lt;/p>
&lt;/blockquote>
&lt;h2 id="redisë¥¼-ë„ì…í•´ë³´ë©´-ì–´ë–¨ê¹Œ">Redisë¥¼ ë„ì…í•´ë³´ë©´ ì–´ë–¨ê¹Œ&lt;/h2>
&lt;p>&lt;code>Redis&lt;/code>ëŠ” ë©”ëª¨ë¦¬ë¥¼ ê¸°ë°˜ìœ¼ë¡œí•˜ëŠ” Key-Value í˜•íƒœì˜ NoSQLë¼ì„œ ì¼ë°˜ì ì¸ RDBì— ë¹„í•´ ì•„ì£¼ ë¹ ë¥´ë©´ì„œ ì‹±ê¸€ ìŠ¤ë ˆë“œ ê¸°ë°˜ì´ê¸° ë•Œë¬¸ì— ì •í™•í•œ Countì™€ Incrementê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤. ë”°ë¼ì„œ ì•„ê¹Œ ë°œìƒí–ˆë˜ ë¬¸ì œë“¤ì„ ë‹¤ìŒê³¼ ê°™ì´ í•´ê²°í•  ìˆ˜ ìˆì„ ê²ƒì…ë‹ˆë‹¤.&lt;/p>
&lt;ul>
&lt;li>
&lt;p>ìŸì•„ì§€ëŠ” ì˜ìƒ ì¡°íšŒ ì´ë²¤íŠ¸ë§ˆë‹¤ RDBì— ë°ì´í„°ë¥¼ Write&lt;/p>
&lt;p>=&amp;gt; &lt;del>RDBì— ë„ˆë¬´ í° ë¶€í•˜&lt;/del> (X), &lt;strong>ë¹ ë¥¸ Write&lt;/strong> (O)&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ë§¤ë²ˆ íŠ¹ì • ì˜ìƒê³¼ ê´€ë ¨ëœ ì¡°íšŒ ë‚´ì—­ì„ RDBì—ì„œ Join í›„ ê·¸ ê°œìˆ˜ë¥¼ ê³„ì‚°&lt;/p>
&lt;p>=&amp;gt; &lt;del>RDBì— ë¶€í•˜, ëŠë¦° ì‘ì—…&lt;/del> (X), &lt;strong>Redisì— ìµœê·¼ ì¡°íšŒ ë‚´ì—­ì„ ì €ì¥&lt;/strong>, ìƒí™©ì— ë”°ë¼ NoSQLì—ì„œ Replicateí•´ì„œ ì˜êµ¬í™”í•˜ëŠ” ê²ƒë„ ì¢‹ìŒ (O)&lt;/p>
&lt;/li>
&lt;li>
&lt;p>RDBì— ì˜ìƒ ì¡°íšŒ ì´ë²¤íŠ¸ë¥¼ Writeí•  ë•Œ ì˜ìƒ ì •ë³´ í…Œì´ë¸”ì— view_count ì»¬ëŸ¼ì„ ì¶”ê°€í•œ ë’¤ view_count ì»¬ëŸ¼ì— ì¡°íšŒìˆ˜ë¥¼ ìºì‹œ&lt;/p>
&lt;p>=&amp;gt; &lt;del>ìºì‹œ ì •í™•ë„ ë¬¸ì œ&lt;/del> (X), &lt;strong>Redisì˜ ì‹±ê¸€ìŠ¤ë ˆë“œ ê¸°ë°˜ì˜ ì •í™•í•œ ê³„ì‚°&lt;/strong>&lt;/p>
&lt;p>=&amp;gt; &lt;del>í…Œì´ë¸” ì •ì˜ ë³€ê²½ í•„ìš”&lt;/del> (X), &lt;strong>NoSQLì˜ ìœ ì—°í•¨&lt;/strong> (O)&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>ì´ëŸ° ì´ìœ ë¡œ ì¸í•´ ì¶”í›„ì— &lt;strong>ì¡°íšŒìˆ˜ë‚˜ ëŒ“ê¸€ ìˆ˜, íŒ”ë¡œì›Œ ìˆ˜ ë“±ë“±ì— ëŒ€í•´ Redisë¥¼ ì´ìš©í•˜ë©´ ì–´ë–¨ê¹Œ ì‹¶ì€ ìƒê°ì´ ë“œë„¤ìš”~!&lt;/strong> ê·¸ëŸ¼ ì‹¤ì œë¡œ ì•ì„œ ì†Œê°œí–ˆë˜ ë¬¸ì œ ìƒí™©ì´ë‚˜ í•´ê²° ë°©ë²•ë“¤ì´ ê°ê° ì„±ëŠ¥ì´ ì–´ë–¨ì§€ ì§ì ‘ ë°ì´í„°ì™€ ì¿¼ë¦¬ë¥¼ ì´ìš©í•´ ì‹¤í—˜í•´ë³´ê² ìŠµë‹ˆë‹¤.&lt;/p>
&lt;h2 id="ì‹¤ì œ-ì‹¤í—˜ì„-í†µí•´-ê°ê°ì˜-ë°©ì‹-ì„±ëŠ¥-ë¹„êµ">ì‹¤ì œ ì‹¤í—˜ì„ í†µí•´ ê°ê°ì˜ ë°©ì‹ ì„±ëŠ¥ ë¹„êµ&lt;/h2>
&lt;h3 id="ìƒí™©-ì†Œê°œ">ìƒí™© ì†Œê°œ&lt;/h3>
&lt;ul>
&lt;li>Localì—ì„œ Redis container, MySQL containerì„ ì´ìš©. Goì–¸ì–´ë¡œ ê°€ë³ê²Œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‘ì„±&lt;/li>
&lt;li>MySQLì˜ Video í…Œì´ë¸”ì— 1000ê°œì˜ ì˜ìƒ ë°ì´í„° ì¡´ì¬. ì¡°íšŒìˆ˜ë¥¼ ìºì‹œí•´ë†“ì€ view_count ì»¬ëŸ¼ ì¡´ì¬.&lt;/li>
&lt;li>MySQLì˜ View í…Œì´ë¸”ì— ì•½ 2ì²œë§Œ ê°œì˜ ì¡°íšŒ ë‚´ì—­ ì¡´ì¬.(ì¦‰ ì˜ìƒ ë‹¹ ìˆ˜ì²œê°œì˜ ì¡°íšŒ ë‚´ì—­ ì¡´ì¬) ì¸ë±ìŠ¤ëŠ” ì˜ ê±¸ì–´ë†“ìŒ.&lt;/li>
&lt;li>Redisì— &lt;code>key=video_view_count:{{video_id}}&lt;/code>, &lt;code>value={{view_count}}&lt;/code> í˜•íƒœë¡œ view_count ìºì‹œ&lt;/li>
&lt;li>&lt;strong>ëœë¤í•˜ê²Œ 5ê°œì˜ ì˜ìƒì— ëŒ€í•œ ì •ë³´ë¥¼ ì œê³µí•  ê²ƒì¸ë° ì´ë•Œ ì¡°íšŒìˆ˜ë„ í¬í•¨ë˜ì–´ì•¼í•œë‹¤.&lt;/strong>&lt;/li>
&lt;/ul>
&lt;h3 id="ë¹„êµí• -ë°©ì‹ë“¤-ì†Œê°œ">ë¹„êµí•  ë°©ì‹ë“¤ ì†Œê°œ&lt;/h3>
&lt;ul>
&lt;li>&lt;strong>Select í›„ Redisì— ìºì‹œëœ ì¡°íšŒìˆ˜ ì´ìš©&lt;/strong>
&lt;ul>
&lt;li>ì˜ìƒì— ëŒ€í•œ ì •ë³´ ìì²´ëŠ” Video í…Œì´ë¸”ì„ ì´ìš©í•´ Read&lt;/li>
&lt;li>ì¡°íšŒìˆ˜ëŠ” Redisì— ìºì‹œëœ ê°’ì„ MGETì„ í†µí•´ ë°°ì¹˜(ë²Œí¬)ë¡œ ì¡°íšŒí•´ì™€ì„œ ì´ìš©&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>Select í•˜ë©° Columnì— ìºì‹œëœ ì¡°íšŒìˆ˜ ì´ìš©&lt;/strong>
&lt;ul>
&lt;li>ì˜ìƒ ì •ë³´ì™€ ì¡°íšŒìˆ˜ ëª¨ë‘ Video í…Œì´ë¸”ì„ í†µí•´ ë°”ë¡œ Read&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>Select í›„ Batchë¡œ In-Query&lt;/strong>
&lt;ul>
&lt;li>JPAë¥¼ ì´ìš©í•˜ë©´ì„œ í”íˆ ë°œìƒí–ˆë˜ N+1 ì¿¼ë¦¬ë¥¼ Batchë¡œ í•´ê²°í•  ë•Œì™€ ë™ì¼í•˜ê²Œ Video í…Œì´ë¸” ì¡°íšŒ í›„ View í…Œì´ë¸”ì—ì„œ view.id in (?,?,&amp;hellip;) ì˜ í˜•íƒœë¡œ In-Queryë¥¼ ì´ìš©&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>&lt;strong>Select í›„ ë‚˜ì¤‘ì— ê°ê°ì„ Join&lt;/strong>
&lt;ul>
&lt;li>N+1 ì¿¼ë¦¬ ë¬¸ì œ ê·¸ ìì²´..!&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h3 id="ì‹¤í—˜-ê²°ê³¼">ì‹¤í—˜ ê²°ê³¼&lt;/h3>
&lt;p>&lt;img src="https://umi0410.github.io/blog/optimizing-count-query-strategy/result-1.png"
width="2520"
height="783"
srcset="https://umi0410.github.io/blog/optimizing-count-query-strategy/result-1_hu2b8142f32263cafd399ddd7e1ab96ace_456229_480x0_resize_box_3.png 480w, https://umi0410.github.io/blog/optimizing-count-query-strategy/result-1_hu2b8142f32263cafd399ddd7e1ab96ace_456229_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="ì‹¤í—˜ ê²°ê³¼ 1"
class="gallery-image"
data-flex-grow="321"
data-flex-basis="772px"
>&lt;/p>
&lt;ol>
&lt;li>ğŸ¥‡ &lt;strong>Select í•˜ë©° Columnì— ìºì‹œëœ ì¡°íšŒìˆ˜ ì´ìš©&lt;/strong>&lt;/li>
&lt;li>ğŸ¥ˆ &lt;strong>Select í›„ Redisì— ìºì‹œëœ ì¡°íšŒìˆ˜ ì´ìš©&lt;/strong>&lt;/li>
&lt;li>ğŸ¥‰ &lt;strong>Select í›„ ë‚˜ì¤‘ì— ê°ê°ì„ Join&lt;/strong>&lt;/li>
&lt;li>&lt;strong>Select í›„ Batchë¡œ In-Query&lt;/strong>&lt;/li>
&lt;/ol>
&lt;p>ìš°ì„ ì€ ì–´ë–¤ ìª½ìœ¼ë¡œë“  ìºì‹±ì„ ì´ìš©í•˜ëŠ” ê²Œ ì°¸ ë¹ ë¥´êµ¬ë‚˜ ì‹¶ì—ˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ì¡°ê¸ˆ ì˜ì•„í•  ìˆ˜ ìˆëŠ” ë¶€ë¶„ë“¤ë„ ì¡´ì¬í•˜ëŠ”ë°ìš”.&lt;/p>
&lt;ol>
&lt;li>&lt;strong>Redisì— ì¡°íšŒìˆ˜ë¥¼ ìºì‹±í•œ ê²½ìš°ë³´ë‹¤ MySQLì— ìºì‹±í•œ ê²½ìš°ê°€ ë” ë¹ ë¥´ë„¤..?&lt;/strong>&lt;/li>
&lt;/ol>
&lt;p>ì–´ë–»ê²Œë³´ë©´ ë‹¹ì—°í•˜ê² ì§€ë§Œ &lt;strong>MySQLì—ì„œ Join ì—†ì´ view_countë¥¼ ì¡°íšŒí•  ìˆ˜ë§Œ ìˆë‹¤ë©´ Redisë¥¼ ê±°ì¹˜ëŠ” ê²ƒë³´ë‹¤ MySQLë§Œìœ¼ë¡œ ì²˜ë¦¬í•˜ëŠ” ê²ƒì´ ë” ë¹ ë¥¼ ê²ƒ&lt;/strong>ì…ë‹ˆë‹¤.&lt;/p>
&lt;p>í•˜ì§€ë§Œ Redisë¥¼ ì‚¬ìš©í•˜ëŠ” ì´ìœ ê°€ Read ì†ë„ë•Œë¬¸ë§Œì€ ì•„ë‹ ê²ƒì…ë‹ˆë‹¤. ì•ì„œ ë§ì”€ë“œë¦° ëŒ€ë¡œ &lt;strong>ì‹±ê¸€ ìŠ¤ë ˆë“œ ê¸°ë°˜ì˜ ì •í™•í•œ count&lt;/strong>ê°€ ê°€ëŠ¥í•  ê²ƒì´ê³ , RDBì˜ &lt;strong>í…Œì´ë¸” ìŠ¤í‚¤ë§ˆë¥¼ ë³€ê²½í•  í•„ìš”ë„ ì—†ì£ &lt;/strong>.&lt;/p>
&lt;p>ê·¸ë¦¬ê³  ë¬´ì—‡ë³´ë‹¤ ì˜ìƒ ì¡°íšŒ ì´ë²¤íŠ¸ ë°œìƒë§ˆë‹¤ RDBì˜ íŠ¹ì • rowì˜ ì¡°íšŒìˆ˜ë¥¼ +1 í•˜ì—¬ update í•˜ëŠ” ê²ƒë³´ë‹¤ëŠ” redisì—ì„œ incrementí•˜ëŠ” ê²ƒì´ ë¹ ë¥¼ ê²ƒì…ë‹ˆë‹¤! ì¦‰, &lt;strong>writeê¹Œì§€ ê³ ë ¤í•˜ë©´ ì†ë„ ì¸¡ë©´ì—ì„œë„ redisê°€ ë¹ ë¥¼ ê²ƒ&lt;/strong>ì…ë‹ˆë‹¤.&lt;/p>
&lt;ol start="2">
&lt;li>&lt;strong>N+1 ì¿¼ë¦¬ ë¬¸ì œë¥¼ ì•¼ê¸°í•˜ëŠ” ë°©ì‹ì´ Batchë¡œ In-Queryí•˜ëŠ” ë°©ì‹ë³´ë‹¤ ë¹ ë¥´ë„¤..?&lt;/strong>&lt;/li>
&lt;/ol>
&lt;p>ì´ ë¶€ë¶„ì€ ì •í™•í•œ ì›ì¸ì€ ëª¨ë¥´ê² ì§€ë§Œ ì•„ë§ˆ ì¶”ì¸¡ì»¨ëŒ€ Batch ë°©ì‹ìœ¼ë¡œ í•œ ë²ˆì— ëª‡ ë§Œê°œ ìˆ˜ì¤€ì˜ ë„ˆë¬´ë‚˜ ë§ì€ ë°ì´í„°ë¥¼ ì¹´í‹°ì…˜ ê³±ìœ¼ë¡œ ì¡°íšŒí•œ ë’¤ ê° videoì˜ ì¡°íšŒìˆ˜ ë‚´ì—­ìœ¼ë¡œ ë„£ì–´ì£¼ë ¤ë‹¤ë³´ë‹ˆ ì¡°íšŒ í›„ ì—°ì‚°ì´ ë§ì€ ì‹œê°„ì„ ì¡ì•„ë¨¹ì€ ê²Œ ì•„ë‹ê¹Œ ì‹¶ìŠµë‹ˆë‹¤.
ë°˜ë©´ N+1 ì¿¼ë¦¬ ë°©ì‹ì€ ê° videoì— ëŒ€í•´ í•œ ë²ˆì”© ì¿¼ë¦¬í•œ ë’¤ ë°”ë¡œ ê·¸ ê²°ê³¼ count í•  ìˆ˜ ìˆìœ¼ë‹ˆ ì´ëŸ° íŠ¹ìˆ˜í•œ ê²½ìš°(ë°ì´í„°ê°€ ì—„~ì²­ ë§ì€ ê²½ìš°)ì—ëŠ” ì˜¤íˆë ¤ Batch ë°©ì‹ì´ ëŠë¦´ ìˆ˜ ìˆëŠ” ê²Œ ì•„ë‹ê¹Œ ì‹¶ìŠµë‹ˆë‹¤.&lt;/p>
&lt;p>ì‹¤ì œë¡œ ì¡°íšŒìˆ˜ê°€ ì•½ 10ê°œ ì •ë„ì¸ ì˜ìƒì„ ë˜‘ê°™ì´ 5ê°œ ì¡°íšŒí•´ë³´ë‹ˆ ìš°ë¦¬ì˜ ì¼ë°˜ì ì¸ ì˜ˆìƒëŒ€ë¡œ Batch ë°©ì‹ì´ N+1 ì¿¼ë¦¬ë³´ë‹¤ ë¹¨ëëŠ”ë°ìš”! ì•„ë§ˆ ì¹´í‹°ì…˜ ê³±ì´ ì¼ì–´ë‚¬ì§€ë§Œ ì–‘ ìì²´ê°€ ì ì€ ì¿¼ë¦¬ ê²°ê³¼ë¥¼ ì²˜ë¦¬í•˜ëŠ” ê²ƒì´ redisì™€ì˜ Në²ˆì˜ í†µì‹ ì´ ë” ëŠë¦¬ê¸° ë•Œë¬¸ì´ ì•„ë‹ê¹Œ ì‹¶ìŠµë‹ˆë‹¤.&lt;/p>
&lt;h2 id="ì¡°íšŒìˆ˜ë¥¼-ìœ„í•´-ê°€ì¥-ì´ìƒì ì¸-ì•„í‚¤í…ì³ëŠ”">ì¡°íšŒìˆ˜ë¥¼ ìœ„í•´ ê°€ì¥ ì´ìƒì ì¸ ì•„í‚¤í…ì³ëŠ”?!&lt;/h2>
&lt;p>&lt;img src="https://umi0410.github.io/blog/optimizing-count-query-strategy/architecture.png"
width="1315"
height="1236"
srcset="https://umi0410.github.io/blog/optimizing-count-query-strategy/architecture_hu2e0266c55b356006b8efd84bbe6e386e_394889_480x0_resize_box_3.png 480w, https://umi0410.github.io/blog/optimizing-count-query-strategy/architecture_hu2e0266c55b356006b8efd84bbe6e386e_394889_1024x0_resize_box_3.png 1024w"
loading="lazy"
alt="ìƒìƒ ì† ì•„í‚¤í…ì³"
class="gallery-image"
data-flex-grow="106"
data-flex-basis="255px"
>&lt;/p>
&lt;p>ì‹¤í—˜ ê²°ê³¼ì—ì„œë„ Redisë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ë‚˜ì˜ì§€ ì•Šì€ ê²ƒìœ¼ë¡œ ë³´ì—¬ì§‘ë‹ˆë‹¤. ê·¸ë˜ì„œ ì €ë¼ë©´ ì •ë§ ì´ëŸ° ì‹ìœ¼ë¡œ &lt;strong>ìµœì í™”ë¥¼ í•´ë³¼ ìˆ˜ ìˆëŠ” ê¸°íšŒê°€ ìˆë‹¤ë©´ Redisë¥¼ ë„ì…&lt;/strong>í•´ë³¼ ê²ƒ ê°™ìŠµë‹ˆë‹¤. ê·¸ ë™ì•ˆ ìˆ˜ì—†ì´ ê³ í†µë°›ì•„ì™”ë˜ N+1 ì¿¼ë¦¬ ë¬¸ì œë„ ì–´ëŠ ì •ë„ í•´ê²°í•  ìˆ˜ ìˆê² ì£ ?!
&lt;strong>ë¶ˆí•„ìš”í•œ ì–‘ë°©í–¥ ì—°ê´€ ê´€ê³„ëŠ” ìµœëŒ€í•œ ë‹¨ë°©í–¥ ì—°ê´€ ê´€ê³„ë¡œ ì œí•œí•˜ê³ , Countê°€ í•„ìš”í•  ë•Œ ê° ì—”í‹°í‹°ë§ˆë‹¤ì˜ íŠ¹ì • Count ê°’ì„ ìœ„í•´ Në²ˆì˜ ì¿¼ë¦¬ë¥¼ ìˆ˜í–‰í•  í•„ìš”ë„ ì—†ì–´ì§ˆ ê²ƒ&lt;/strong>ì…ë‹ˆë‹¤.&lt;/p>
&lt;p>í•˜ì§€ë§Œ Redisë¥¼ ë„ì…í•œë‹¤ê³  ë§Œì‚¬ê°€ í•´ê²°ë˜ëŠ” ê²ƒì€ ì•„ë‹ ê²ƒì…ë‹ˆë‹¤. RedisëŠ” ì˜ì†ì„±ì´ ë³´ì¥ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì˜ìƒ ì¡°íšŒ ë‚´ì—­ì´ ì¦ë°œí•´ë²„ë¦´ ìˆ˜ë„ ìˆê³ , ì–‘ì´ í•œì •ì ì¼ ìˆ˜ ìˆì£ . ê·¸ë˜ì„œ ì €ëŠ” ë‹¨ìˆœ Redis ë¿ë§Œ ì•„ë‹ˆë¼ ë‹¤ìŒê³¼ ê°™ì€ ë°©ì‹ì€ ì–´ë–¨ê¹Œ ìƒê°í•´ë³´ê³  ìˆìŠµë‹ˆë‹¤.&lt;/p>
&lt;ul>
&lt;li>&lt;strong>ìµœê·¼ ì˜ìƒ ì¡°íšŒ ë‚´ì—­&lt;/strong>ì€ &lt;code>view_histories:{{username}}&lt;/code> í˜•íƒœì˜ key, &lt;code>{{video_id}}&lt;/code> í˜•íƒœì˜ valueë¡œ 1ì°¨ì ìœ¼ë¡œ Redisì— ì €ì¥í•œë‹¤. &lt;strong>ì¡°íšŒìˆ˜&lt;/strong>ëŠ” &lt;code>view_count:{{vide_id}}&lt;/code> í˜•íƒœì˜ key, &lt;code>{{view_count}}&lt;/code> í˜•íƒœì˜ valueë¡œ Redisì— ìºì‹œí•œë‹¤.
&lt;ul>
&lt;li>ìµœê·¼ ì˜ìƒ ì¡°íšŒ ë‚´ì—­ì„ redisë¥¼ í†µí•´ ë¹ ë¥´ê²Œ ì½ê³  ì“¸ ìˆ˜ ìˆë‹¤.&lt;/li>
&lt;li>ì˜ìƒ ì¡°íšŒìˆ˜ë¥¼ Redisì˜ Incrementë¡œ ë¹„êµì  ì •í™•í•˜ê²Œ ê³„ì‚°í•  ìˆ˜ ìˆë‹¤.&lt;/li>
&lt;li>ìœ ì €ì˜ ìµœê·¼ ì˜ìƒ ì¡°íšŒ ë‚´ì—­ì„ ê° ìœ ì €ë³„ë¡œ TTLì„ ê±¸ ìˆ˜ ìˆë‹¤. =&amp;gt; Redis ë©”ëª¨ë¦¬ ì ˆì•½&lt;/li>
&lt;li>ì˜ìƒì˜ ì¡°íšŒìˆ˜ë¥¼ ì˜ìƒë³„ë¡œ TTL ê±¸ ìˆ˜ ìˆë‹¤ =&amp;gt; Redis ë©”ëª¨ë¦¬ ì ˆì•½&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>ì˜ìƒ ì¡°íšŒ ì´ë²¤íŠ¸ ì €ì¥ ì‹œ Redisì˜ &lt;code>event:video_viewed&lt;/code> ë¼ëŠ” keyì˜ Listì— ì•ì„œ ì–¸ê¸‰í•œ ì¡°íšŒ ë‚´ì—­ê³¼ ë™ì¼í•œ ì¡°íšŒ ë‚´ì—­ì„ ì €ì¥í•œë‹¤.(ë©”ì‹œì§€ íì— Enqueueí•˜ëŠ” ëŠë‚Œ)
&lt;ul>
&lt;li>SQS ê°™ì€ Message queueëŠ” ì¡°íšŒìˆ˜ ì´ë²¤íŠ¸ê°€ ìŸì•„ì§€ëŠ” ê²ƒì— ë¹„í•´ latencyê°€ ëŠë¦¼. ë”°ë¼ì„œ Redisë¥¼ íë¡œ ì‚¬ìš©í•˜ëŠ” ê²ƒë„ ê´œì°®ì•„ë³´ì„.&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Redis &lt;code>event:video_viewed&lt;/code> ë¼ëŠ” Listì—ì„œ ì¡°íšŒ ì´ë²¤íŠ¸ë¥¼ ë½‘ì•„ ì„œë²„ë¦¬ìŠ¤í•œ NoSQLì¸ DynamoDBì— ìœ ì €ì˜ ì¡°íšŒ ë‚´ì—­ì„ ì˜êµ¬ì ìœ¼ë¡œ ì €ì¥í•œë‹¤.
&lt;ul>
&lt;li>ì˜ìƒ ì¡°íšŒ ë‚´ì—­ì„ redisì— ìºì‹œí•  ë¿ë§Œ ì•„ë‹ˆë¼ ì˜êµ¬ì ìœ¼ë¡œ ì €ì¥í•˜ê¸° ìœ„í•¨.&lt;/li>
&lt;li>ë§ˆì¹˜ Redisë¥¼ ë²„í¼, Write-back cacheë¡œ ì´ìš©í•˜ëŠ” ëŠë‚Œì¸ë° NoSQLì´ë¼í•´ë„ ì£¼ê¸°ì ì¸ Bulk writeì€ ì£¼ê¸°ë•Œë§ˆë‹¤ ë¶€ë‹´ë  ìˆ˜ ìˆìŒ. ê·¸ë¦¬ê³  ì¡°íšŒ ì´ë²¤íŠ¸ëŠ” ê³„ì† ê³„ì† ë¹ ë¥´ê²Œ í™•ì¥ë  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— NoSQL ì¤‘ì—ë„ ì„œë²„ë¦¬ìŠ¤ì¸ DynamoDBë¥¼ ì‚¬ìš©í•˜ë©´ ì–´ë–¨ê¹Œ ì‹¶ìŒ. (ì£¼ì˜: DynamoDB ì•ˆì¨ë´„&amp;hellip;)&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;p>(ë‹¨ ìœ„ì˜ ì•„í‚¤í…ì³ëŠ” ì œ ê°œì¸ì ì¸ ìƒê°ì¼ ë¿, ì‹¤ì œë¡œëŠ” ì–´ë–»ê²Œë“¤ ì‚¬ìš©í•˜ì‹œëŠ”ì§€ ê¶ê¸ˆí•˜ë„¤ìš”..! ì´ë ‡ê²Œ ì§ì ‘ í•œ í•„ë“œì— ëŒ€í•´ ë³µì¡í•œ ë°©ì‹ì„ ì´ìš©í•˜ê¸°ë³´ë‹¨ ì¢€ ë” ë‹¨ìˆœíˆ ìºì‹± í”„ë ˆì„ì›Œí¬ë¥¼ ì´ìš©í•˜ëŠ” ê²ƒë„ ì¢‹ì€ ì„ íƒì§€ì¼ ìˆ˜ë„ ìˆì„ ê²ƒ ê°™êµ¬ìš”.)&lt;/p>
&lt;h2 id="ë§ˆì¹˜ë©°">ë§ˆì¹˜ë©°&lt;/h2>
&lt;p>ì´ë ‡ê²Œ Count ì„±í–¥ì˜ ì‘ì—…ì„ ì–´ë–»ê²Œ ìµœì í™”í•  ìˆ˜ ìˆì„ì§€ ìƒìƒê³¼ ì‹¤í—˜ì„ í†µí•´ ì •ë¦¬í•´ë´¤ìŠµë‹ˆë‹¤. ì¤‘ìš”í•œ ê²ƒì€ í•˜ë‚˜ì˜ ì •ë‹µì´ ì¡´ì¬í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆê³ , ì²˜í•œ ìƒí™©ë§ˆë‹¤ ì²œì°¨ë§Œë³„ì˜ ì†”ë£¨ì…˜ë“¤ì´ ìˆì„í…Œë‹ˆ ê°ê°ì„ ì˜ ë¹„êµí•´ë³´ê³  ì˜ PoC í•œ ë’¤ ì‚¬ìš©í•˜ëŠ” ê²ƒì¸ ë“¯í•©ë‹ˆë‹¤.&lt;/p>
&lt;p>ìºì‹œë‚˜ Redisì— ëŒ€í•´ ê´€ì‹¬ì´ ë§ì€ í¸ì´ì§€ë§Œ, ì•„ì§ ë§ì´ ë¶€ì¡±í•˜ë‹¤ë³´ë‹ˆ ì¢‹ì€ ë§ì”€ ëŒ“ê¸€ë¡œ ë‹¬ì•„ì£¼ì‹œë©´ ê°ì‚¬íˆ ë°°ì›Œë‚˜ê°€ê² ìŠµë‹ˆë‹¤~! ê°ì‚¬í•©ë‹ˆë‹¤.&lt;/p></description></item></channel></rss>