<!doctype html><html lang=ko-kr dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Go로 이미지 프로세싱 서버를 만들면서 Memory Leak 이슈를 맞이했고
그 이슈를 해결하기 위해 했던 삽질과 그 결과에 대한 썰을 적어보았습니다.
"><title>개발 썰 - Go Memory Leak(메모리 누수) 관련 이슈</title><link rel=canonical href=https://umi0410.github.io/blog/golang/go-memory-leak-issue/><link rel=stylesheet href=/scss/style.min.ac77dcf8b111b51da39a92990f431923f210f3876d85798a2125667f96dc33a4.css><meta property="og:title" content="개발 썰 - Go Memory Leak(메모리 누수) 관련 이슈"><meta property="og:description" content="Go로 이미지 프로세싱 서버를 만들면서 Memory Leak 이슈를 맞이했고
그 이슈를 해결하기 위해 했던 삽질과 그 결과에 대한 썰을 적어보았습니다.
"><meta property="og:url" content="https://umi0410.github.io/blog/golang/go-memory-leak-issue/"><meta property="og:site_name" content="Jinsu Playground"><meta property="og:type" content="article"><meta property="article:section" content="Blog"><meta property="article:published_time" content="2021-01-27T15:25:54+09:00"><meta property="article:modified_time" content="2021-01-27T15:25:54+09:00"><meta property="og:image" content="https://umi0410.github.io/blog/golang/go-memory-leak-issue/memory-leak-graph.png"><meta name=twitter:title content="개발 썰 - Go Memory Leak(메모리 누수) 관련 이슈"><meta name=twitter:description content="Go로 이미지 프로세싱 서버를 만들면서 Memory Leak 이슈를 맞이했고
그 이슈를 해결하기 위해 했던 삽질과 그 결과에 대한 썰을 적어보았습니다.
"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://umi0410.github.io/blog/golang/go-memory-leak-issue/memory-leak-graph.png"><link rel="shortcut icon" href=https://emojipedia-us.s3.dualstack.us-west-1.amazonaws.com/thumbs/120/google/241/whale_1f40b.png><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-177403492-1","auto"),ga("send","pageview"))</script><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=East+Sea+Dokdo&family=Noto+Sans+KR:wght@400&display=swap" rel=stylesheet><style>@import 'https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css';:root{--body-background:#fafeff;--base-font-family:Pretendard, 'Noto Sans KR', sans-serif}.site-name{--site-name-font-family:'East Sea Dokdo', cursive;font-family:var(--site-name-font-family);font-size:3.2rem!important}.left-sidebar{--sidebar-avatar-size:200px}figure.site-avatar{margin-left:auto!important;margin-right:auto!important}</style></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="메뉴 여닫기">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/media/profile-4_hudc34098363ccb08f8d79d9fad9c3f6b5_384264_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a>
<span class=emoji>🧸</span></figure><div class=site-meta><h1 class=site-name><a href=/>Jinsu Playground</a></h1><h2 class=site-description>깔끔하고 튼튼한 서버 개발과 인프라를 즐기는 박진수입니다~!</h2></div></header><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>About me</span></a></li><li><a href=/categories><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Categories</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><li><a href=https://github.com/umi0410/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg><span>Github</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>다크 모드</span></li></div></ol></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/blog/golang/go-memory-leak-issue/><img src=/blog/golang/go-memory-leak-issue/memory-leak-graph_hu1f014e9e399a42abc11cd4e02aac56df_8940_800x0_resize_box_3.png srcset="/blog/golang/go-memory-leak-issue/memory-leak-graph_hu1f014e9e399a42abc11cd4e02aac56df_8940_800x0_resize_box_3.png 800w, /blog/golang/go-memory-leak-issue/memory-leak-graph_hu1f014e9e399a42abc11cd4e02aac56df_8940_1600x0_resize_box_3.png 1600w" width=800 height=423 loading=lazy alt="Featured image of post 개발 썰 - Go Memory Leak(메모리 누수) 관련 이슈"></a></div><div class=article-details><header class=article-category><a href=/categories/golang/>Golang (Go 언어)</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/blog/golang/go-memory-leak-issue/>개발 썰 - Go Memory Leak(메모리 누수) 관련 이슈</a></h2><h3 class=article-subtitle>Go로 이미지 프로세싱 서버를 만들면서 Memory Leak 이슈를 맞이했고
그 이슈를 해결하기 위해 했던 삽질과 그 결과에 대한 썰을 적어보았습니다.</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Jan 27, 2021</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>5 분 정도</time></div></footer></div></header><section class=article-content><h2 id=시작하며>시작하며</h2><blockquote><p>이 글은 Go 1.15 버전을 바탕으로 개발하며 겪은 이슈에 대해 설명하고 있으며 Go 1.16에서는 해당 이슈가 개선될 것이라고 합니다.</p></blockquote><p><img src=/blog/golang/go-memory-leak-issue/memory-leak-graph.png width=478 height=253 srcset="/blog/golang/go-memory-leak-issue/memory-leak-graph_hu1f014e9e399a42abc11cd4e02aac56df_8940_480x0_resize_box_3.png 480w, /blog/golang/go-memory-leak-issue/memory-leak-graph_hu1f014e9e399a42abc11cd4e02aac56df_8940_1024x0_resize_box_3.png 1024w" loading=lazy alt=memory-leak-graph.png class=gallery-image data-flex-grow=188 data-flex-basis=453px></p><p>진행 중인 <a class=link href="https://github.com/search?q=topic%3Akhumu+org%3Akhu-dev+fork%3Atrue" target=_blank rel=noopener>쿠뮤</a>라는 프로젝트에서 Go를 이용해 이미지에 대한 url 해싱, 리사이징, 섬네일, 센터 크롭 작업을 하는 이미지 프로세싱 마이크로서비스를 개발하고있었다. 1차적으로 어느 정도 개발이 끝난 뒤 벤치마크 겸 부하 테스트 겸해서 얼마나 해당 마이크로서비스가 잘 버티면서 작업을 수행하는지 확인해보려 했으나 <strong>Memory가 한 번 치솟게되면 어느 정도 이하로 떨어지지 않는 이슈</strong>가 발견되었다.</p><p>허용할 수 있는 양보다 많은 요청을 보낼 경우 애플리케이션 레벨 이전에서 요청을 차단해주지 않으면 애플리케이션 단에서는 터지거나 문제가 생기는 것은 당연하겠지만 사진처럼 <strong>작업을 다 수행한 뒤에도 메모리가 제대로 해제되지 않는 것이 이슈</strong>였다.</p><h2 id=이슈의-원인을-파헤치기-위해-했던-노력들>이슈의 원인을 파헤치기 위해 했던 노력들&mldr;</h2><p>이 이슈를 잡아보려 여러 가지 디버깅 작업을 해봤으나 계속해서 메모리 이슈가 발생했고, 각종 커뮤니티에서 도움을 구해보고자했다. Go 오픈 카톡방, Reddit, Slack 등에서 의견을 구해보았다. 재미있는 경험이었으며 덕분에 원인을 파악할 수 있던 것 같다.</p><p><img src=/blog/golang/go-memory-leak-issue/slack-thread.png width=848 height=1150 srcset="/blog/golang/go-memory-leak-issue/slack-thread_hu69f0526f70cab8af73be7fa93df29141_179801_480x0_resize_box_3.png 480w, /blog/golang/go-memory-leak-issue/slack-thread_hu69f0526f70cab8af73be7fa93df29141_179801_1024x0_resize_box_3.png 1024w" loading=lazy alt=slack-thread.png class=gallery-image data-flex-grow=73 data-flex-basis=176px></p><p><img src=/blog/golang/go-memory-leak-issue/reddit.png width=765 height=846 srcset="/blog/golang/go-memory-leak-issue/reddit_hu42e416b3ff1d468e25261abe6aea76a6_136808_480x0_resize_box_3.png 480w, /blog/golang/go-memory-leak-issue/reddit_hu42e416b3ff1d468e25261abe6aea76a6_136808_1024x0_resize_box_3.png 1024w" loading=lazy alt=reddit.png class=gallery-image data-flex-grow=90 data-flex-basis=217px></p><h2 id=어떤-상황에-memory-leak이-발생한-것일까>어떤 상황에 Memory Leak이 발생한 것일까?</h2><p>그럼 자세히 어떤 이슈가 있었고, 어떻게 그 상황을 분석할 수 있었으며 어떻게 해결할 수 있을지 알아보도록하겠다.</p><p><strong>tl;dr - 자세한 묘사보다는 그냥 딱 원인/결과만 궁금하신 분들을 위한 요약</strong></p><ul><li>원인 - 힙 메모리에 메모리를 할당받았는데 혹시 <strong>재사용할 수도 있어 OS에게 바로 메모리를 반환하지 않음</strong>.</li><li>결과 - <strong>OS가 메모리 부족하니 달라고 하면 그때 힙 메모리 사이즈를 실제로 줄인다</strong>. (<em>하지만 go 1.16 버전부터는 개선될 예정이다.</em>)</li><li>정확히 이러한 것을 메모리 누수라고 하는지는 명확하지 않다. Go 런타임이 놀고 있는 메모리를 갖고는 있지만 언제든 OS에게 반환해줄 수는 있기 때문이다. (<em>하지만 매끄럽게 OS에게 반환해주는 느낌은 아니긴했다.</em>)</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nx>routine</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>routine</span> <span class=p>&lt;</span> <span class=mi>10</span><span class=p>;</span> <span class=nx>routine</span> <span class=o>++</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>DoFloat</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// dummy waiting..
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>time</span><span class=p>.</span><span class=nf>Sleep</span><span class=p>(</span><span class=mi>3</span><span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>DoFloat</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>tmp</span> <span class=p>[</span><span class=mi>400000000</span><span class=p>]</span><span class=kt>float64</span>
</span></span><span class=line><span class=cl>    <span class=nx>tmp</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=p>=</span> <span class=mi>0</span> <span class=c1>// tmp에 접근하지 않으면 unused variable이 되기 때문에 dummy한 access 작업 수행
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div><p>처음엔 이미지 리사이징 시 메모리가 제대로 해제되지않는 것을 보고 이슈를 발견했지만, 사람들에게 도움을 구하고자 할 때, 이슈에 대해 설명할 때 전체 프로그램 코드를 첨부할 수는 없었기에 <strong>문제 상황을 간단하게 표현할 수 있는 코드를 짜보고자</strong>했다. 이리 저리 프로그램을 간소화하면서 <strong>커다란 배열 생성시에도 같은 메모리 이슈</strong>가 발생한다는 것을 알게되었다.</p><p>그래서 아주 간단한 배열 생성 예시를 통해 사람들에게 이 이슈에 대해 설명해보고자했다. 이 예시에서는 <code>8바이트의 float6</code>4로 이루어진 <code>400000000칸의 배열 tmp</code>를 선언한다.</p><p><img src=/blog/golang/go-memory-leak-issue/unit-conversion.png width=569 height=167 srcset="/blog/golang/go-memory-leak-issue/unit-conversion_hufbecc09a52a79e4f645bd7e3e96526f8_8388_480x0_resize_box_3.png 480w, /blog/golang/go-memory-leak-issue/unit-conversion_hufbecc09a52a79e4f645bd7e3e96526f8_8388_1024x0_resize_box_3.png 1024w" loading=lazy alt=unit-conversion.png class=gallery-image data-flex-grow=340 data-flex-basis=817px></p><p>8바이트가 400000000칸이면 <code>400000000 * 8 / 1024(KB) / 1024(MB) / 1024(GB) = 약 2.9GB</code> 혹은 그대로 1000단위 씩으로 나눠 <code>3.2GB</code>을 할당하는 것이다.</p><p>원래는 스택 메모리에 할당된 뒤 다른 곳에서 이 녀석을 참조하는 일이 없기 때문에 바로 release되어 스택 메모리에서 점유가 해제되어야한다. 하지만 몇몇 경우에 스택이 아닌 힙에 데이터가 저장될 수 있다고 하는데, 이 경우에는 너무 큰 값을 선언하여 스택이 아닌 힙에 데이터가 저장되었고, 힙이 할당받은 메모리를 해제해주지 않아 생기는 문제였다. 사실 이런 현상도 정확히 메모리 누수 혹은 Memory Leak라고 하는지는 잘 모르겠다. 왜냐하면 <strong>메모리에서 해제할 수 없는 수준으로 그 값의 주소를 잃어버려 실제로 그 공간이 누수가 되는 것이 아니라 아직 딱히 OS가 부담을 느끼지 않기 때문에 Go Runtime의 Heap에서 해당 주소는 비워뒀지만 OS에게 반납은 안 한 상태</strong>인 것이기 때문이다.</p><p><img src=/blog/golang/go-memory-leak-issue/top-memory-leak.png width=1011 height=168 srcset="/blog/golang/go-memory-leak-issue/top-memory-leak_hu95afae50a0e35fe52fc1dc07fc2fa740_148991_480x0_resize_box_3.png 480w, /blog/golang/go-memory-leak-issue/top-memory-leak_hu95afae50a0e35fe52fc1dc07fc2fa740_148991_1024x0_resize_box_3.png 1024w" loading=lazy alt=top-memory-leak.png class=gallery-image data-flex-grow=601 data-flex-basis=1444px></p><p>실행해보면 10번의 DoFloat() 후에 그냥 for loop에서 time.Sleep 중이기에 <strong>CPU를 거의 사용하지 않고 있는 반면 내 Laptop의 16GB의 Memory 중 20.5%인 3.2GB를 사용 중</strong>인 것을 확인할 수 있었다.</p><h2 id=해결-해보기>해결 해보기</h2><h3 id=go-runtime은-os에게-더-이상-이-메모리가-필요하지-않다고-알려주기만-하지-그-memory를-실제로-회수할-지-말지는-os에게-달려있다>Go runtime은 OS에게 더 이상 이 메모리가 필요하지 않다고 알려주기만 하지 그 Memory를 실제로 회수할 지 말지는 OS에게 달려있다.</h3><blockquote><p>The Go runtime only advises the OS when it no longer needs memory and it is up to the OS to reclaim it - @justinisrael</p></blockquote><p>내가 Reddit에서 사람들께 여쭤봤던 글에 담긴 한 댓글을 인용해보았다. 과연 저 말이 사실일까? 프로세스를 여러번 띄워보았다.</p><p><img src=/blog/golang/go-memory-leak-issue/top-multiple-process.png width=766 height=180 srcset="/blog/golang/go-memory-leak-issue/top-multiple-process_hufe31e37f113f3799dd881c2f2d7ba7ae_38707_480x0_resize_box_3.png 480w, /blog/golang/go-memory-leak-issue/top-multiple-process_hufe31e37f113f3799dd881c2f2d7ba7ae_38707_1024x0_resize_box_3.png 1024w" loading=lazy alt=top-multiple-process.png class=gallery-image data-flex-grow=425 data-flex-basis=1021px></p><p>프로세스를 하나 띄웠을 때에는 아까는 Dummy waiting 중이면서도 <strong>Memory를 20% 가까이 점유하고 있었는데 여러 프로세스를 띄우면서 메모리가 부족해지자 놀고있던 Heap memory를 반환하여 거의 약 0.6%의 메모리만 점유</strong> 중인 것을 볼 수 있다.</p><p>마지막 프로세스는 아직 DoFloat() 작업을 진행 중이므로 여전히 19.8%의 메모리를 점유 중이고, 작업이 완료된 뒤에도 OS가 Reclaim(다시 메모리를 가져가는 것)하기 전까지는 약 20%대를 유지하는 것으로 보여졌다.</p><p>하지만 좀 더 자세히 기록해보고싶었다. Go의 내장 패키지 <code>runtime</code>의 Memory 관련 기능을 이용하면 될 것 같았다. <code>runtime.ReadMemStats(*runtime.MemStats)</code>를 이용하면 런타임 도중 자신의 런타임 상황을 알아볼 수 있다. 자세한 사용법은 구글링을 통해 쉽게 얻을 수 있으니 지면 관계상 생략한다.</p><p><img src=/blog/golang/go-memory-leak-issue/runtime-memory-leak.png width=387 height=231 srcset="/blog/golang/go-memory-leak-issue/runtime-memory-leak_hub8c90c70b0c23dfa44a0b6e91e7a7e33_13785_480x0_resize_box_3.png 480w, /blog/golang/go-memory-leak-issue/runtime-memory-leak_hub8c90c70b0c23dfa44a0b6e91e7a7e33_13785_1024x0_resize_box_3.png 1024w" loading=lazy alt=runtime-memory-leak.png class=gallery-image data-flex-grow=167 data-flex-basis=402px></p><p>즉 힙 메모리가 확보간 공간은 거대한 배열을 생성하는 함수인 DoFloat을 진행하는 동안은 실제로 Allocate 할당하여 사용하는 반면 DoFloat을 모두 마친 뒤에는 <strong>힙 메모리는 공간을 확보하고는 있지만 Idle(놀고 있는) 상태로 존재</strong>하는 것이었다.</p><p>나는 이러한 경우를 처음 맞이했지만, <strong>각종 가비지 컬렉터가 있는 언어에서 각각의 가비지 컬렉터나 런타임을 구현하는 방법에 따라 이런 식으로 힙 메모리를 재사용하는 경우를 대비해 한 번 할당받은 메모리를 완전히 OS에게 반환하지 않는 경우가 있다</strong>고 한다.</p><h3 id=go-116-버전부터는-메모리-계산-방식이-바뀔-것이다-그래서-괜찮을-것이다>Go 1.16 버전부터는 메모리 계산 방식이 바뀔 것이다. (그래서 괜찮을 것이다.)</h3><blockquote><p>&ldquo;There was a change to how memory is calculated on 1.16&rdquo; - @gopj</p></blockquote><p>과연 사실일지 확인해보자. 간단히 Docker를 통해 나의 Local 환경에서 별 다른 세팅 없이 Go 버전을 다르게 하여 실행할 수 있었다. 실제로 이 이슈를 커뮤니티에 제기하기 전에도 Docker를 이용해 1.2, 1.3, 1.4 등의 버전에서도 실행해보았다. 나의 랩탑은 1.5 버전을 사용 중이었다. 1.16 버전은 아직 rc는 Release Candidate의 줄임말로 보통 배포 후보 버전을 의미한다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-docker data-lang=docker><span class=line><span class=cl><span class=c># Dockerfile</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> golang:1.16-rc</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> main.go main.go<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENTRYPOINT</span> <span class=p>[</span><span class=s2>&#34;go&#34;</span><span class=p>]</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>CMD</span> <span class=p>[</span><span class=s2>&#34;run&#34;</span><span class=p>,</span> <span class=s2>&#34;./main.go&#34;</span><span class=p>]</span><span class=err>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 이미지 빌드 후 컨테이너 실행</span>
</span></span><span class=line><span class=cl>$ docker build . -t tmp <span class=o>&amp;&amp;</span> docker run --rm --it tmp
</span></span></code></pre></div><p><img src=/blog/golang/go-memory-leak-issue/go-1.16-memory-not-leaking.png width=759 height=63 srcset="/blog/golang/go-memory-leak-issue/go-1.16-memory-not-leaking_hue8ad343e4b80c73af1daf2aadf5c34cb_12663_480x0_resize_box_3.png 480w, /blog/golang/go-memory-leak-issue/go-1.16-memory-not-leaking_hue8ad343e4b80c73af1daf2aadf5c34cb_12663_1024x0_resize_box_3.png 1024w" loading=lazy alt=go-1.16-memory-not-leaking.png class=gallery-image data-flex-grow=1204 data-flex-basis=2891px></p><p><code>1.16-rc</code> 버전을 사용하자 결과적으로 다른 메모리 부하가 심한 프로세스를 실행시키지 않았지만 <strong>수십 초 이내에 사용하지 않는 힙 메모리가 OS에게 반환</strong>되었다!!!</p><blockquote><p>하지만 여전히 runtime.MemStats에서는 HeapMemory에 Idle한 메모리 크기가 크게 잡혀있었는데, 이 부분은 rc 버전이기 때문에 runtime까지 완전히 기능이 개발되지 않아서인지 이전에도 메모리는 반환했지만 메모리를 표시하기 위한 계산의 문제만 개선이 된 것인지는 확실하진 않지만 여튼 이슈에 대해서는 파악할 수 있었다!</p></blockquote><h2 id=마치며>마치며</h2><p>개발이나 운영을 하면서 이런 저런 이슈들이 있었지만 이번 경우처럼 로우 레벨스럽게 들어가서 런타임 동안 메모리 관리가 어떻게 되는지까지 탐구해본 적은 드물었던 것 같다. 도저히 원인을 모르겠어서 &lsquo;<em>하 결국 포기하고 이 마이크로서비스는 Lambda로 돌려야하나&mldr;</em>&rsquo; 싶었다. 하지만 몇 시간을 고생하고 직접 의견을 구하러 다니면서 새로 배우게 된 내용도 많았고, 외국에 계신 몇몇 개발자 분들과도 이렇게 소통할 수 있다는 것이 신기했다. (<em>그리고 참 세세한 지식까지 겸비한 분들이 많다는 것이 놀라웠다&mldr;</em>)</p><p>결과적으로 해당 이슈는 아마 Go의 <code>1.16</code> 버전이 패치되면 완전히 해결 가능할 것 같고 그 이전에도 사실 Host에서 메모리 부담을 느끼면 Go runtime이 안 쓰고 있는 힙 메모리를 반환해준다고 하니 큰 문제는 없을 것 같다. 하지만 실제로 Host가 부담을 느끼는 선 이전에 메모리를 반환받고 싶다면 Pod level에서 메모리 리소스를 제한해볼 수는 있을 것 같다.</p><p>혹시 다음에도 이런 흔치 않은 고된 이슈를 맞이한다면 그 원인과 해법을 이렇게 또 기록할 수 있기를 바래본다.</p></section><footer class=article-footer><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>관련 글</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/blog/golang/how-to-backend-in-go-errorhandle/><div class=article-image><img src=/blog/golang/how-to-backend-in-go-errorhandle/chain.84f4fd17f71f3709899bfce8b3896864_hua96618047d845851ee10ee4de25bc827_61443_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post Golang으로 백엔드 개발하기 - 5. Error Handling. 에러 잘 처리하기 (feat. fiber)" data-hash="md5-hPT9F/cfNwmJm/zos4loZA=="></div><div class=article-details><h2 class=article-title>Golang으로 백엔드 개발하기 - 5. Error Handling. 에러 잘 처리하기 (feat. fiber)</h2></div></a></article><article class=has-image><a href=/blog/golang/how-to-backend-in-go-middleware/><div class=article-image><img src=/blog/golang/how-to-backend-in-go-middleware/log.a24b8a94710056cf81eeda03f1c3deee_hu6da6c55463c6a62988b186d685cd2c7c_23812_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post Golang으로 백엔드 개발하기 - 4. Custom Middleware(미들웨어) 작성해보기 (feat. fiber)" data-hash="md5-okuKlHEAVs+B7toD8cPe7g=="></div><div class=article-details><h2 class=article-title>Golang으로 백엔드 개발하기 - 4. Custom Middleware(미들웨어) 작성해보기 (feat. fiber)</h2></div></a></article><article class=has-image><a href=/blog/golang/how-to-backend-in-go-webapp/><div class=article-image><img src=/blog/golang/how-to-backend-in-go-webapp/output.8af8bebb21fe028ac92f562189cb643b_hu537a11d34916ac1c2def7909b69ddbc5_22456_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post Golang으로 백엔드 개발하기 - 3. 웹 애플리케이션 개발해보기 (feat. fiber)" data-hash="md5-ivi+uyH+AorJL1YhictkOw=="></div><div class=article-details><h2 class=article-title>Golang으로 백엔드 개발하기 - 3. 웹 애플리케이션 개발해보기 (feat. fiber)</h2></div></a></article><article class=has-image><a href=/blog/golang/how-to-backend-in-go-testcode/><div class=article-image><img src=/blog/golang/how-to-backend-in-go-testcode/test-with-ide.e83038fd0ad61ce8e85069ab96d89062_hu7b61495424919d2e1c8d663236a41b57_159980_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post Golang으로 백엔드 개발하기 - 2. 테스트 코드 작성 및 Go에서 Mocking 이용하기 (gomock, testify 이용)" data-hash="md5-6DA4/QrWHOjoUGmrltiQYg=="></div><div class=article-details><h2 class=article-title>Golang으로 백엔드 개발하기 - 2. 테스트 코드 작성 및 Go에서 Mocking 이용하기 (gomock, testify 이용)</h2></div></a></article><article class=has-image><a href=/blog/golang/how-to-backend-in-go-db/><div class=article-image><img src=/blog/golang/how-to-backend-in-go-db/o2m-relation.73e7e39c70cfc03dd37c4e76a3c340b4_huda98d5d877ff5063fa9c786910881686_21160_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post Golang으로 백엔드 개발하기 - 1. 데이터베이스 작업하기 (Ent 프레임워크 이용)" data-hash="md5-c+fjnHDPwD3TfE52o8NAtA=="></div><div class=article-details><h2 class=article-title>Golang으로 백엔드 개발하기 - 1. 데이터베이스 작업하기 (Ent 프레임워크 이용)</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//umi0410.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2022 Jinsu Playground</section><section class=powerby><a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a>로 만듦<br><a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a>의 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.13.0>Stack</a></b> 테마 사용 중</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>