<!doctype html><html lang=ko-kr>
<head><meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="`데브옵스` 인턴으로 근무한 지가 벌써 두 달이 되어갑니다. 이것 저것 배운 것이 많았던 시간이었는데, 그 중 꽤나 삽질을 했던 `Kubernetes` 와 `ELB`를 이용하는 부분에 대해 정리를 해볼까합니다. `jenkins`, `spinnaker`, `argo`, `terraform`, `ansible`, `github action`, ... 등등 다양한 내용을 경험할 수 있던 시간이었지만, 그 중 kubernetes에서 무슨 작업을 하던 빼놓을 수 없으면서 어딘가 깔끔히 그 흐름이 정리된 곳을 보기 힘들었던 **service를 ELB에 연결**하기에 대한 내용을 정리해보겠습니다.
*본 포스트는 EKS를 통해 K8s를 이용할 때를 기준으로 설명합니다.*
"><title>EKS K8s에서 ELB(ALB, NLB) 제대로 설정하며 사용하기</title>
<link rel=canonical href=https://umi0410.github.io/blog/aws/aws_eks_elb/>
<link rel=stylesheet href=/scss/style.min.css><meta property="og:title" content="EKS K8s에서 ELB(ALB, NLB) 제대로 설정하며 사용하기">
<meta property="og:description" content="`데브옵스` 인턴으로 근무한 지가 벌써 두 달이 되어갑니다. 이것 저것 배운 것이 많았던 시간이었는데, 그 중 꽤나 삽질을 했던 `Kubernetes` 와 `ELB`를 이용하는 부분에 대해 정리를 해볼까합니다. `jenkins`, `spinnaker`, `argo`, `terraform`, `ansible`, `github action`, ... 등등 다양한 내용을 경험할 수 있던 시간이었지만, 그 중 kubernetes에서 무슨 작업을 하던 빼놓을 수 없으면서 어딘가 깔끔히 그 흐름이 정리된 곳을 보기 힘들었던 **service를 ELB에 연결**하기에 대한 내용을 정리해보겠습니다.
*본 포스트는 EKS를 통해 K8s를 이용할 때를 기준으로 설명합니다.*
">
<meta property="og:url" content="https://umi0410.github.io/blog/aws/aws_eks_elb/">
<meta property="og:site_name" content="Jinsu Playground">
<meta property="og:type" content="article"><meta property="article:section" content="Blog"><meta property="article:published_time" content="2020-09-06T19:11:07+09:00"><meta property="article:modified_time" content="2020-09-06T19:11:07+09:00"><meta property="og:image" content="https://umi0410.github.io/blog/aws/aws_eks_elb/preview.png">
<meta name=twitter:title content="EKS K8s에서 ELB(ALB, NLB) 제대로 설정하며 사용하기">
<meta name=twitter:description content="`데브옵스` 인턴으로 근무한 지가 벌써 두 달이 되어갑니다. 이것 저것 배운 것이 많았던 시간이었는데, 그 중 꽤나 삽질을 했던 `Kubernetes` 와 `ELB`를 이용하는 부분에 대해 정리를 해볼까합니다. `jenkins`, `spinnaker`, `argo`, `terraform`, `ansible`, `github action`, ... 등등 다양한 내용을 경험할 수 있던 시간이었지만, 그 중 kubernetes에서 무슨 작업을 하던 빼놓을 수 없으면서 어딘가 깔끔히 그 흐름이 정리된 곳을 보기 힘들었던 **service를 ELB에 연결**하기에 대한 내용을 정리해보겠습니다.
*본 포스트는 EKS를 통해 K8s를 이용할 때를 기준으로 설명합니다.*
"><meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://umi0410.github.io/blog/aws/aws_eks_elb/preview.png">
<link rel="shortcut icon" href=https://emojipedia-us.s3.dualstack.us-west-1.amazonaws.com/thumbs/120/google/241/whale_1f40b.png>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-177403492-1','auto'),ga('send','pageview'))</script>
<link rel=preconnect href=https://fonts.googleapis.com>
<link rel=preconnect href=https://fonts.gstatic.com crossorigin>
<link href="https://fonts.googleapis.com/css2?family=East+Sea+Dokdo&family=Noto+Sans+KR:wght@400&display=swap" rel=stylesheet>
<style>@import 'https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css';:root{--body-background:#fafeff;--base-font-family:Pretendard, 'Noto Sans KR', sans-serif}.site-name{--site-name-font-family:'East Sea Dokdo', cursive;font-family:var(--site-name-font-family);font-size:3.2rem!important}.left-sidebar{--sidebar-avatar-size:200px}figure.site-avatar{margin-left:auto!important;margin-right:auto!important}</style>
</head>
<body class="article-page has-toc">
<script>(function(){const a='StackColorScheme';localStorage.getItem(a)||localStorage.setItem(a,"auto")})()</script><script>(function(){const b='StackColorScheme',a=localStorage.getItem(b),c=window.matchMedia('(prefers-color-scheme: dark)').matches===!0;a=='dark'||a==='auto'&&c?document.documentElement.dataset.scheme='dark':document.documentElement.dataset.scheme='light'})()</script>
<div class="container main-container flex
extended">
<div id=article-toolbar>
<a href=https://umi0410.github.io class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg>
<span>Back</span>
</a>
</div>
<main class="main full-width">
<article class="has-image main-article">
<header class=article-header>
<div class=article-image>
<a href=/blog/aws/aws_eks_elb/>
<img src=/blog/aws/aws_eks_elb/preview_huc38b74e19f60c2848e88837c4c6920fa_1709468_800x0_resize_box_3.png srcset="/blog/aws/aws_eks_elb/preview_huc38b74e19f60c2848e88837c4c6920fa_1709468_800x0_resize_box_3.png 800w, /blog/aws/aws_eks_elb/preview_huc38b74e19f60c2848e88837c4c6920fa_1709468_1600x0_resize_box_3.png 1600w" width=800 height=432 loading=lazy alt="Featured image of post EKS K8s에서 ELB(ALB, NLB) 제대로 설정하며 사용하기">
</a>
</div>
<div class=article-details>
<header class=article-category>
<a href=/categories/aws/>
AWS
</a>
</header>
<h2 class=article-title>
<a href=/blog/aws/aws_eks_elb/>EKS K8s에서 ELB(ALB, NLB) 제대로 설정하며 사용하기</a>
</h2>
<h3 class=article-subtitle>
`데브옵스` 인턴으로 근무한 지가 벌써 두 달이 되어갑니다. 이것 저것 배운 것이 많았던 시간이었는데, 그 중 꽤나 삽질을 했던 `Kubernetes` 와 `ELB`를 이용하는 부분에 대해 정리를 해볼까합니다. `jenkins`, `spinnaker`, `argo`, `terraform`, `ansible`, `github action`, ... 등등 다양한 내용을 경험할 수 있던 시간이었지만, 그 중 kubernetes에서 무슨 작업을 하던 빼놓을 수 없으면서 어딘가 깔끔히 그 흐름이 정리된 곳을 보기 힘들었던 **service를 ELB에 연결**하기에 대한 내용을 정리해보겠습니다.
*본 포스트는 EKS를 통해 K8s를 이용할 때를 기준으로 설명합니다.*
</h3>
<footer class=article-time><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--published>Sep 06, 2020</time>
</footer></div>
</header>
<section class=article-content>
<h2 id=-시작하며>🐶 시작하며</h2>
<blockquote>
<p>본 게시글은 AWS 대학생 유저그룹인 <a class=link href=https://velog.io/@ausg target=_blank rel=noopener>AUSG</a>의 활동 중
하나로서 본인(박진수)이 작성한 게시물을 포워딩한 것입니다.</p>
</blockquote>
<p><figure style=flex-grow:185;flex-basis:444px>
<a href=/blog/aws/aws_eks_elb/preview.png data-size=2032x1097><img src=/blog/aws/aws_eks_elb/preview.png srcset="/blog/aws/aws_eks_elb/preview_huc38b74e19f60c2848e88837c4c6920fa_1709468_480x0_resize_box_3.png 480w, /blog/aws/aws_eks_elb/preview_huc38b74e19f60c2848e88837c4c6920fa_1709468_1024x0_resize_box_3.png 1024w" width=2032 height=1097 loading=lazy alt=preview.png>
</a>
<figcaption>preview.png</figcaption>
</figure></p>
<p><code>데브옵스</code> 인턴으로 근무한 지가 벌써 두 달이 되어갑니다. 이것 저것 배운 것이 많았던 시간이었는데, 그 중 꽤나 삽질을 했던 <code>Kubernetes</code> 와 <code>ELB</code>를 이용하는 부분에 대해 정리를 해볼까합니다. <code>jenkins</code>, <code>spinnaker</code>, <code>argo</code>, <code>terraform</code>, <code>ansible</code>, <code>github action</code>, &mldr; 등등 다양한 내용을 경험할 수 있던 시간이었지만, 그 중 kubernetes에서 무슨 작업을 하던 빼놓을 수 없으면서 어딘가 깔끔히 그 흐름이 정리된 곳을 보기 힘들었던 <strong>service를 ELB에 연결</strong>하기에 대한 내용을 정리해보겠습니다.</p>
<p><em>본 포스트는 EKS를 통해 K8s를 이용할 때를 기준으로 설명합니다.</em></p>
<h2 id=-eks-에서-elb를-사용해-서비스를-노출킬-때-유의사항들>💁🏻‍♂️ EKS 에서 ELB를 사용해 서비스를 노출킬 때 유의사항들</h2>
<blockquote>
<p>🧐 : " <code>ELB</code>, <code>NLB</code>, <code>ALB</code> 대체 뭐가 다른 거야..?ㅜㅜ <strong>쿠버네티스</strong>를 쓸 때는 어떻게 얘네를 지정하는 거지..? <code>kubectl expose deploy {{deployment_name}} --type=LoadBalancer</code> 하면 그냥 작동은 하던데&mldr;"</p>
</blockquote>
<p><code>EKS</code>에서 주로 사용하는 <code>ELB</code>는 L4의 <code>NLB</code>와 L7의 <code>ALB</code> 입니다. ALB가 L7에 대한 좀 더 다양한 설정이 가능하기 때문에 조건이 많기도 하고, AWS의 ALB만을 위한 <code>alb-ingress-controller</code>라는 녀석이 직접 <code>Ingress</code>의 설정들을 관리해주기 때문에 설정할 수 있는 옵션도 많습니다. 좋게 보면 많은 설정을 할 수 있고, 나쁘게 보면 초보자에겐 귀찮을 수 있습니다. <code>NLB</code>는 비교적 설정이 적고 따라서 설정해줄 수 있는 항목도 적습니다.</p>
<p>쿠버네티스에서 다양한 작업을 하면서 다양한 controller을 접하게 되고, 그렇게 될 수록 <code>annotation</code>으로 많은 설정을 하게 됩니다. k8s를 처음 접할 때에는 annotation에 대한 정의로서 아래와 같은 문장을 접할 수 있고, 마치 기능과 크게 상관이 없을 것처럼 느껴지기도 하지만 사실 EKS를 비롯한 여러 서비스에서는 annotation을 이용해 중요한 설정 등을 기입할 수 있기 때문에 잘 설정해주어야합니다. ELB또한 모든 설정이 annotation으로 동작한다.</p>
<blockquote>
<p>" <code>Label</code>을 사용하여 오브젝트를 선택하고, 특정 조건을 만족하는 오브젝트 컬렉션을 찾을 수 있다. 반면에, <code>annotation</code>은 오브젝트를 식별하고 선택하는데 사용되지 않는다. 어노테이션의 메타데이터는 작거나 크고, 구조적이거나 구조적이지 않을 수 있으며, 레이블에서 허용되지 않는 문자를 포함할 수 있다."</p>
</blockquote>
<h3 id=-alb를-사용할-때-유의할-점>⚠️ ALB를 사용할 때 유의할 점</h3>
<blockquote>
<p>어떤 옵션들이 있고, 기본적으로는 어떻게 설정되는 지에 대한 이해가 있어야 오류 과정을 추적하기 쉬우므로 기본적으로 ALB를 AWS Console에서 사용해본 뒤에 설정할 것을 추천합니다.</p>
</blockquote>
<ul>
<li><code>alb ingress controller</code>가 생성할 ALB가 사용할 서브넷을 discover하기 위해서는 <strong>올바른 태그가 달린 subnet</strong>이 존재해야한다.</li>
<li>node 혹은 <code>alb ingress controller</code>에 연결된 service account가 alb를 제어하기 위한 <strong>iam permission</strong>이 부여되어야한다.</li>
<li>internet facing한 alb를 만들지 internal한 alb를 만들지 고민해봐야한다.</li>
<li><code>alb ingress controller</code>의 log를 통해 작업에 대한 log를 볼 수 있다.</li>
</ul>
<h3 id=-nlb-clb를-사용할-때-유의할-점>⚠️ NLB, CLB를 사용할 때 유의할 점</h3>
<p><a class=link href=https://kubernetes.io/ko/docs/concepts/services-networking/service/#aws-nlb-support target=_blank rel=noopener>https://kubernetes.io/ko/docs/concepts/services-networking/service/#aws-nlb-support</a></p>
<p><a class=link href=https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/load-balancing.html target=_blank rel=noopener>https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/load-balancing.html</a></p>
<ul>
<li><code>NLB</code>, <code>CLB</code>가 사용할 서브넷을 설정하기 위해서는 <strong>올바른 태그가 달린 subnet</strong>이 존재해야한다.</li>
<li>어느 부분에선가 NLB, CLB를 제어하기 위한 <strong>iam permission</strong>이 부여되어야한다. (어느 부분인지 확실히는 모르겠음. 따로 설정안해도 동작하는 것을 보아 worker node가 갖는 iam role에 permission이 붙어있을 것으로 예상됨)</li>
</ul>
<h2 id=-alb를-사용해-서비스를-노출시키는-방법>🌎 ALB를 사용해 서비스를 노출시키는 방법</h2>
<blockquote>
<p>😊 <code>ALB</code>는 K8s에 친숙하지 않으신 분들께는 다소 진입장벽이 있을 수 있습니다. 그냥 서비스를 노출시킬 때는 굳이 사용할 필요 없는 <code>Ingress</code> 라는 오브젝트도 관리해야하고, <code>alb-ingress-contoller</code>라는 녀석도 배포해야하며 설정이 다양하기 때문이죠! 💦</p>
</blockquote>
<p>K8s에서 EKS를 사용해 <code>ALB</code>를 이용하고싶은 경우 <code>alb-ingress-controller</code>을 배포한 뒤, <code>Ingress</code>를 통해 사용할 alb에 대한 rule을 설정을 해주어야합니다.</p>
<p><a class=link href=https://kubernetes-sigs.github.io/aws-alb-ingress-controller/guide/controller/setup/ target=_blank rel=noopener>https://kubernetes-sigs.github.io/aws-alb-ingress-controller/guide/controller/setup/</a> 의 내용을 버릴 부분이 하나도 없습니다. 위 링크를 통해 alb-ingress-controller에 대한 개념을 잡고 배포해봅니다. <code>alb-ingress-controller.yaml</code>의 인자를 적절히 수정해주어야합니다.</p>
<p>ALB가 아닌 k8s cluster 상에서 L7 LoadBalancer를 이용하는 경우에는 nginx ingress controller등을 이용하며 nginx 에 적용할 rule을 <code>Ingress</code>라는 K8s Object를 통해 설정합니다. ingress controller의 설정에서 자신의 class name을 적어주고, <code>Ingress</code>에서는 어떤 class name의 ingress controller에서 자신(Ingress이자 Rule)을 적용하도록 할 지를 annotation을 통해 설정하거나 ingressClassName이라는 필드를 통해 설정합니다.(ingress 설정에 대한 참고 - <a class=link href=https://kubernetes.io/ko/docs/concepts/services-networking/ingress/#%EC%9D%B8%EA%B7%B8%EB%A0%88%EC%8A%A4-%ED%81%B4%EB%9E%98%EC%8A%A4 target=_blank rel=noopener>https://kubernetes.io/ko/docs/concepts/services-networking/ingress/#인그레스-클래스</a>)</p>
<p>이와 같은 경우에는 ingress controller가 직접 ingress에 명시된 rule을 이용했지만, <strong>alb-ingress-controller</strong>의 경우는 alb-ingress-controller가 nginx-ingress-controller처럼 <strong>직접 웹서버의 역할을 하는 것이 아닌</strong>, ingress에 명시된 rule을 이용하는 <strong>ALB를 생성하고 관리</strong>하는 역할을 한다는 것입니다. 이 부분이 처음에는 다소 헷갈리게 느껴질 수 있기에 길게 서술해보았습니다.</p>
<p>실제로 ingress를 생성한 뒤 앞에서 배포한 alb-ingress-controller의 log를 보면 alb를 관리하기위한 여러 작업을 수행중인 모습을 볼 수 있습니다.</p>
<p>그럼 이제 실제로 alb ingress controller을 통해 alb를 이용해보겠습니다.</p>
<h3 id=alb를-원활히-제어하기-위한-permission-부여>ALB를 원활히 제어하기 위한 permission 부여</h3>
<ul>
<li>ALB iam 정책 참고
<ul>
<li><a class=link href=https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/alb-ingress.html target=_blank rel=noopener>https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/alb-ingress.html</a></li>
<li><a class=link href=https://raw.githubusercontent.com/kubernetes-sigs/aws-alb-ingress-controller/v1.1.2/docs/examples/iam-policy.json target=_blank rel=noopener>https://raw.githubusercontent.com/kubernetes-sigs/aws-alb-ingress-controller/v1.1.2/docs/examples/iam-policy.json</a></li>
</ul>
</li>
</ul>
<p><code>ALB</code>를 제어하기 위해서는 aws의 리소스에 대한 어떠한 permission이 필요합니다. <code>node</code>에 부여할 수도 있고, IAM User에 부여한 뒤 <code>alb ingress controller</code>의 설정에서 해당 IAM User의 Key를 부여할 수도 있고, Service account와 IAM Role을 <code>OIDC</code>(OpenID Connect를 이용해 Service account와 IAM Role을 연결시키는 작업)를 이용해 엮은 뒤, alb ingress controller pod에 해당 Service Account를 부여할 수도 있지만 뒤의 방법들은 좀 튜토리얼치고 투머치한 감이 있기때문에, 간단히 node에 Permission을 부여하도록하겠습니다.</p>
<p><figure style=flex-grow:149;flex-basis:359px>
<a href=/blog/aws/aws_eks_elb/iam.png data-size=797x532><img src=/blog/aws/aws_eks_elb/iam.png srcset="/blog/aws/aws_eks_elb/iam_hu9ac6964ec6844f4165a3f6a7be3b3a23_55018_480x0_resize_box_3.png 480w, /blog/aws/aws_eks_elb/iam_hu9ac6964ec6844f4165a3f6a7be3b3a23_55018_1024x0_resize_box_3.png 1024w" width=797 height=532 loading=lazy alt=iam.png>
</a>
<figcaption>iam.png</figcaption>
</figure></p>
<p>worker node들이 이용하는 IAM Role에 Policy를 추가한 모습.</p>
<h3 id=alb가-사용할-subnet에-적절한-태그-달기>alb가 사용할 subnet에 적절한 태그 달기</h3>
<p><a class=link href=https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/alb-ingress.html target=_blank rel=noopener>https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/alb-ingress.html</a> 에 나와있듯이 ELB가 이용하는 서브넷을 자동으로 설정되도록 하기 위해서는 사용하고자 하는 서브넷에 아래와 같은 태그들을 달아주어야한다.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>cluster</span><span class=o>/</span><span class=p>&lt;</span><span class=nt>cluster</span><span class=err>-</span><span class=na>name</span><span class=p>&gt;</span> <span class=o>=</span> <span class=nx>shared</span> <span class=o>|</span> <span class=nx>owned</span> <span class=err>#</span> <span class=nx>Required</span>
<span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>role</span><span class=o>/</span><span class=nx>internal</span><span class=o>-</span><span class=nx>elb</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>|</span> <span class=s2>&#34;&#34;</span> <span class=err>#</span> <span class=nx>Optional</span><span class=p>,</span> <span class=k>for</span> <span class=nx>internal</span> <span class=nx>alb</span>
<span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>role</span><span class=o>/</span><span class=nx>elb</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>|</span> <span class=s2>&#34;&#34;</span> <span class=err>#</span> <span class=nx>Optional</span><span class=p>,</span> <span class=k>for</span> <span class=nx>internet</span><span class=o>-</span><span class=nx>facing</span> <span class=nx>alb</span>
</code></pre></div><p><code>a | b</code>와 같은 표현은 a 나 b중 한 값을 가져야한다는 의미로 표현한 것입니다.</p>
<p><figure style=flex-grow:164;flex-basis:393px>
<a href=/blog/aws/aws_eks_elb/tag.png data-size=714x435><img src=/blog/aws/aws_eks_elb/tag.png srcset="/blog/aws/aws_eks_elb/tag_hu2bbb23500c440a1ae11b9e8cf9268536_37002_480x0_resize_box_3.png 480w, /blog/aws/aws_eks_elb/tag_hu2bbb23500c440a1ae11b9e8cf9268536_37002_1024x0_resize_box_3.png 1024w" width=714 height=435 loading=lazy alt=tag.png>
</a>
<figcaption>tag.png</figcaption>
</figure></p>
<p>internet facing ALB만 이용할 것이기 때문에 <a class=link href=http://kubernetes.io/role/internal-elb target=_blank rel=noopener><code>kubernetes.io/role/internal-elb</code></a> tag는 생략하고 태그를 달아준 모습.</p>
<p>subnet에 ALB를 사용하기 위한 태그를 제대로 달아주지 않을 경우 alb-ingress-controller 에서 아래와 같은 로그를 보게 됩니다. ALB가 생성되지도 않습니다.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=nx>controller</span><span class=p>.</span><span class=nx>go</span><span class=o>:</span><span class=mi>217</span><span class=p>]</span> <span class=nx>kubebuilder</span><span class=o>/</span><span class=nx>controller</span> <span class=s2>&#34;msg&#34;</span><span class=o>=</span><span class=s2>&#34;Reconciler error&#34;</span> <span class=s2>&#34;error&#34;</span><span class=o>=</span><span class=err>&#34;</span><span class=nx>failed</span> <span class=nx>to</span> <span class=nx>build</span> <span class=nx>LoadBalancer</span> <span class=nx>configuration</span> <span class=nx>due</span> <span class=nx>to</span> <span class=nx>failed</span> <span class=nx>to</span> <span class=nx>resolve</span> <span class=mi>2</span> <span class=nx>qualified</span> <span class=nx>subnet</span> <span class=k>for</span> <span class=nx>ALB</span><span class=p>.</span> <span class=nx>Subnets</span> <span class=nx>must</span> <span class=nx>contains</span> <span class=nx>these</span> <span class=nx>tags</span><span class=o>:</span> <span class=s1>&#39;kubernetes.io/cluster/umi-dev&#39;</span><span class=o>:</span> <span class=p>[</span><span class=s1>&#39;shared&#39;</span> <span class=nx>or</span> <span class=s1>&#39;owned&#39;</span><span class=p>]</span> <span class=nx>and</span> <span class=s1>&#39;kubernetes.io/role/internal-elb&#39;</span><span class=o>:</span> <span class=p>[</span><span class=s1>&#39;&#39;</span> <span class=nx>or</span> <span class=s1>&#39;1&#39;</span><span class=p>]</span>
</code></pre></div><h3 id=alb-ingress-controller-배포하기>alb ingress controller 배포하기.</h3>
<blockquote>
<p>슬슬 읽기 귀찮아질 타이밍입니다. &lsquo;<em>요놈이 IAM policy도 만들고, 서브넷에 엄한 태그를 달더니 이제는 하,,, 뭘 또 배포하라고 하는구나 아이고 내 눈아,,,</em>&rsquo; 싶겠지만, 좀 더 힘을 내어봅시다 🍻</p>
</blockquote>
<p><a class=link href=https://kubernetes-sigs.github.io/aws-alb-ingress-controller/guide/controller/setup/ target=_blank rel=noopener>https://kubernetes-sigs.github.io/aws-alb-ingress-controller/guide/controller/setup/</a> 를 참고하여 <code>Deployment</code> 내의 container의 <code>args</code>를 자신의 상황에 맞게 수정한 뒤 배포해줍니다.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=p>...</span>
  <span class=nx>args</span><span class=o>:</span>
    <span class=o>-</span> <span class=o>--</span><span class=nx>ingress</span><span class=o>-</span><span class=kr>class</span><span class=o>=</span><span class=nx>alb</span> <span class=err>#</span> <span class=nx>ingress의</span> <span class=nx>annotation에</span> <span class=nx>명시할</span> <span class=kr>class</span> <span class=nx>name</span>
    <span class=o>-</span> <span class=o>--</span><span class=nx>cluster</span><span class=o>-</span><span class=nx>name</span><span class=o>=</span><span class=nx>umi</span><span class=o>-</span><span class=nx>dev</span> <span class=err>#</span> <span class=nx>eks</span> <span class=nx>cluster</span> <span class=nx>name</span>
    <span class=o>-</span> <span class=o>--</span><span class=nx>aws</span><span class=o>-</span><span class=nx>region</span><span class=o>=</span><span class=nx>ap</span><span class=o>-</span><span class=nx>northeast</span><span class=o>-</span><span class=mi>2</span>
    <span class=o>-</span> <span class=o>--</span><span class=nx>aws</span><span class=o>-</span><span class=nx>api</span><span class=o>-</span><span class=nx>debug</span><span class=o>=</span><span class=kc>true</span>
</code></pre></div><p>저는 위와 같은 식으로 설정해주었고, 잘 배포되었는지 확인해봅니다.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=nx>$</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>po</span> <span class=o>-</span><span class=nx>A</span> <span class=o>|</span> <span class=nx>grep</span> <span class=nx>alb</span>
<span class=nx>kube</span><span class=o>-</span><span class=nx>system</span>   <span class=nx>alb</span><span class=o>-</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span><span class=o>-</span><span class=mi>594</span><span class=nx>f84b465</span><span class=o>-</span><span class=nx>q4qjb</span>   <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Running</span>   <span class=mi>0</span>          <span class=mi>106</span><span class=nx>m</span>
</code></pre></div><h3 id=노출시킬-서비스-배포하기>노출시킬 서비스 배포하기</h3>
<p>간단하게 <code>Nginx</code>를 배포해보록하겠습니다.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=nx>apiVersion</span><span class=o>:</span> <span class=nx>v1</span>
<span class=nx>kind</span><span class=o>:</span> <span class=nx>Service</span>
<span class=nx>metadata</span><span class=o>:</span>
  <span class=nx>name</span><span class=o>:</span> <span class=nx>ingress</span><span class=o>-</span><span class=nx>test</span>
<span class=nx>spec</span><span class=o>:</span>
  <span class=nx>selector</span><span class=o>:</span>
    <span class=nx>app</span><span class=o>:</span> <span class=nx>nginx</span>
  <span class=nx>ports</span><span class=o>:</span>
    <span class=o>-</span> <span class=nx>protocol</span><span class=o>:</span> <span class=nx>TCP</span>
      <span class=nx>port</span><span class=o>:</span> <span class=mi>80</span>
      <span class=nx>targetPort</span><span class=o>:</span> <span class=mi>80</span>
      <span class=nx>nodePort</span><span class=o>:</span> <span class=mi>30010</span>
  <span class=nx>type</span><span class=o>:</span> <span class=nx>NodePort</span>

<span class=o>---</span>
<span class=nx>apiVersion</span><span class=o>:</span> <span class=nx>apps</span><span class=o>/</span><span class=nx>v1</span>
<span class=nx>kind</span><span class=o>:</span> <span class=nx>Deployment</span>
<span class=nx>metadata</span><span class=o>:</span>
  <span class=nx>name</span><span class=o>:</span> <span class=nx>ingress</span><span class=o>-</span><span class=nx>test</span>
  <span class=nx>labels</span><span class=o>:</span>
    <span class=nx>app</span><span class=o>:</span> <span class=nx>nginx</span>
<span class=nx>spec</span><span class=o>:</span>
  <span class=nx>replicas</span><span class=o>:</span> <span class=mi>3</span>
  <span class=nx>selector</span><span class=o>:</span>
    <span class=nx>matchLabels</span><span class=o>:</span>
      <span class=nx>app</span><span class=o>:</span> <span class=nx>nginx</span>
  <span class=nx>template</span><span class=o>:</span>
    <span class=nx>metadata</span><span class=o>:</span>
      <span class=nx>labels</span><span class=o>:</span>
        <span class=nx>app</span><span class=o>:</span> <span class=nx>nginx</span>
    <span class=nx>spec</span><span class=o>:</span>
      <span class=nx>containers</span><span class=o>:</span>
      <span class=o>-</span> <span class=nx>name</span><span class=o>:</span> <span class=nx>nginx</span>
        <span class=nx>image</span><span class=o>:</span> <span class=nx>nginx</span>
        <span class=nx>ports</span><span class=o>:</span>
        <span class=o>-</span> <span class=nx>containerPort</span><span class=o>:</span> <span class=mi>80</span>
</code></pre></div><p>ALB는 기본적으로 <strong>node의 Port</strong>를 AWS 상의 <code>target group</code>으로서 이용하기 때문에, ingress를 통해 노출시켜줄 서비스는 적어도 <code>NodePort</code> 타입으로 노출되어있어야 <code>ALB ingress controller</code>가 해당 서비스를 노출시킬 수 있습니다.(target type을 기본값인 <code>instance</code>가 아니라 <code>IP</code>로 설정하면, Pod의 IP로 트래픽이 흘러가게 할 수는 있습니다.)</p>
<p>작동방식을 설명해보자면 ingress 는 service name과 service port를 설정으로 받습니다. alb-ingress-controller는 그러면 해당 service name, service port와 연결된 NodePort를 찾아서 ALB의 target group으로 등록시킵니다.</p>
<h3 id=ingress-배포하기>Ingress 배포하기</h3>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=nx>apiVersion</span><span class=o>:</span> <span class=nx>extensions</span><span class=o>/</span><span class=nx>v1beta1</span>
<span class=nx>kind</span><span class=o>:</span> <span class=nx>Ingress</span>
<span class=nx>metadata</span><span class=o>:</span>
  <span class=nx>name</span><span class=o>:</span> <span class=s2>&#34;ingress&#34;</span>
  <span class=nx>annotations</span><span class=o>:</span>
    <span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>ingress</span><span class=p>.</span><span class=kr>class</span><span class=o>:</span> <span class=nx>alb</span> <span class=err>#</span> <span class=nx>the</span> <span class=nx>value</span> <span class=nx>we</span> <span class=nx>set</span> <span class=k>in</span> <span class=nx>alb</span><span class=o>-</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span>
    <span class=nx>alb</span><span class=p>.</span><span class=nx>ingress</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>scheme</span><span class=o>:</span> <span class=nx>internet</span><span class=o>-</span><span class=nx>facing</span>
<span class=nx>spec</span><span class=o>:</span>
  <span class=nx>rules</span><span class=o>:</span>
    <span class=o>-</span> <span class=nx>http</span><span class=o>:</span>
        <span class=nx>paths</span><span class=o>:</span>
          <span class=o>-</span> <span class=nx>path</span><span class=o>:</span> <span class=err>/*</span>
            <span class=nx>backend</span><span class=o>:</span>
              <span class=nx>serviceName</span><span class=o>:</span> <span class=s2>&#34;ingress-test&#34;</span>
              <span class=nx>servicePort</span><span class=o>:</span> <span class=mi>80</span>
</code></pre></div><p><a class=link href=https://kubernetes-sigs.github.io/aws-alb-ingress-controller/guide/ingress/annotation/ target=_blank rel=noopener>https://kubernetes-sigs.github.io/aws-alb-ingress-controller/guide/ingress/annotation/</a> 을 참고하여 <code>Ingress</code>를 작성해줍니다. <code>[kubernetes.io/ingress.class</code>는](<a class=link href=http://kubernetes.io/ingress.class target=_blank rel=noopener>http://kubernetes.io/ingress.class</a>는) alb-ingress-controller에서 설정한 <code>ingress.class</code>를 적어주고, <a class=link href=http://alb.ingress.kubernetes.io/scheme%eb%8a%94 target=_blank rel=noopener><code>alb.ingress.kubernetes.io/scheme</code>는</a> 용도에 따라 <code>internet-facing</code> 혹은 <code>internal</code>을 적어줍니다. ingress 를 생성하기 전에 <code>kubectl logs -f {alb-ingress-controller pod name}</code>을 한 창에 띄워놓으면 ALB 생성 관련 로그를 쭈루룩 볼 수 있습니다.</p>
<p><figure style=flex-grow:403;flex-basis:968px>
<a href=/blog/aws/aws_eks_elb/elb.png data-size=670x166><img src=/blog/aws/aws_eks_elb/elb.png srcset="/blog/aws/aws_eks_elb/elb_huae6e8bb776e806d0d619a890a5bf58a9_19454_480x0_resize_box_3.png 480w, /blog/aws/aws_eks_elb/elb_huae6e8bb776e806d0d619a890a5bf58a9_19454_1024x0_resize_box_3.png 1024w" width=670 height=166 loading=lazy alt=elb.png>
</a>
<figcaption>elb.png</figcaption>
</figure></p>
<p>잘 설정되었다면 위와 같이 ALB가 생성될 것 입니다.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=nx>$</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>ingress</span>
<span class=nx>NAME</span>      <span class=nx>HOSTS</span>   <span class=nx>ADDRESS</span>                                                                     <span class=nx>PORTS</span>   <span class=nx>AGE</span>
<span class=nx>ingress</span>   <span class=o>*</span>       <span class=nx>bf1e76be</span><span class=o>-</span><span class=k>default</span><span class=o>-</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>e8c7</span><span class=o>-</span><span class=mf>1351183883.</span><span class=nx>ap</span><span class=o>-</span><span class=nx>northeast</span><span class=o>-</span><span class=mf>2.</span><span class=nx>elb</span><span class=p>.</span><span class=nx>amazonaws</span><span class=p>.</span><span class=nx>com</span>   <span class=mi>80</span>      <span class=mi>30</span><span class=nx>s</span>
</code></pre></div><h3 id=인증서-설정을-통해-https-까지>인증서 설정을 통해 HTTPS 까지?!</h3>
<blockquote>
<p>❤️ AWS <code>Certificate Manager</code>와 <code>Ingress</code>에 대한 <code>annotation</code>을 이용해 간단하게 <code>HTTPS</code>를 이용할 수도 있습니다! 직접하려면 도메인 소유 인증과 인증서, 비밀키 등을 모두 관리해야했는데 말이지요! 🐥</p>
</blockquote>
<p><figure style=flex-grow:341;flex-basis:819px>
<a href=/blog/aws/aws_eks_elb/cert.png data-size=1082x317><img src=/blog/aws/aws_eks_elb/cert.png srcset="/blog/aws/aws_eks_elb/cert_hu285e592bed94d8c711caab941a928b85_40319_480x0_resize_box_3.png 480w, /blog/aws/aws_eks_elb/cert_hu285e592bed94d8c711caab941a928b85_40319_1024x0_resize_box_3.png 1024w" width=1082 height=317 loading=lazy alt=cert.png>
</a>
<figcaption>cert.png</figcaption>
</figure></p>
<p>이런식으로 AWS의 <code>Certificate Manager</code>을 통해 발급받은 인증서가 있다면 이를 alb 에서 ingress에 annotation을 설정함으로써 사용할 수 있습니다.</p>
<p><strong>Ingress의 annotation에 HTTPS및 인증서 관련 설정 추가해주기</strong></p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=nx>apiVersion</span><span class=o>:</span> <span class=nx>extensions</span><span class=o>/</span><span class=nx>v1beta1</span>
<span class=nx>kind</span><span class=o>:</span> <span class=nx>Ingress</span>
<span class=nx>metadata</span><span class=o>:</span>
  <span class=nx>name</span><span class=o>:</span> <span class=s2>&#34;ingress&#34;</span>
  <span class=nx>annotations</span><span class=o>:</span>
    <span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>ingress</span><span class=p>.</span><span class=kr>class</span><span class=o>:</span> <span class=nx>alb</span>
    <span class=nx>alb</span><span class=p>.</span><span class=nx>ingress</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>scheme</span><span class=o>:</span> <span class=nx>internet</span><span class=o>-</span><span class=nx>facing</span>
    <span class=nx>alb</span><span class=p>.</span><span class=nx>ingress</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>listen</span><span class=o>-</span><span class=nx>ports</span><span class=o>:</span> <span class=s1>&#39;[{&#34;HTTP&#34;: 80}, {&#34;HTTPS&#34;: 443}]&#39;</span>
    <span class=nx>alb</span><span class=p>.</span><span class=nx>ingress</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>actions</span><span class=p>.</span><span class=nx>redirect</span><span class=o>-</span><span class=nx>to</span><span class=o>-</span><span class=nx>https</span><span class=o>:</span> <span class=o>&gt;</span>
      <span class=p>{</span><span class=s2>&#34;Type&#34;</span><span class=o>:</span><span class=s2>&#34;redirect&#34;</span><span class=p>,</span><span class=s2>&#34;RedirectConfig&#34;</span><span class=o>:</span><span class=p>{</span><span class=s2>&#34;Port&#34;</span><span class=o>:</span><span class=s2>&#34;443&#34;</span><span class=p>,</span><span class=s2>&#34;Protocol&#34;</span><span class=o>:</span><span class=s2>&#34;HTTPS&#34;</span><span class=p>,</span><span class=s2>&#34;StatusCode&#34;</span><span class=o>:</span><span class=s2>&#34;HTTP_302&#34;</span><span class=p>}}</span>
    <span class=nx>alb</span><span class=p>.</span><span class=nx>ingress</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>certificate</span><span class=o>-</span><span class=nx>arn</span><span class=o>:</span> <span class=p>{</span><span class=nx>Certificate</span> <span class=nx>Manger의</span> <span class=nx>인증서</span> <span class=nx>arn</span><span class=p>}</span>
<span class=p>...</span>
</code></pre></div><p><em>http redirect 및 actions에 대한 내용은 저의 애교입니다.</em> 궁금하신 분들은 한 번 적용해보시거나 알아보시면 어렵지 않게 알아내실 수 있을 겁니다! 😆</p>
<p><strong>Route53에 ALB 추가해주기</strong></p>
<p>EKS에서 ALB를 사용하는 등의 작업을 하시는 분은 어느 정도 aws에 대한 이해가 있으리라 생각하고, ALB를 Route53을 통해 레코드로 추가하는 작업에 대한 설명은 생략하겠습니다.</p>
<p><figure style=flex-grow:283;flex-basis:679px>
<a href=/blog/aws/aws_eks_elb/cert2.png data-size=1714x605><img src=/blog/aws/aws_eks_elb/cert2.png srcset="/blog/aws/aws_eks_elb/cert2_huff1102cf41f5fc11c3e61b957cd43eab_183400_480x0_resize_box_3.png 480w, /blog/aws/aws_eks_elb/cert2_huff1102cf41f5fc11c3e61b957cd43eab_183400_1024x0_resize_box_3.png 1024w" width=1714 height=605 loading=lazy alt=cert2.png>
</a>
<figcaption>cert2.png</figcaption>
</figure></p>
<p>alb-ingress-controller로 AWS Certificate Manager의 인증서까지 사용한 모습.</p>
<h2 id=-nlb를-사용해-서비스를-노출시키는-방법>🌎 NLB를 사용해 서비스를 노출시키는 방법</h2>
<p>CLB는 Deprecate 대상이라고 들었기도 하고, 굳이 써본 적이 없어 NLB로만 설명합니다. NLB는 ALB에 비해 사용이 간단합니다.</p>
<p>Ingress와 alb-ingress-controller를 사용했던 ALB와 달리 NLB는 서비스를 직접 노출시킵니다. 주로 <code>Nginx Ingress Controller</code>을 NLB에 연결해서 사용했던 기억이 납니다. NLB는 L4 LB로, Nginx를 주로 L7 LB로 사용하는 경우 이렇게 NLB를 사용합니다. ALB와 Nginx 모두 L7 LB로서 역할을 하기때문에 굳이 ALB를 사용할 필요가 없는 경우가 많았습니다.</p>
<p>NLB를 통해 서비스를 노출시키기 위해선 annotaion중에서도 [<code>service.beta.kubernetes.io](http://service.beta.kubernetes.io/)...</code>형태의 annotation을 이용합니다. 사실 실제로 실무해서 사용해본 annotation은 거의 [<code>service.beta.kubernetes.io/aws-load-balancer-type:](http://service.beta.kubernetes.io/aws-load-balancer-type:) "nlb"</code> 뿐입니다. (이를 사용하지 않을 경우 디폴트가 CLB이기 때문에&mldr;)</p>
<h3 id=nlb가-사용할-subnet에-적절한-태그-달기>NLB가 사용할 subnet에 적절한 태그 달기</h3>
<p>ALB를 사용했을 때와 마찬가지로 NLB가 사용할 서브넷에 필수 태그를 달아줍니다. 기억이 안난 다면 글의 상단 ALB 파트를 참고!</p>
<h3 id=nlb로-노출할-서비스-생성하기>NLB로 노출할 서비스 생성하기</h3>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=nx>apiVersion</span><span class=o>:</span> <span class=nx>v1</span>
<span class=nx>kind</span><span class=o>:</span> <span class=nx>Service</span>
<span class=nx>metadata</span><span class=o>:</span>
  <span class=nx>name</span><span class=o>:</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>nlb</span>
  <span class=nx>annotations</span><span class=o>:</span>
    <span class=nx>service</span><span class=p>.</span><span class=nx>beta</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>aws</span><span class=o>-</span><span class=nx>load</span><span class=o>-</span><span class=nx>balancer</span><span class=o>-</span><span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;nlb&#34;</span>
<span class=nx>spec</span><span class=o>:</span>
  <span class=nx>selector</span><span class=o>:</span>
    <span class=nx>app</span><span class=o>:</span> <span class=nx>nginx</span>
  <span class=nx>ports</span><span class=o>:</span>
    <span class=o>-</span> <span class=nx>protocol</span><span class=o>:</span> <span class=nx>TCP</span>
      <span class=nx>port</span><span class=o>:</span> <span class=mi>80</span>
      <span class=nx>targetPort</span><span class=o>:</span> <span class=mi>80</span>
      <span class=nx>nodePort</span><span class=o>:</span> <span class=mi>30011</span>
  <span class=nx>type</span><span class=o>:</span> <span class=nx>LoadBalancer</span>
</code></pre></div><p><figure style=flex-grow:440;flex-basis:1057px>
<a href=/blog/aws/aws_eks_elb/terminal.png data-size=983x223><img src=/blog/aws/aws_eks_elb/terminal.png srcset="/blog/aws/aws_eks_elb/terminal_hua70a78035179ff73439578821520f3f3_51627_480x0_resize_box_3.png 480w, /blog/aws/aws_eks_elb/terminal_hua70a78035179ff73439578821520f3f3_51627_1024x0_resize_box_3.png 1024w" width=983 height=223 loading=lazy alt=terminal.png>
</a>
<figcaption>terminal.png</figcaption>
</figure></p>
<p><figure style=flex-grow:105;flex-basis:252px>
<a href=/blog/aws/aws_eks_elb/zzal.png data-size=420x400><img src=/blog/aws/aws_eks_elb/zzal.png srcset="/blog/aws/aws_eks_elb/zzal_hu70382f8ad38785a4d7f8dffcaf07bdc6_351117_480x0_resize_box_3.png 480w, /blog/aws/aws_eks_elb/zzal_hu70382f8ad38785a4d7f8dffcaf07bdc6_351117_1024x0_resize_box_3.png 1024w" width=420 height=400 loading=lazy alt=zzal.png>
</a>
<figcaption>zzal.png</figcaption>
</figure></p>
<p>간단히 type을 LoadBalancer로 바꾸어주고, annotation에 어떤 ELB를 사용할지( NLB/CLB )만 적어주면 아래 그림처럼 손쉽게 NLB로 서비스를 노출 시킬 수 있습니다.</p>
<h3 id=인증서-설정을-통해-https까지>인증서 설정을 통해 HTTPS까지?!</h3>
<blockquote>
<p>🌋: &ldquo;그만&mldr;. 아무도 안 궁금해&mldr;&rdquo; - 하지만 마지막까지 힘을 내서 EKS에서의 ELB를 정복해봅시다!</p>
</blockquote>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=nx>apiVersion</span><span class=o>:</span> <span class=nx>v1</span>
<span class=nx>kind</span><span class=o>:</span> <span class=nx>Service</span>
<span class=nx>metadata</span><span class=o>:</span>
  <span class=nx>name</span><span class=o>:</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>nlb</span>
  <span class=nx>annotations</span><span class=o>:</span>
    <span class=nx>service</span><span class=p>.</span><span class=nx>beta</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>aws</span><span class=o>-</span><span class=nx>load</span><span class=o>-</span><span class=nx>balancer</span><span class=o>-</span><span class=nx>type</span><span class=o>:</span> <span class=s2>&#34;nlb&#34;</span>
    <span class=nx>service</span><span class=p>.</span><span class=nx>beta</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>aws</span><span class=o>-</span><span class=nx>load</span><span class=o>-</span><span class=nx>balancer</span><span class=o>-</span><span class=nx>backend</span><span class=o>-</span><span class=nx>protocol</span><span class=o>:</span> <span class=nx>tcp</span>
    <span class=nx>service</span><span class=p>.</span><span class=nx>beta</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>aws</span><span class=o>-</span><span class=nx>load</span><span class=o>-</span><span class=nx>balancer</span><span class=o>-</span><span class=nx>ssl</span><span class=o>-</span><span class=nx>ports</span><span class=o>:</span> <span class=s2>&#34;443&#34;</span>
    <span class=nx>service</span><span class=p>.</span><span class=nx>beta</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>aws</span><span class=o>-</span><span class=nx>load</span><span class=o>-</span><span class=nx>balancer</span><span class=o>-</span><span class=nx>ssl</span><span class=o>-</span><span class=nx>cert</span><span class=o>:</span> <span class=nx>arn</span><span class=o>:</span><span class=nx>aws</span><span class=o>:</span><span class=nx>acm</span><span class=o>:</span><span class=nx>ap</span><span class=o>-</span><span class=nx>northeast</span><span class=o>-</span><span class=mi>2</span><span class=o>:</span><span class=p>{{</span><span class=nx>root</span><span class=p>}}</span><span class=o>:</span><span class=nx>certificate</span><span class=o>/</span><span class=p>{{</span><span class=nx>arn</span><span class=p>}}</span>

<span class=nx>spec</span><span class=o>:</span>
  <span class=nx>selector</span><span class=o>:</span>
    <span class=nx>app</span><span class=o>:</span> <span class=nx>nginx</span>
  <span class=nx>ports</span><span class=o>:</span>
    <span class=o>-</span> <span class=nx>protocol</span><span class=o>:</span> <span class=nx>TCP</span>
      <span class=nx>port</span><span class=o>:</span> <span class=mi>80</span>
      <span class=nx>targetPort</span><span class=o>:</span> <span class=mi>80</span>
      <span class=nx>nodePort</span><span class=o>:</span> <span class=mi>30011</span>
    <span class=o>-</span> <span class=nx>protocol</span><span class=o>:</span> <span class=nx>TCP</span>
      <span class=nx>port</span><span class=o>:</span> <span class=mi>443</span>
      <span class=nx>targetPort</span><span class=o>:</span> <span class=mi>80</span>
      <span class=nx>nodePort</span><span class=o>:</span> <span class=mi>30012</span>
  <span class=nx>type</span><span class=o>:</span> <span class=nx>LoadBalancer</span>
</code></pre></div><p><code>backend-protocol</code>은 <code>tcp</code>|tls 혹은 https|http로 설정이 돠는 듯합니다. 예를 들어 <code>backend-protocol</code> 로 <code>tcp</code>를 설정한 뒤 <code>ssl-port</code>로 443을 설정, 서비스의 <code>spec</code>에서의 포트로는 <code>80</code>과 <code>443</code>을 설정하면, 자동적으로 <code>80</code>은 <code>tcp</code>, <code>443</code>은 tls를 이용하는 NLB listener로 설정되게 되는데 http,https도 마찬가지로 tcp,tls로 적절히 설정이 됩니다. 다만 http,https를 설정할 경우 <code>X-Forwarded-For</code> 헤더가 삽입된다고 합니다. (정확하지는 않아요&mldr; 딱히 NLB의 backend protocol을 L7으로 설정하는 것이 NLB의 원래 스펙이 아니었던 점도 있고, L7을 이용하고 싶으면, ALB를 이용하는 것이 더 편하다고 생각이 들어서 따로 검증해본 적이 없기 때문에&mldr; )</p>
<p>⚠️<strong>단점</strong>이 하나 있다면 아직 <strong>http⇒https redirect</strong>가 불가능하다는 것인데, 이는 애초에 L4 LB를 이용하는 것과 L7 LB를 이용하는 쓰임에 대한 차이라고 생각을 하기 때문에 감수를 해야할 것 같습니다. 예를 들어 L4 NLB에 L7 nginx-ingress-controller을 연결하여 redirect는 nginx가 담당하도록하는 방식을 많이 이용하는 것 같습니다. NLB에서는 L4 의 뭔가 SSL/TLS한 작업을 하기 위함이고, L7의 https 작업이 주가 되는 것은 아니므로&mldr;? <em>사실 이 부분은 잘 모르겠습니다&mldr;💦💦 잘 아시는 분이 계시다면 알려주시면 감사하겠습니다. ㅜㅜㅜ</em>( NLB에서 HTTP, HTTPS redirect가 안되는 이유 참고 - <a class=link href=https://aws.amazon.com/premiumsupport/knowledge-center/redirect-http-https-elb/ target=_blank rel=noopener>https://aws.amazon.com/premiumsupport/knowledge-center/redirect-http-https-elb/</a> )</p>
<h3 id=-nlb를-통한-https-서버-구축-결과>⭕️ NLB를 통한 HTTPS 서버 구축 결과</h3>
<p>어쨌든 위의 annotation을 통해 올바르게 svc를 설정한다면</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=nx>$</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>svc</span>

<span class=nx>nginx</span><span class=o>-</span><span class=nx>nlb</span>    <span class=nx>LoadBalancer</span>   <span class=mf>10.100.180.174</span>   <span class=nx>ae27784521c4f4bcd96b22f2cca2358b</span><span class=o>-</span><span class=mi>4</span><span class=nx>bffb166fafa47f2</span><span class=p>.</span><span class=nx>elb</span><span class=p>.</span><span class=nx>ap</span><span class=o>-</span><span class=nx>northeast</span><span class=o>-</span><span class=mf>2.</span><span class=nx>amazonaws</span><span class=p>.</span><span class=nx>com</span>   <span class=mi>443</span><span class=o>:</span><span class=mi>30014</span><span class=o>/</span><span class=nx>TCP</span>   <span class=mi>37</span><span class=nx>m</span>
</code></pre></div><ul>
<li>Route53 설정은 추가로 해주어야함. - 예시
<a class=link href=http://nlb.umidev.net target=_blank rel=noopener>nlb.umidev.net</a> - ALIAS ae2778452xxxxxxxxxxxxxx.elb.ap-northeast-2.amazonaws.com</li>
</ul>
<p>이렇게 service가 생성될 것이고, (service의 port로서 사용할 80,443 등은 service.spec에서 명시) 생성 후 <code>A Record Alias</code>로서 NLB의 <code>DNS</code> name을 넣어주면 사진과 같이 <code>HTTPS</code> 접속이 가능합니다!</p>
<p><figure style=flex-grow:274;flex-basis:658px>
<a href=/blog/aws/aws_eks_elb/cert3.png data-size=1660x605><img src=/blog/aws/aws_eks_elb/cert3.png srcset="/blog/aws/aws_eks_elb/cert3_hu4f6093134f3fc61777b52e640067d7a7_152079_480x0_resize_box_3.png 480w, /blog/aws/aws_eks_elb/cert3_hu4f6093134f3fc61777b52e640067d7a7_152079_1024x0_resize_box_3.png 1024w" width=1660 height=605 loading=lazy alt=cert3.png>
</a>
<figcaption>cert3.png</figcaption>
</figure></p>
<h2 id=-마치며>🐳 마치며</h2>
<p>어차피 한 번의 검색이면 정보를 얻을 수 있는 모든 annotation이나 기타 설정에 대한 내용을 다루기 보단 나름 제가 <strong>실제로 쿠버네티스를 관리하는</strong> <strong>데브옵스 인턴로서 일을 하면서 헷갈렸던 내용</strong>과 <strong>EKS에서의 ELB 관리에 대한 흐름</strong>을 위주로 설명하려 노력했고, 저의 <code>삽질</code>이 깃든 내용들입니다 ㅎㅎㅎ</p>
<p>아는 범위 + 좀 더 조사하여 열심히 정리해보았지만, 부족한 부분이 있을 수도 있고 틀린 부분이 있을 수도 있을텐데, 보완해주실 내용이 있다면 말씀해주시면 열심히 검토해보겠습니다~! 감사합니다.</p>
<h2 id=글쓴이>🧙‍♂️글쓴이</h2>
<ul>
<li><strong>박진수</strong> - 👨‍👩‍👧‍👧<code>AUSG</code> (AWS University Student Group) 3기로 활동 중</li>
<li><strong>관심사</strong>
<ul>
<li><code>Docker</code>, <code>Kubernetes</code> 등의 <strong>컨테이너 기술</strong></li>
<li><code>Argo</code>, <code>Spinnaker</code>, <code>Github action</code> 등의 <strong>CI/CD 툴</strong></li>
<li><code>Terraform</code>, <code>AWS</code>를 통한 <strong>클라우드 인프라 구축</strong></li>
</ul>
</li>
<li><strong>Blog</strong> - <a class=link href=https://senticoding.tistory.com target=_blank rel=noopener>https://senticoding.tistory.com</a></li>
<li><strong>Email</strong> - <a class=link href=mailto:bo314@naver.com>bo314@naver.com</a></li>
</ul>
<h2 id=-참고-references>📚 참고 (References)</h2>
<ul>
<li>EKS의 Required subnet tags
<ul>
<li><a class=link href=https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/load-balancing.html target=_blank rel=noopener>https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/load-balancing.html</a></li>
<li><a class=link href=https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/alb-ingress.html target=_blank rel=noopener>https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/alb-ingress.html</a></li>
</ul>
</li>
<li>Kubernetes Cloud provider aws - <a class=link href=https://kubernetes.io/docs/concepts/cluster-administration/cloud-providers/#aws target=_blank rel=noopener>https://kubernetes.io/docs/concepts/cluster-administration/cloud-providers/#aws</a></li>
<li>ALB ingress controller install - <a class=link href=https://kubernetes-sigs.github.io/aws-alb-ingress-controller/guide/controller/setup/ target=_blank rel=noopener>https://kubernetes-sigs.github.io/aws-alb-ingress-controller/guide/controller/setup/</a></li>
<li>ALB ingress Annotation <a class=link href=https://kubernetes-sigs.github.io/aws-alb-ingress-controller/guide/ingress/annotation/ target=_blank rel=noopener>https://kubernetes-sigs.github.io/aws-alb-ingress-controller/guide/ingress/annotation/</a></li>
<li>NLB의 HTTPS redirect가 불가능한 이유 -<a class=link href=https://aws.amazon.com/premiumsupport/knowledge-center/redirect-http-https-elb/ target=_blank rel=noopener>https://aws.amazon.com/premiumsupport/knowledge-center/redirect-http-https-elb/</a></li>
<li>NLB service Annotations - <a class=link href=https://kubernetes.io/ko/docs/concepts/services-networking/service/#aws-nlb-support target=_blank rel=noopener>https://kubernetes.io/ko/docs/concepts/services-networking/service/#aws-nlb-support</a></li>
<li>Ingress의 class에 대해 - <a class=link href=https://kubernetes.io/ko/docs/concepts/services-networking/ingress/#%EC%9D%B8%EA%B7%B8%EB%A0%88%EC%8A%A4-%ED%81%B4%EB%9E%98%EC%8A%A4 target=_blank rel=noopener>https://kubernetes.io/ko/docs/concepts/services-networking/ingress/#인그레스-클래스</a></li>
</ul>
</section>
<footer class=article-footer>
<section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span>
</section>
</footer>
</article>
<aside class=related-contents--wrapper>
</aside>
<div class=disqus-container>
<div id=disqus_thread></div>
<script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return}var b=document,a=b.createElement('script');a.async=!0,a.src='//umi0410.disqus.com/embed.js',a.setAttribute('data-timestamp',+new Date),(b.head||b.body).appendChild(a)})()</script>
<noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
<a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>
</div>
<style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style>
<script>window.addEventListener('onColorSchemeChange',a=>{DISQUS&&DISQUS.reset({reload:!0})})</script>
<footer class=site-footer>
<section class=copyright>
&copy;
2020 -
2022 Jinsu Playground
</section>
<section class=powerby>
<a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a>로 만듦 <br>
<a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a>의 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=2.4.0>Stack</a></b> 테마 사용 중
</section>
</footer>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous>
</main>
<aside class="sidebar right-sidebar sticky">
<section class="widget archives">
<div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
</div>
<h2 class="widget-title section-title">Table of contents</h2>
<div class=widget--toc>
<nav id=TableOfContents>
<ol>
<li><a href=#-시작하며>🐶 시작하며</a></li>
<li><a href=#-eks-에서-elb를-사용해-서비스를-노출킬-때-유의사항들>💁🏻‍♂️ EKS 에서 ELB를 사용해 서비스를 노출킬 때 유의사항들</a>
<ol>
<li><a href=#-alb를-사용할-때-유의할-점>⚠️ ALB를 사용할 때 유의할 점</a></li>
<li><a href=#-nlb-clb를-사용할-때-유의할-점>⚠️ NLB, CLB를 사용할 때 유의할 점</a></li>
</ol>
</li>
<li><a href=#-alb를-사용해-서비스를-노출시키는-방법>🌎 ALB를 사용해 서비스를 노출시키는 방법</a>
<ol>
<li><a href=#alb를-원활히-제어하기-위한-permission-부여>ALB를 원활히 제어하기 위한 permission 부여</a></li>
<li><a href=#alb가-사용할-subnet에-적절한-태그-달기>alb가 사용할 subnet에 적절한 태그 달기</a></li>
<li><a href=#alb-ingress-controller-배포하기>alb ingress controller 배포하기.</a></li>
<li><a href=#노출시킬-서비스-배포하기>노출시킬 서비스 배포하기</a></li>
<li><a href=#ingress-배포하기>Ingress 배포하기</a></li>
<li><a href=#인증서-설정을-통해-https-까지>인증서 설정을 통해 HTTPS 까지?!</a></li>
</ol>
</li>
<li><a href=#-nlb를-사용해-서비스를-노출시키는-방법>🌎 NLB를 사용해 서비스를 노출시키는 방법</a>
<ol>
<li><a href=#nlb가-사용할-subnet에-적절한-태그-달기>NLB가 사용할 subnet에 적절한 태그 달기</a></li>
<li><a href=#nlb로-노출할-서비스-생성하기>NLB로 노출할 서비스 생성하기</a></li>
<li><a href=#인증서-설정을-통해-https까지>인증서 설정을 통해 HTTPS까지?!</a></li>
<li><a href=#-nlb를-통한-https-서버-구축-결과>⭕️ NLB를 통한 HTTPS 서버 구축 결과</a></li>
</ol>
</li>
<li><a href=#-마치며>🐳 마치며</a></li>
<li><a href=#글쓴이>🧙‍♂️글쓴이</a></li>
<li><a href=#-참고-references>📚 참고 (References)</a></li>
</ol>
</nav>
</div>
</section>
</aside>
</div>
<script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous defer></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const a=document.createElement('link');a.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",a.type="text/css",a.rel="stylesheet",document.head.appendChild(a)})()</script>
</body>
</html>