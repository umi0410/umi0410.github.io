<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.80.0"><meta name=description content="Backend 개발자, DevOps 엔지니어 경희대학교 박진수의 개인 블로그 및 웹 포트폴리오"><meta name=author content="umi0410"><link rel=icon href=https://emojipedia-us.s3.dualstack.us-west-1.amazonaws.com/thumbs/120/google/241/whale_1f40b.png type=image/png><title>EKS K8s에서 ELB(ALB, NLB) 제대로 설정하며 사용하기 :: Jinsu Playground</title><link href=/css/nucleus.css?1612105470 rel=stylesheet><link href=/css/fontawesome-all.min.css?1612105470 rel=stylesheet><link href=/css/hybrid.css?1612105470 rel=stylesheet><link href=/css/featherlight.min.css?1612105470 rel=stylesheet><link href=/css/perfect-scrollbar.min.css?1612105470 rel=stylesheet><link href=/css/auto-complete.css?1612105470 rel=stylesheet><link href=/css/atom-one-dark-reasonable.css?1612105470 rel=stylesheet><link href=/css/theme.css?1612105470 rel=stylesheet><link href=/css/hugo-theme.css?1612105470 rel=stylesheet><link href=/css/theme-umi0410-blue.css?1612105470 rel=stylesheet><link href=/css/custom-umi0410.css?1612105470 rel=stylesheet><script src=/js/jquery-3.3.1.min.js?1612105470></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}:not(pre)>code+span.copy-to-clipboard{display:none}</style></head><body data-url=/blog/aws/aws_eks_elb/><nav id=sidebar><div id=header-wrapper><div id=header><a id=logo href=https://umi0410.github.io><span>Jinsu Playground</span></a></div><div id=profile-wrapper><style>#sidebar-profile-message{text-align:left;word-break:keep-all}#sidebar-profile-message>p{margin-top:0;margin-bottom:0;margin-left:10px;font-size:16px}</style><a href=/><img src=/media/profile.png style=width:170px;margin-top:15px></a><div id=sidebar-profile-message><b>박진수 (umi0410)</b></br><p>Golang, Cloud services, MSA, 컨테이너와 자동화, 깔끔한 아키텍쳐에 관심이 많습니다.</p></div></div></div><div class=highlightable><ul class=topics><li data-nav-id=/portfolio/ title="About Jinsu Park (umi0410)" class=dd-item><a href=/portfolio/>About me</a></li><li data-nav-id=/experiences/ title=Experiences class=dd-item><a href=/experiences/>Experiences</a><ul><li data-nav-id=/experiences/megazone-cloud/ title="메가존 클라우드 데브옵스 인턴 후기" class=dd-item><a href=/experiences/megazone-cloud/><b></b>Megazone Cloud DevOps</a><ul><li data-nav-id=/experiences/megazone-cloud/stargate-infra/ title="Stargate라는 인프라 구축기" class=dd-item><a href=/experiences/megazone-cloud/stargate-infra/><b></b>인프라 구축기</a></li><li data-nav-id=/experiences/megazone-cloud/ci-cd-pipeline/ title="Github Action, Spinnaker을 이용한 CI/CD 파이프라인 구축기" class=dd-item><a href=/experiences/megazone-cloud/ci-cd-pipeline/><b></b>CI/CD 파이프라인</a></li><li data-nav-id=/experiences/megazone-cloud/argo-poc/ title="Argo Project들에 대한 PoC(개념 증명) 진행" class=dd-item><a href=/experiences/megazone-cloud/argo-poc/><b></b>Argo Project PoC</a></li><li data-nav-id=/experiences/megazone-cloud/spaceone-helm/ title="SpaceONE Helm Chart 개발" class=dd-item><a href=/experiences/megazone-cloud/spaceone-helm/><b></b>Helm Chart 개발</a></li><li data-nav-id=/experiences/megazone-cloud/spacectl/ title="SpaceONE CLI Client인 spacectl 설계 및 개발" class=dd-item><a href=/experiences/megazone-cloud/spacectl/><b></b>CLI Client 설계.개발</a></li></ul></li></ul></li><li data-nav-id=/blog/ title=Blog class="dd-item
parent"><a href=/blog/>Blog</a><ul><li data-nav-id=/blog/golang/ title=Go class=dd-item><a href=/blog/golang/>Go</a><ul><li data-nav-id=/blog/golang/go-vs-java-oop/ title="Go vs Java - Go에서의 객체 지향" class=dd-item><a href=/blog/golang/go-vs-java-oop/><b></b>Go vs Java - Go에서의 객체 지향</a></li><li data-nav-id=/blog/golang/go-mutex-semaphore/ title="Go 언어로 적용해보는 Computer Science - Mutex와 Semaphore" class=dd-item><a href=/blog/golang/go-mutex-semaphore/><b></b>Mutex와 Semaphore</a></li><li data-nav-id=/blog/golang/go-deadlock/ title="Go 언어로 적용해보는 Computer Science - Deadlock" class=dd-item><a href=/blog/golang/go-deadlock/><b></b>Deadlock</a></li><li data-nav-id=/blog/golang/go-cpu-cache/ title="Go 언어로 적용해보는 Computer Science - Cache" class=dd-item><a href=/blog/golang/go-cpu-cache/><b></b>Cache</a></li><li data-nav-id=/blog/golang/go-memory-leak-issue/ title="개발 썰 - Go Memory Leak(메모리 누수) 관련 이슈" class=dd-item><a href=/blog/golang/go-memory-leak-issue/><b></b>개발 썰 - Go Memory Leak(메모리 누수) 관련 이슈</a></li><li data-nav-id=/blog/golang/golang-concurrent-pattern-pipeline/ title="Go의 Pipeline pattern. 언제 사용해야할까? - Golang concurrent patterns" class=dd-item><a href=/blog/golang/golang-concurrent-pattern-pipeline/><b></b>Go의 Pipeline pattern. 언제 사용해야할까?</a></li></ul></li><li data-nav-id=/blog/aws/ title=AWS class="dd-item
parent"><a href=/blog/aws/>AWS</a><ul><li data-nav-id=/blog/aws/aws_eks_elb/ title="EKS K8s에서 ELB(ALB, NLB) 제대로 설정하며 사용하기" class="dd-item active"><a href=/blog/aws/aws_eks_elb/>EKS K8s에서 ELB(ALB, NLB) 제대로 설정하며 사용하기</a></li></ul></li></ul></li></ul><section id=shortcuts><h3>More</h3><ul><li><a class=padding href=https://github.com/umi0410><i class="fab fa-github"></i>Github</a></li></ul></section><section id=footer><p>Built with <a href=https://github.com/matcornic/hugo-theme-learn><i class="fas fa-heart"></i></a>from <a href=https://getgrav.org>Grav</a> and <a href=https://gohugo.io/>Hugo</a></p></section></div></nav><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=top-github-link><a class=github-link title="Edit this page" href=https://github.com/umi0410/umi0410.github.io/edit/master/content/blog/aws/aws_eks_elb.md target=blank><i class="fas fa-code-branch"></i><span id=top-github-link-text>Edit this page</span></a></div><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i></a></span><span id=toc-menu><i class="fas fa-list-alt"></i></span><span class=links><a href=/>About Jinsu Park (umi0410)</a> > <a href=/blog/>Blog</a> > <a href=/blog/aws/>AWS</a> > EKS K8s에서 ELB(ALB, NLB) 제대로 설정하며 사용하기</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><a href=#-시작하며>🐶 시작하며</a></li><li><a href=#-eks-에서-elb를-사용해-서비스를-노출킬-때-유의사항들>💁🏻‍♂️ EKS 에서 ELB를 사용해 서비스를 노출킬 때 유의사항들</a><ul><li><a href=#-alb를-사용할-때-유의할-점>⚠️ ALB를 사용할 때 유의할 점</a></li><li><a href=#-nlb-clb를-사용할-때-유의할-점>⚠️ NLB, CLB를 사용할 때 유의할 점</a></li></ul></li><li><a href=#-alb를-사용해-서비스를-노출시키는-방법>🌎 ALB를 사용해 서비스를 노출시키는 방법</a><ul><li><a href=#alb를-원활히-제어하기-위한-permission-부여>ALB를 원활히 제어하기 위한 permission 부여</a></li><li><a href=#alb가-사용할-subnet에-적절한-태그-달기>alb가 사용할 subnet에 적절한 태그 달기</a></li><li><a href=#alb-ingress-controller-배포하기>alb ingress controller 배포하기.</a></li><li><a href=#노출시킬-서비스-배포하기>노출시킬 서비스 배포하기</a></li><li><a href=#ingress-배포하기>Ingress 배포하기</a></li><li><a href=#인증서-설정을-통해-https-까지>인증서 설정을 통해 HTTPS 까지?!</a></li></ul></li><li><a href=#-nlb를-사용해-서비스를-노출시키는-방법>🌎 NLB를 사용해 서비스를 노출시키는 방법</a><ul><li><a href=#nlb가-사용할-subnet에-적절한-태그-달기>NLB가 사용할 subnet에 적절한 태그 달기</a></li><li><a href=#nlb로-노출할-서비스-생성하기>NLB로 노출할 서비스 생성하기</a></li><li><a href=#인증서-설정을-통해-https까지>인증서 설정을 통해 HTTPS까지?!</a></li><li><a href=#-nlb를-통한-https-서버-구축-결과>⭕️ NLB를 통한 HTTPS 서버 구축 결과</a></li></ul></li><li><a href=#-마치며>🐳 마치며</a></li><li><a href=#글쓴이>🧙‍♂️글쓴이</a></li><li><a href=#-참고-references>📚 참고 (References)</a></li></ul></nav></div></div></div></div><div id=head-tags></div><div id=body-inner><h1>EKS K8s에서 ELB(ALB, NLB) 제대로 설정하며 사용하기</h1><h2 id=-시작하며>🐶 시작하며</h2><blockquote><p>본 게시글은 AWS 대학생 유저그룹인 <a href=https://velog.io/@ausg>AUSG</a>의 활동 중
하나로서 본인(박진수)이 작성한 게시물을 포워딩한 것입니다.</p></blockquote><p><img src=preview.png alt=preview.png></p><p><code>데브옵스</code> 인턴으로 근무한 지가 벌써 두 달이 되어갑니다. 이것 저것 배운 것이 많았던 시간이었는데, 그 중 꽤나 삽질을 했던 <code>Kubernetes</code> 와 <code>ELB</code>를 이용하는 부분에 대해 정리를 해볼까합니다. <code>jenkins</code>, <code>spinnaker</code>, <code>argo</code>, <code>terraform</code>, <code>ansible</code>, <code>github action</code>, &mldr; 등등 다양한 내용을 경험할 수 있던 시간이었지만, 그 중 kubernetes에서 무슨 작업을 하던 빼놓을 수 없으면서 어딘가 깔끔히 그 흐름이 정리된 곳을 보기 힘들었던 <strong>service를 ELB에 연결</strong>하기에 대한 내용을 정리해보겠습니다.</p><p><em>본 포스트는 EKS를 통해 K8s를 이용할 때를 기준으로 설명합니다.</em></p><h2 id=-eks-에서-elb를-사용해-서비스를-노출킬-때-유의사항들>💁🏻‍♂️ EKS 에서 ELB를 사용해 서비스를 노출킬 때 유의사항들</h2><blockquote><p>🧐 : " <code>ELB</code>, <code>NLB</code>, <code>ALB</code> 대체 뭐가 다른 거야..?ㅜㅜ <strong>쿠버네티스</strong>를 쓸 때는 어떻게 얘네를 지정하는 거지..? <code>kubectl expose deploy {{deployment_name}} --type=LoadBalancer</code> 하면 그냥 작동은 하던데&mldr;"</p></blockquote><p><code>EKS</code>에서 주로 사용하는 <code>ELB</code>는 L4의 <code>NLB</code>와 L7의 <code>ALB</code> 입니다. ALB가 L7에 대한 좀 더 다양한 설정이 가능하기 때문에 조건이 많기도 하고, AWS의 ALB만을 위한 <code>alb-ingress-controller</code>라는 녀석이 직접 <code>Ingress</code>의 설정들을 관리해주기 때문에 설정할 수 있는 옵션도 많습니다. 좋게 보면 많은 설정을 할 수 있고, 나쁘게 보면 초보자에겐 귀찮을 수 있습니다. <code>NLB</code>는 비교적 설정이 적고 따라서 설정해줄 수 있는 항목도 적습니다.</p><p>쿠버네티스에서 다양한 작업을 하면서 다양한 controller을 접하게 되고, 그렇게 될 수록 <code>annotation</code>으로 많은 설정을 하게 됩니다. k8s를 처음 접할 때에는 annotation에 대한 정의로서 아래와 같은 문장을 접할 수 있고, 마치 기능과 크게 상관이 없을 것처럼 느껴지기도 하지만 사실 EKS를 비롯한 여러 서비스에서는 annotation을 이용해 중요한 설정 등을 기입할 수 있기 때문에 잘 설정해주어야합니다. ELB또한 모든 설정이 annotation으로 동작한다.</p><blockquote><p>" <code>Label</code>을 사용하여 오브젝트를 선택하고, 특정 조건을 만족하는 오브젝트 컬렉션을 찾을 수 있다. 반면에, <code>annotation</code>은 오브젝트를 식별하고 선택하는데 사용되지 않는다. 어노테이션의 메타데이터는 작거나 크고, 구조적이거나 구조적이지 않을 수 있으며, 레이블에서 허용되지 않는 문자를 포함할 수 있다."</p></blockquote><h3 id=-alb를-사용할-때-유의할-점>⚠️ ALB를 사용할 때 유의할 점</h3><blockquote><p>어떤 옵션들이 있고, 기본적으로는 어떻게 설정되는 지에 대한 이해가 있어야 오류 과정을 추적하기 쉬우므로 기본적으로 ALB를 AWS Console에서 사용해본 뒤에 설정할 것을 추천합니다.</p></blockquote><ul><li><code>alb ingress controller</code>가 생성할 ALB가 사용할 서브넷을 discover하기 위해서는 <strong>올바른 태그가 달린 subnet</strong>이 존재해야한다.</li><li>node 혹은 <code>alb ingress controller</code>에 연결된 service account가 alb를 제어하기 위한 <strong>iam permission</strong>이 부여되어야한다.</li><li>internet facing한 alb를 만들지 internal한 alb를 만들지 고민해봐야한다.</li><li><code>alb ingress controller</code>의 log를 통해 작업에 대한 log를 볼 수 있다.</li></ul><h3 id=-nlb-clb를-사용할-때-유의할-점>⚠️ NLB, CLB를 사용할 때 유의할 점</h3><p><a href=https://kubernetes.io/ko/docs/concepts/services-networking/service/#aws-nlb-support>https://kubernetes.io/ko/docs/concepts/services-networking/service/#aws-nlb-support</a></p><p><a href=https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/load-balancing.html>https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/load-balancing.html</a></p><ul><li><code>NLB</code>, <code>CLB</code>가 사용할 서브넷을 설정하기 위해서는 <strong>올바른 태그가 달린 subnet</strong>이 존재해야한다.</li><li>어느 부분에선가 NLB, CLB를 제어하기 위한 <strong>iam permission</strong>이 부여되어야한다. (어느 부분인지 확실히는 모르겠음. 따로 설정안해도 동작하는 것을 보아 worker node가 갖는 iam role에 permission이 붙어있을 것으로 예상됨)</li></ul><h2 id=-alb를-사용해-서비스를-노출시키는-방법>🌎 ALB를 사용해 서비스를 노출시키는 방법</h2><blockquote><p>😊 <code>ALB</code>는 K8s에 친숙하지 않으신 분들께는 다소 진입장벽이 있을 수 있습니다. 그냥 서비스를 노출시킬 때는 굳이 사용할 필요 없는 <code>Ingress</code> 라는 오브젝트도 관리해야하고, <code>alb-ingress-contoller</code>라는 녀석도 배포해야하며 설정이 다양하기 때문이죠! 💦</p></blockquote><p>K8s에서 EKS를 사용해 <code>ALB</code>를 이용하고싶은 경우 <code>alb-ingress-controller</code>을 배포한 뒤, <code>Ingress</code>를 통해 사용할 alb에 대한 rule을 설정을 해주어야합니다.</p><p><a href=https://kubernetes-sigs.github.io/aws-alb-ingress-controller/guide/controller/setup/>https://kubernetes-sigs.github.io/aws-alb-ingress-controller/guide/controller/setup/</a> 의 내용을 버릴 부분이 하나도 없습니다. 위 링크를 통해 alb-ingress-controller에 대한 개념을 잡고 배포해봅니다. <code>alb-ingress-controller.yaml</code>의 인자를 적절히 수정해주어야합니다.</p><p>ALB가 아닌 k8s cluster 상에서 L7 LoadBalancer를 이용하는 경우에는 nginx ingress controller등을 이용하며 nginx 에 적용할 rule을 <code>Ingress</code>라는 K8s Object를 통해 설정합니다. ingress controller의 설정에서 자신의 class name을 적어주고, <code>Ingress</code>에서는 어떤 class name의 ingress controller에서 자신(Ingress이자 Rule)을 적용하도록 할 지를 annotation을 통해 설정하거나 ingressClassName이라는 필드를 통해 설정합니다.(ingress 설정에 대한 참고 - <a href=https://kubernetes.io/ko/docs/concepts/services-networking/ingress/#%EC%9D%B8%EA%B7%B8%EB%A0%88%EC%8A%A4-%ED%81%B4%EB%9E%98%EC%8A%A4>https://kubernetes.io/ko/docs/concepts/services-networking/ingress/#인그레스-클래스</a>)</p><p>이와 같은 경우에는 ingress controller가 직접 ingress에 명시된 rule을 이용했지만, <strong>alb-ingress-controller</strong>의 경우는 alb-ingress-controller가 nginx-ingress-controller처럼 <strong>직접 웹서버의 역할을 하는 것이 아닌</strong>, ingress에 명시된 rule을 이용하는 <strong>ALB를 생성하고 관리</strong>하는 역할을 한다는 것입니다. 이 부분이 처음에는 다소 헷갈리게 느껴질 수 있기에 길게 서술해보았습니다.</p><p>실제로 ingress를 생성한 뒤 앞에서 배포한 alb-ingress-controller의 log를 보면 alb를 관리하기위한 여러 작업을 수행중인 모습을 볼 수 있습니다.</p><p>그럼 이제 실제로 alb ingress controller을 통해 alb를 이용해보겠습니다.</p><h3 id=alb를-원활히-제어하기-위한-permission-부여>ALB를 원활히 제어하기 위한 permission 부여</h3><ul><li>ALB iam 정책 참고<ul><li><a href=https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/alb-ingress.html>https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/alb-ingress.html</a></li><li><a href=https://raw.githubusercontent.com/kubernetes-sigs/aws-alb-ingress-controller/v1.1.2/docs/examples/iam-policy.json>https://raw.githubusercontent.com/kubernetes-sigs/aws-alb-ingress-controller/v1.1.2/docs/examples/iam-policy.json</a></li></ul></li></ul><p><code>ALB</code>를 제어하기 위해서는 aws의 리소스에 대한 어떠한 permission이 필요합니다. <code>node</code>에 부여할 수도 있고, IAM User에 부여한 뒤 <code>alb ingress controller</code>의 설정에서 해당 IAM User의 Key를 부여할 수도 있고, Service account와 IAM Role을 <code>OIDC</code>(OpenID Connect를 이용해 Service account와 IAM Role을 연결시키는 작업)를 이용해 엮은 뒤, alb ingress controller pod에 해당 Service Account를 부여할 수도 있지만 뒤의 방법들은 좀 튜토리얼치고 투머치한 감이 있기때문에, 간단히 node에 Permission을 부여하도록하겠습니다.</p><p><img src=iam.png alt=iam.png></p><p>worker node들이 이용하는 IAM Role에 Policy를 추가한 모습.</p><h3 id=alb가-사용할-subnet에-적절한-태그-달기>alb가 사용할 subnet에 적절한 태그 달기</h3><p><a href=https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/alb-ingress.html>https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/alb-ingress.html</a> 에 나와있듯이 ELB가 이용하는 서브넷을 자동으로 설정되도록 하기 위해서는 사용하고자 하는 서브넷에 아래와 같은 태그들을 달아주어야한다.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=color:#a6e22e>kubernetes</span>.<span style=color:#a6e22e>io</span><span style=color:#f92672>/</span><span style=color:#a6e22e>cluster</span><span style=color:#f92672>/</span>&lt;<span style=color:#f92672>cluster</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#a6e22e>name</span>&gt; <span style=color:#f92672>=</span> <span style=color:#a6e22e>shared</span> <span style=color:#f92672>|</span> <span style=color:#a6e22e>owned</span> <span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#a6e22e>Required</span>
<span style=color:#a6e22e>kubernetes</span>.<span style=color:#a6e22e>io</span><span style=color:#f92672>/</span><span style=color:#a6e22e>role</span><span style=color:#f92672>/</span><span style=color:#a6e22e>internal</span><span style=color:#f92672>-</span><span style=color:#a6e22e>elb</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>|</span> <span style=color:#e6db74>&#34;&#34;</span> <span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#a6e22e>Optional</span>, <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>internal</span> <span style=color:#a6e22e>alb</span>
<span style=color:#a6e22e>kubernetes</span>.<span style=color:#a6e22e>io</span><span style=color:#f92672>/</span><span style=color:#a6e22e>role</span><span style=color:#f92672>/</span><span style=color:#a6e22e>elb</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>|</span> <span style=color:#e6db74>&#34;&#34;</span> <span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#a6e22e>Optional</span>, <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>internet</span><span style=color:#f92672>-</span><span style=color:#a6e22e>facing</span> <span style=color:#a6e22e>alb</span>
</code></pre></div><p><code>a | b</code>와 같은 표현은 a 나 b중 한 값을 가져야한다는 의미로 표현한 것입니다.</p><p><img src=tag.png alt=tag.png></p><p>internet facing ALB만 이용할 것이기 때문에 <a href=http://kubernetes.io/role/internal-elb><code>kubernetes.io/role/internal-elb</code></a> tag는 생략하고 태그를 달아준 모습.</p><p>subnet에 ALB를 사용하기 위한 태그를 제대로 달아주지 않을 경우 alb-ingress-controller 에서 아래와 같은 로그를 보게 됩니다. ALB가 생성되지도 않습니다.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=color:#a6e22e>controller</span>.<span style=color:#a6e22e>go</span><span style=color:#f92672>:</span><span style=color:#ae81ff>217</span>] <span style=color:#a6e22e>kubebuilder</span><span style=color:#f92672>/</span><span style=color:#a6e22e>controller</span> <span style=color:#e6db74>&#34;msg&#34;</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Reconciler error&#34;</span> <span style=color:#e6db74>&#34;error&#34;</span><span style=color:#f92672>=</span><span style=color:#960050;background-color:#1e0010>&#34;</span><span style=color:#a6e22e>failed</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>build</span> <span style=color:#a6e22e>LoadBalancer</span> <span style=color:#a6e22e>configuration</span> <span style=color:#a6e22e>due</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>failed</span> <span style=color:#a6e22e>to</span> <span style=color:#a6e22e>resolve</span> <span style=color:#ae81ff>2</span> <span style=color:#a6e22e>qualified</span> <span style=color:#a6e22e>subnet</span> <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>ALB</span>. <span style=color:#a6e22e>Subnets</span> <span style=color:#a6e22e>must</span> <span style=color:#a6e22e>contains</span> <span style=color:#a6e22e>these</span> <span style=color:#a6e22e>tags</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;kubernetes.io/cluster/umi-dev&#39;</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#39;shared&#39;</span> <span style=color:#a6e22e>or</span> <span style=color:#e6db74>&#39;owned&#39;</span>] <span style=color:#a6e22e>and</span> <span style=color:#e6db74>&#39;kubernetes.io/role/internal-elb&#39;</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#39;&#39;</span> <span style=color:#a6e22e>or</span> <span style=color:#e6db74>&#39;1&#39;</span>]
</code></pre></div><h3 id=alb-ingress-controller-배포하기>alb ingress controller 배포하기.</h3><blockquote><p>슬슬 읽기 귀찮아질 타이밍입니다. &lsquo;<em>요놈이 IAM policy도 만들고, 서브넷에 엄한 태그를 달더니 이제는 하,,, 뭘 또 배포하라고 하는구나 아이고 내 눈아,,,</em>&rsquo; 싶겠지만, 좀 더 힘을 내어봅시다 🍻</p></blockquote><p><a href=https://kubernetes-sigs.github.io/aws-alb-ingress-controller/guide/controller/setup/>https://kubernetes-sigs.github.io/aws-alb-ingress-controller/guide/controller/setup/</a> 를 참고하여 <code>Deployment</code> 내의 container의 <code>args</code>를 자신의 상황에 맞게 수정한 뒤 배포해줍니다.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx>...
  <span style=color:#a6e22e>args</span><span style=color:#f92672>:</span>
    <span style=color:#f92672>-</span> <span style=color:#f92672>--</span><span style=color:#a6e22e>ingress</span><span style=color:#f92672>-</span><span style=color:#66d9ef>class</span><span style=color:#f92672>=</span><span style=color:#a6e22e>alb</span> <span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#a6e22e>ingress의</span> <span style=color:#a6e22e>annotation에</span> <span style=color:#a6e22e>명시할</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>name</span>
    <span style=color:#f92672>-</span> <span style=color:#f92672>--</span><span style=color:#a6e22e>cluster</span><span style=color:#f92672>-</span><span style=color:#a6e22e>name</span><span style=color:#f92672>=</span><span style=color:#a6e22e>umi</span><span style=color:#f92672>-</span><span style=color:#a6e22e>dev</span> <span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#a6e22e>eks</span> <span style=color:#a6e22e>cluster</span> <span style=color:#a6e22e>name</span>
    <span style=color:#f92672>-</span> <span style=color:#f92672>--</span><span style=color:#a6e22e>aws</span><span style=color:#f92672>-</span><span style=color:#a6e22e>region</span><span style=color:#f92672>=</span><span style=color:#a6e22e>ap</span><span style=color:#f92672>-</span><span style=color:#a6e22e>northeast</span><span style=color:#f92672>-</span><span style=color:#ae81ff>2</span>
    <span style=color:#f92672>-</span> <span style=color:#f92672>--</span><span style=color:#a6e22e>aws</span><span style=color:#f92672>-</span><span style=color:#a6e22e>api</span><span style=color:#f92672>-</span><span style=color:#a6e22e>debug</span><span style=color:#f92672>=</span><span style=color:#66d9ef>true</span>
</code></pre></div><p>저는 위와 같은 식으로 설정해주었고, 잘 배포되었는지 확인해봅니다.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=color:#a6e22e>$</span> <span style=color:#a6e22e>kubectl</span> <span style=color:#a6e22e>get</span> <span style=color:#a6e22e>po</span> <span style=color:#f92672>-</span><span style=color:#a6e22e>A</span> <span style=color:#f92672>|</span> <span style=color:#a6e22e>grep</span> <span style=color:#a6e22e>alb</span>
<span style=color:#a6e22e>kube</span><span style=color:#f92672>-</span><span style=color:#a6e22e>system</span>   <span style=color:#a6e22e>alb</span><span style=color:#f92672>-</span><span style=color:#a6e22e>ingress</span><span style=color:#f92672>-</span><span style=color:#a6e22e>controller</span><span style=color:#f92672>-</span><span style=color:#ae81ff>594</span><span style=color:#a6e22e>f84b465</span><span style=color:#f92672>-</span><span style=color:#a6e22e>q4qjb</span>   <span style=color:#ae81ff>1</span><span style=color:#f92672>/</span><span style=color:#ae81ff>1</span>     <span style=color:#a6e22e>Running</span>   <span style=color:#ae81ff>0</span>          <span style=color:#ae81ff>106</span><span style=color:#a6e22e>m</span>
</code></pre></div><h3 id=노출시킬-서비스-배포하기>노출시킬 서비스 배포하기</h3><p>간단하게 <code>Nginx</code>를 배포해보록하겠습니다.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=color:#a6e22e>apiVersion</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>v1</span>
<span style=color:#a6e22e>kind</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Service</span>
<span style=color:#a6e22e>metadata</span><span style=color:#f92672>:</span>
  <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>ingress</span><span style=color:#f92672>-</span><span style=color:#a6e22e>test</span>
<span style=color:#a6e22e>spec</span><span style=color:#f92672>:</span>
  <span style=color:#a6e22e>selector</span><span style=color:#f92672>:</span>
    <span style=color:#a6e22e>app</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>nginx</span>
  <span style=color:#a6e22e>ports</span><span style=color:#f92672>:</span>
    <span style=color:#f92672>-</span> <span style=color:#a6e22e>protocol</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>TCP</span>
      <span style=color:#a6e22e>port</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>80</span>
      <span style=color:#a6e22e>targetPort</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>80</span>
      <span style=color:#a6e22e>nodePort</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>30010</span>
  <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>NodePort</span>

<span style=color:#f92672>---</span>
<span style=color:#a6e22e>apiVersion</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>apps</span><span style=color:#f92672>/</span><span style=color:#a6e22e>v1</span>
<span style=color:#a6e22e>kind</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Deployment</span>
<span style=color:#a6e22e>metadata</span><span style=color:#f92672>:</span>
  <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>ingress</span><span style=color:#f92672>-</span><span style=color:#a6e22e>test</span>
  <span style=color:#a6e22e>labels</span><span style=color:#f92672>:</span>
    <span style=color:#a6e22e>app</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>nginx</span>
<span style=color:#a6e22e>spec</span><span style=color:#f92672>:</span>
  <span style=color:#a6e22e>replicas</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>3</span>
  <span style=color:#a6e22e>selector</span><span style=color:#f92672>:</span>
    <span style=color:#a6e22e>matchLabels</span><span style=color:#f92672>:</span>
      <span style=color:#a6e22e>app</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>nginx</span>
  <span style=color:#a6e22e>template</span><span style=color:#f92672>:</span>
    <span style=color:#a6e22e>metadata</span><span style=color:#f92672>:</span>
      <span style=color:#a6e22e>labels</span><span style=color:#f92672>:</span>
        <span style=color:#a6e22e>app</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>nginx</span>
    <span style=color:#a6e22e>spec</span><span style=color:#f92672>:</span>
      <span style=color:#a6e22e>containers</span><span style=color:#f92672>:</span>
      <span style=color:#f92672>-</span> <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>nginx</span>
        <span style=color:#a6e22e>image</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>nginx</span>
        <span style=color:#a6e22e>ports</span><span style=color:#f92672>:</span>
        <span style=color:#f92672>-</span> <span style=color:#a6e22e>containerPort</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>80</span>
</code></pre></div><p>ALB는 기본적으로 <strong>node의 Port</strong>를 AWS 상의 <code>target group</code>으로서 이용하기 때문에, ingress를 통해 노출시켜줄 서비스는 적어도 <code>NodePort</code> 타입으로 노출되어있어야 <code>ALB ingress controller</code>가 해당 서비스를 노출시킬 수 있습니다.(target type을 기본값인 <code>instance</code>가 아니라 <code>IP</code>로 설정하면, Pod의 IP로 트래픽이 흘러가게 할 수는 있습니다.)</p><p>작동방식을 설명해보자면 ingress 는 service name과 service port를 설정으로 받습니다. alb-ingress-controller는 그러면 해당 service name, service port와 연결된 NodePort를 찾아서 ALB의 target group으로 등록시킵니다.</p><h3 id=ingress-배포하기>Ingress 배포하기</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=color:#a6e22e>apiVersion</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>extensions</span><span style=color:#f92672>/</span><span style=color:#a6e22e>v1beta1</span>
<span style=color:#a6e22e>kind</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Ingress</span>
<span style=color:#a6e22e>metadata</span><span style=color:#f92672>:</span>
  <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;ingress&#34;</span>
  <span style=color:#a6e22e>annotations</span><span style=color:#f92672>:</span>
    <span style=color:#a6e22e>kubernetes</span>.<span style=color:#a6e22e>io</span><span style=color:#f92672>/</span><span style=color:#a6e22e>ingress</span>.<span style=color:#66d9ef>class</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>alb</span> <span style=color:#960050;background-color:#1e0010>#</span> <span style=color:#a6e22e>the</span> <span style=color:#a6e22e>value</span> <span style=color:#a6e22e>we</span> <span style=color:#a6e22e>set</span> <span style=color:#66d9ef>in</span> <span style=color:#a6e22e>alb</span><span style=color:#f92672>-</span><span style=color:#a6e22e>ingress</span><span style=color:#f92672>-</span><span style=color:#a6e22e>controller</span>
    <span style=color:#a6e22e>alb</span>.<span style=color:#a6e22e>ingress</span>.<span style=color:#a6e22e>kubernetes</span>.<span style=color:#a6e22e>io</span><span style=color:#f92672>/</span><span style=color:#a6e22e>scheme</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>internet</span><span style=color:#f92672>-</span><span style=color:#a6e22e>facing</span>
<span style=color:#a6e22e>spec</span><span style=color:#f92672>:</span>
  <span style=color:#a6e22e>rules</span><span style=color:#f92672>:</span>
    <span style=color:#f92672>-</span> <span style=color:#a6e22e>http</span><span style=color:#f92672>:</span>
        <span style=color:#a6e22e>paths</span><span style=color:#f92672>:</span>
          <span style=color:#f92672>-</span> <span style=color:#a6e22e>path</span><span style=color:#f92672>:</span> <span style=color:#960050;background-color:#1e0010>/*</span>
            <span style=color:#a6e22e>backend</span><span style=color:#f92672>:</span>
              <span style=color:#a6e22e>serviceName</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;ingress-test&#34;</span>
              <span style=color:#a6e22e>servicePort</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>80</span>
</code></pre></div><p><a href=https://kubernetes-sigs.github.io/aws-alb-ingress-controller/guide/ingress/annotation/>https://kubernetes-sigs.github.io/aws-alb-ingress-controller/guide/ingress/annotation/</a> 을 참고하여 <code>Ingress</code>를 작성해줍니다. <code>[kubernetes.io/ingress.class</code>는](<a href=http://kubernetes.io/ingress.class>http://kubernetes.io/ingress.class</a>는) alb-ingress-controller에서 설정한 <code>ingress.class</code>를 적어주고, <a href=http://alb.ingress.kubernetes.io/scheme%EB%8A%94><code>alb.ingress.kubernetes.io/scheme</code>는</a> 용도에 따라 <code>internet-facing</code> 혹은 <code>internal</code>을 적어줍니다. ingress 를 생성하기 전에 <code>kubectl logs -f {alb-ingress-controller pod name}</code>을 한 창에 띄워놓으면 ALB 생성 관련 로그를 쭈루룩 볼 수 있습니다.</p><p><img src=elb.png alt=elb.png></p><p>잘 설정되었다면 위와 같이 ALB가 생성될 것 입니다.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=color:#a6e22e>$</span> <span style=color:#a6e22e>kubectl</span> <span style=color:#a6e22e>get</span> <span style=color:#a6e22e>ingress</span>
<span style=color:#a6e22e>NAME</span>      <span style=color:#a6e22e>HOSTS</span>   <span style=color:#a6e22e>ADDRESS</span>                                                                     <span style=color:#a6e22e>PORTS</span>   <span style=color:#a6e22e>AGE</span>
<span style=color:#a6e22e>ingress</span>   <span style=color:#f92672>*</span>       <span style=color:#a6e22e>bf1e76be</span><span style=color:#f92672>-</span><span style=color:#66d9ef>default</span><span style=color:#f92672>-</span><span style=color:#a6e22e>ingress</span><span style=color:#f92672>-</span><span style=color:#a6e22e>e8c7</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1351183883.</span><span style=color:#a6e22e>ap</span><span style=color:#f92672>-</span><span style=color:#a6e22e>northeast</span><span style=color:#f92672>-</span><span style=color:#ae81ff>2.</span><span style=color:#a6e22e>elb</span>.<span style=color:#a6e22e>amazonaws</span>.<span style=color:#a6e22e>com</span>   <span style=color:#ae81ff>80</span>      <span style=color:#ae81ff>30</span><span style=color:#a6e22e>s</span>
</code></pre></div><h3 id=인증서-설정을-통해-https-까지>인증서 설정을 통해 HTTPS 까지?!</h3><blockquote><p>❤️ AWS <code>Certificate Manager</code>와 <code>Ingress</code>에 대한 <code>annotation</code>을 이용해 간단하게 <code>HTTPS</code>를 이용할 수도 있습니다! 직접하려면 도메인 소유 인증과 인증서, 비밀키 등을 모두 관리해야했는데 말이지요! 🐥</p></blockquote><p><img src=cert.png alt=cert.png></p><p>이런식으로 AWS의 <code>Certificate Manager</code>을 통해 발급받은 인증서가 있다면 이를 alb 에서 ingress에 annotation을 설정함으로써 사용할 수 있습니다.</p><p><strong>Ingress의 annotation에 HTTPS및 인증서 관련 설정 추가해주기</strong></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=color:#a6e22e>apiVersion</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>extensions</span><span style=color:#f92672>/</span><span style=color:#a6e22e>v1beta1</span>
<span style=color:#a6e22e>kind</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Ingress</span>
<span style=color:#a6e22e>metadata</span><span style=color:#f92672>:</span>
  <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;ingress&#34;</span>
  <span style=color:#a6e22e>annotations</span><span style=color:#f92672>:</span>
    <span style=color:#a6e22e>kubernetes</span>.<span style=color:#a6e22e>io</span><span style=color:#f92672>/</span><span style=color:#a6e22e>ingress</span>.<span style=color:#66d9ef>class</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>alb</span>
    <span style=color:#a6e22e>alb</span>.<span style=color:#a6e22e>ingress</span>.<span style=color:#a6e22e>kubernetes</span>.<span style=color:#a6e22e>io</span><span style=color:#f92672>/</span><span style=color:#a6e22e>scheme</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>internet</span><span style=color:#f92672>-</span><span style=color:#a6e22e>facing</span>
    <span style=color:#a6e22e>alb</span>.<span style=color:#a6e22e>ingress</span>.<span style=color:#a6e22e>kubernetes</span>.<span style=color:#a6e22e>io</span><span style=color:#f92672>/</span><span style=color:#a6e22e>listen</span><span style=color:#f92672>-</span><span style=color:#a6e22e>ports</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;[{&#34;HTTP&#34;: 80}, {&#34;HTTPS&#34;: 443}]&#39;</span>
    <span style=color:#a6e22e>alb</span>.<span style=color:#a6e22e>ingress</span>.<span style=color:#a6e22e>kubernetes</span>.<span style=color:#a6e22e>io</span><span style=color:#f92672>/</span><span style=color:#a6e22e>actions</span>.<span style=color:#a6e22e>redirect</span><span style=color:#f92672>-</span><span style=color:#a6e22e>to</span><span style=color:#f92672>-</span><span style=color:#a6e22e>https</span><span style=color:#f92672>:</span> <span style=color:#f92672>&gt;</span>
      {<span style=color:#e6db74>&#34;Type&#34;</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#34;redirect&#34;</span>,<span style=color:#e6db74>&#34;RedirectConfig&#34;</span><span style=color:#f92672>:</span>{<span style=color:#e6db74>&#34;Port&#34;</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#34;443&#34;</span>,<span style=color:#e6db74>&#34;Protocol&#34;</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#34;HTTPS&#34;</span>,<span style=color:#e6db74>&#34;StatusCode&#34;</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#34;HTTP_302&#34;</span>}}
    <span style=color:#a6e22e>alb</span>.<span style=color:#a6e22e>ingress</span>.<span style=color:#a6e22e>kubernetes</span>.<span style=color:#a6e22e>io</span><span style=color:#f92672>/</span><span style=color:#a6e22e>certificate</span><span style=color:#f92672>-</span><span style=color:#a6e22e>arn</span><span style=color:#f92672>:</span> {<span style=color:#a6e22e>Certificate</span> <span style=color:#a6e22e>Manger의</span> <span style=color:#a6e22e>인증서</span> <span style=color:#a6e22e>arn</span>}
...
</code></pre></div><p><em>http redirect 및 actions에 대한 내용은 저의 애교입니다.</em> 궁금하신 분들은 한 번 적용해보시거나 알아보시면 어렵지 않게 알아내실 수 있을 겁니다! 😆</p><p><strong>Route53에 ALB 추가해주기</strong></p><p>EKS에서 ALB를 사용하는 등의 작업을 하시는 분은 어느 정도 aws에 대한 이해가 있으리라 생각하고, ALB를 Route53을 통해 레코드로 추가하는 작업에 대한 설명은 생략하겠습니다.</p><p><img src=cert2.png alt=cert2.png></p><p>alb-ingress-controller로 AWS Certificate Manager의 인증서까지 사용한 모습.</p><h2 id=-nlb를-사용해-서비스를-노출시키는-방법>🌎 NLB를 사용해 서비스를 노출시키는 방법</h2><p>CLB는 Deprecate 대상이라고 들었기도 하고, 굳이 써본 적이 없어 NLB로만 설명합니다. NLB는 ALB에 비해 사용이 간단합니다.</p><p>Ingress와 alb-ingress-controller를 사용했던 ALB와 달리 NLB는 서비스를 직접 노출시킵니다. 주로 <code>Nginx Ingress Controller</code>을 NLB에 연결해서 사용했던 기억이 납니다. NLB는 L4 LB로, Nginx를 주로 L7 LB로 사용하는 경우 이렇게 NLB를 사용합니다. ALB와 Nginx 모두 L7 LB로서 역할을 하기때문에 굳이 ALB를 사용할 필요가 없는 경우가 많았습니다.</p><p>NLB를 통해 서비스를 노출시키기 위해선 annotaion중에서도 [<code>service.beta.kubernetes.io](http://service.beta.kubernetes.io/)...</code>형태의 annotation을 이용합니다. 사실 실제로 실무해서 사용해본 annotation은 거의 [<code>service.beta.kubernetes.io/aws-load-balancer-type:](http://service.beta.kubernetes.io/aws-load-balancer-type:) "nlb"</code> 뿐입니다. (이를 사용하지 않을 경우 디폴트가 CLB이기 때문에&mldr;)</p><h3 id=nlb가-사용할-subnet에-적절한-태그-달기>NLB가 사용할 subnet에 적절한 태그 달기</h3><p>ALB를 사용했을 때와 마찬가지로 NLB가 사용할 서브넷에 필수 태그를 달아줍니다. 기억이 안난 다면 글의 상단 ALB 파트를 참고!</p><h3 id=nlb로-노출할-서비스-생성하기>NLB로 노출할 서비스 생성하기</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=color:#a6e22e>apiVersion</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>v1</span>
<span style=color:#a6e22e>kind</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Service</span>
<span style=color:#a6e22e>metadata</span><span style=color:#f92672>:</span>
  <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>nginx</span><span style=color:#f92672>-</span><span style=color:#a6e22e>nlb</span>
  <span style=color:#a6e22e>annotations</span><span style=color:#f92672>:</span>
    <span style=color:#a6e22e>service</span>.<span style=color:#a6e22e>beta</span>.<span style=color:#a6e22e>kubernetes</span>.<span style=color:#a6e22e>io</span><span style=color:#f92672>/</span><span style=color:#a6e22e>aws</span><span style=color:#f92672>-</span><span style=color:#a6e22e>load</span><span style=color:#f92672>-</span><span style=color:#a6e22e>balancer</span><span style=color:#f92672>-</span><span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;nlb&#34;</span>
<span style=color:#a6e22e>spec</span><span style=color:#f92672>:</span>
  <span style=color:#a6e22e>selector</span><span style=color:#f92672>:</span>
    <span style=color:#a6e22e>app</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>nginx</span>
  <span style=color:#a6e22e>ports</span><span style=color:#f92672>:</span>
    <span style=color:#f92672>-</span> <span style=color:#a6e22e>protocol</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>TCP</span>
      <span style=color:#a6e22e>port</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>80</span>
      <span style=color:#a6e22e>targetPort</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>80</span>
      <span style=color:#a6e22e>nodePort</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>30011</span>
  <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>LoadBalancer</span>
</code></pre></div><p><img src=terminal.png alt=terminal.png></p><p><img src=zzal.png alt=zzal.png></p><p>간단히 type을 LoadBalancer로 바꾸어주고, annotation에 어떤 ELB를 사용할지( NLB/CLB )만 적어주면 아래 그림처럼 손쉽게 NLB로 서비스를 노출 시킬 수 있습니다.</p><h3 id=인증서-설정을-통해-https까지>인증서 설정을 통해 HTTPS까지?!</h3><blockquote><p>🌋: &ldquo;그만&mldr;. 아무도 안 궁금해&mldr;&rdquo; - 하지만 마지막까지 힘을 내서 EKS에서의 ELB를 정복해봅시다!</p></blockquote><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=color:#a6e22e>apiVersion</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>v1</span>
<span style=color:#a6e22e>kind</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>Service</span>
<span style=color:#a6e22e>metadata</span><span style=color:#f92672>:</span>
  <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>nginx</span><span style=color:#f92672>-</span><span style=color:#a6e22e>nlb</span>
  <span style=color:#a6e22e>annotations</span><span style=color:#f92672>:</span>
    <span style=color:#a6e22e>service</span>.<span style=color:#a6e22e>beta</span>.<span style=color:#a6e22e>kubernetes</span>.<span style=color:#a6e22e>io</span><span style=color:#f92672>/</span><span style=color:#a6e22e>aws</span><span style=color:#f92672>-</span><span style=color:#a6e22e>load</span><span style=color:#f92672>-</span><span style=color:#a6e22e>balancer</span><span style=color:#f92672>-</span><span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;nlb&#34;</span>
    <span style=color:#a6e22e>service</span>.<span style=color:#a6e22e>beta</span>.<span style=color:#a6e22e>kubernetes</span>.<span style=color:#a6e22e>io</span><span style=color:#f92672>/</span><span style=color:#a6e22e>aws</span><span style=color:#f92672>-</span><span style=color:#a6e22e>load</span><span style=color:#f92672>-</span><span style=color:#a6e22e>balancer</span><span style=color:#f92672>-</span><span style=color:#a6e22e>backend</span><span style=color:#f92672>-</span><span style=color:#a6e22e>protocol</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>tcp</span>
    <span style=color:#a6e22e>service</span>.<span style=color:#a6e22e>beta</span>.<span style=color:#a6e22e>kubernetes</span>.<span style=color:#a6e22e>io</span><span style=color:#f92672>/</span><span style=color:#a6e22e>aws</span><span style=color:#f92672>-</span><span style=color:#a6e22e>load</span><span style=color:#f92672>-</span><span style=color:#a6e22e>balancer</span><span style=color:#f92672>-</span><span style=color:#a6e22e>ssl</span><span style=color:#f92672>-</span><span style=color:#a6e22e>ports</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;443&#34;</span>
    <span style=color:#a6e22e>service</span>.<span style=color:#a6e22e>beta</span>.<span style=color:#a6e22e>kubernetes</span>.<span style=color:#a6e22e>io</span><span style=color:#f92672>/</span><span style=color:#a6e22e>aws</span><span style=color:#f92672>-</span><span style=color:#a6e22e>load</span><span style=color:#f92672>-</span><span style=color:#a6e22e>balancer</span><span style=color:#f92672>-</span><span style=color:#a6e22e>ssl</span><span style=color:#f92672>-</span><span style=color:#a6e22e>cert</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>arn</span><span style=color:#f92672>:</span><span style=color:#a6e22e>aws</span><span style=color:#f92672>:</span><span style=color:#a6e22e>acm</span><span style=color:#f92672>:</span><span style=color:#a6e22e>ap</span><span style=color:#f92672>-</span><span style=color:#a6e22e>northeast</span><span style=color:#f92672>-</span><span style=color:#ae81ff>2</span><span style=color:#f92672>:</span>{{<span style=color:#a6e22e>root</span>}}<span style=color:#f92672>:</span><span style=color:#a6e22e>certificate</span><span style=color:#f92672>/</span>{{<span style=color:#a6e22e>arn</span>}}

<span style=color:#a6e22e>spec</span><span style=color:#f92672>:</span>
  <span style=color:#a6e22e>selector</span><span style=color:#f92672>:</span>
    <span style=color:#a6e22e>app</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>nginx</span>
  <span style=color:#a6e22e>ports</span><span style=color:#f92672>:</span>
    <span style=color:#f92672>-</span> <span style=color:#a6e22e>protocol</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>TCP</span>
      <span style=color:#a6e22e>port</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>80</span>
      <span style=color:#a6e22e>targetPort</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>80</span>
      <span style=color:#a6e22e>nodePort</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>30011</span>
    <span style=color:#f92672>-</span> <span style=color:#a6e22e>protocol</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>TCP</span>
      <span style=color:#a6e22e>port</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>443</span>
      <span style=color:#a6e22e>targetPort</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>80</span>
      <span style=color:#a6e22e>nodePort</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>30012</span>
  <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>LoadBalancer</span>
</code></pre></div><p><code>backend-protocol</code>은 <code>tcp</code>|tls 혹은 https|http로 설정이 돠는 듯합니다. 예를 들어 <code>backend-protocol</code> 로 <code>tcp</code>를 설정한 뒤 <code>ssl-port</code>로 443을 설정, 서비스의 <code>spec</code>에서의 포트로는 <code>80</code>과 <code>443</code>을 설정하면, 자동적으로 <code>80</code>은 <code>tcp</code>, <code>443</code>은 tls를 이용하는 NLB listener로 설정되게 되는데 http,https도 마찬가지로 tcp,tls로 적절히 설정이 됩니다. 다만 http,https를 설정할 경우 <code>X-Forwarded-For</code> 헤더가 삽입된다고 합니다. (정확하지는 않아요&mldr; 딱히 NLB의 backend protocol을 L7으로 설정하는 것이 NLB의 원래 스펙이 아니었던 점도 있고, L7을 이용하고 싶으면, ALB를 이용하는 것이 더 편하다고 생각이 들어서 따로 검증해본 적이 없기 때문에&mldr; )</p><p>⚠️<strong>단점</strong>이 하나 있다면 아직 <strong>http⇒https redirect</strong>가 불가능하다는 것인데, 이는 애초에 L4 LB를 이용하는 것과 L7 LB를 이용하는 쓰임에 대한 차이라고 생각을 하기 때문에 감수를 해야할 것 같습니다. 예를 들어 L4 NLB에 L7 nginx-ingress-controller을 연결하여 redirect는 nginx가 담당하도록하는 방식을 많이 이용하는 것 같습니다. NLB에서는 L4 의 뭔가 SSL/TLS한 작업을 하기 위함이고, L7의 https 작업이 주가 되는 것은 아니므로&mldr;? <em>사실 이 부분은 잘 모르겠습니다&mldr;💦💦 잘 아시는 분이 계시다면 알려주시면 감사하겠습니다. ㅜㅜㅜ</em>( NLB에서 HTTP, HTTPS redirect가 안되는 이유 참고 - <a href=https://aws.amazon.com/premiumsupport/knowledge-center/redirect-http-https-elb/>https://aws.amazon.com/premiumsupport/knowledge-center/redirect-http-https-elb/</a> )</p><h3 id=-nlb를-통한-https-서버-구축-결과>⭕️ NLB를 통한 HTTPS 서버 구축 결과</h3><p>어쨌든 위의 annotation을 통해 올바르게 svc를 설정한다면</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=color:#a6e22e>$</span> <span style=color:#a6e22e>kubectl</span> <span style=color:#a6e22e>get</span> <span style=color:#a6e22e>svc</span>

<span style=color:#a6e22e>nginx</span><span style=color:#f92672>-</span><span style=color:#a6e22e>nlb</span>    <span style=color:#a6e22e>LoadBalancer</span>   <span style=color:#ae81ff>10.100.180.174</span>   <span style=color:#a6e22e>ae27784521c4f4bcd96b22f2cca2358b</span><span style=color:#f92672>-</span><span style=color:#ae81ff>4</span><span style=color:#a6e22e>bffb166fafa47f2</span>.<span style=color:#a6e22e>elb</span>.<span style=color:#a6e22e>ap</span><span style=color:#f92672>-</span><span style=color:#a6e22e>northeast</span><span style=color:#f92672>-</span><span style=color:#ae81ff>2.</span><span style=color:#a6e22e>amazonaws</span>.<span style=color:#a6e22e>com</span>   <span style=color:#ae81ff>443</span><span style=color:#f92672>:</span><span style=color:#ae81ff>30014</span><span style=color:#f92672>/</span><span style=color:#a6e22e>TCP</span>   <span style=color:#ae81ff>37</span><span style=color:#a6e22e>m</span>
</code></pre></div><ul><li>Route53 설정은 추가로 해주어야함. - 예시
<a href=http://nlb.umidev.net>nlb.umidev.net</a> - ALIAS ae2778452xxxxxxxxxxxxxx.elb.ap-northeast-2.amazonaws.com</li></ul><p>이렇게 service가 생성될 것이고, (service의 port로서 사용할 80,443 등은 service.spec에서 명시) 생성 후 <code>A Record Alias</code>로서 NLB의 <code>DNS</code> name을 넣어주면 사진과 같이 <code>HTTPS</code> 접속이 가능합니다!</p><p><img src=cert3.png alt=cert3.png></p><h2 id=-마치며>🐳 마치며</h2><p>어차피 한 번의 검색이면 정보를 얻을 수 있는 모든 annotation이나 기타 설정에 대한 내용을 다루기 보단 나름 제가 <strong>실제로 쿠버네티스를 관리하는</strong> <strong>데브옵스 인턴로서 일을 하면서 헷갈렸던 내용</strong>과 <strong>EKS에서의 ELB 관리에 대한 흐름</strong>을 위주로 설명하려 노력했고, 저의 <code>삽질</code>이 깃든 내용들입니다 ㅎㅎㅎ</p><p>아는 범위 + 좀 더 조사하여 열심히 정리해보았지만, 부족한 부분이 있을 수도 있고 틀린 부분이 있을 수도 있을텐데, 보완해주실 내용이 있다면 말씀해주시면 열심히 검토해보겠습니다~! 감사합니다.</p><h2 id=글쓴이>🧙‍♂️글쓴이</h2><ul><li><strong>박진수</strong> - 👨‍👩‍👧‍👧<code>AUSG</code> (AWS University Student Group) 3기로 활동 중</li><li><strong>관심사</strong><ul><li><code>Docker</code>, <code>Kubernetes</code> 등의 <strong>컨테이너 기술</strong></li><li><code>Argo</code>, <code>Spinnaker</code>, <code>Github action</code> 등의 <strong>CI/CD 툴</strong></li><li><code>Terraform</code>, <code>AWS</code>를 통한 <strong>클라우드 인프라 구축</strong></li></ul></li><li><strong>Blog</strong> - <a href=https://senticoding.tistory.com>https://senticoding.tistory.com</a></li><li><strong>Email</strong> - <a href=mailto:bo314@naver.com>bo314@naver.com</a></li></ul><h2 id=-참고-references>📚 참고 (References)</h2><ul><li>EKS의 Required subnet tags<ul><li><a href=https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/load-balancing.html>https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/load-balancing.html</a></li><li><a href=https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/alb-ingress.html>https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/alb-ingress.html</a></li></ul></li><li>Kubernetes Cloud provider aws - <a href=https://kubernetes.io/docs/concepts/cluster-administration/cloud-providers/#aws>https://kubernetes.io/docs/concepts/cluster-administration/cloud-providers/#aws</a></li><li>ALB ingress controller install - <a href=https://kubernetes-sigs.github.io/aws-alb-ingress-controller/guide/controller/setup/>https://kubernetes-sigs.github.io/aws-alb-ingress-controller/guide/controller/setup/</a></li><li>ALB ingress Annotation <a href=https://kubernetes-sigs.github.io/aws-alb-ingress-controller/guide/ingress/annotation/>https://kubernetes-sigs.github.io/aws-alb-ingress-controller/guide/ingress/annotation/</a></li><li>NLB의 HTTPS redirect가 불가능한 이유 -<a href=https://aws.amazon.com/premiumsupport/knowledge-center/redirect-http-https-elb/>https://aws.amazon.com/premiumsupport/knowledge-center/redirect-http-https-elb/</a></li><li>NLB service Annotations - <a href=https://kubernetes.io/ko/docs/concepts/services-networking/service/#aws-nlb-support>https://kubernetes.io/ko/docs/concepts/services-networking/service/#aws-nlb-support</a></li><li>Ingress의 class에 대해 - <a href=https://kubernetes.io/ko/docs/concepts/services-networking/ingress/#%EC%9D%B8%EA%B7%B8%EB%A0%88%EC%8A%A4-%ED%81%B4%EB%9E%98%EC%8A%A4>https://kubernetes.io/ko/docs/concepts/services-networking/ingress/#인그레스-클래스</a></li></ul><footer class=footline></footer></div><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"umi0410"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><div id=navigation><a class="nav nav-prev" href=/blog/aws/ title=AWS><i class="fa fa-chevron-left"></i></a><a class="nav nav-next" href=/blog/golang/ title=Go style=margin-right:0><i class="fa fa-chevron-right"></i></a></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/js/clipboard.min.js?1612105470></script><script src=/js/perfect-scrollbar.min.js?1612105470></script><script src=/js/perfect-scrollbar.jquery.min.js?1612105470></script><script src=/js/jquery.sticky.js?1612105470></script><script src=/js/featherlight.min.js?1612105470></script><script src=/js/highlight.pack.js?1612105470></script><script>hljs.initHighlightingOnLoad();</script><script src=/js/modernizr.custom-3.6.0.js?1612105470></script><script src=/js/learn.js?1612105470></script><script src=/js/hugo-learn.js?1612105470></script><script src=/mermaid/mermaid.js?1612105470></script><script>mermaid.initialize({startOnLoad:true});</script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-177403492-1','auto');ga('send','pageview');}</script></body></html>