<!doctype html><html lang=ko-kr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="시작하며 홈서버를 직접 구성해보면서 실제 기기 개수가 많지 않아 좀 아쉬웠는데 최근에는 이를 VM으로 충당해볼까 싶은 생각이 들기도 했다. 갖고 있는 랩탑 하나에 여러 대의 VM을 띄우면 홈서버에서 좀 더 많은 수의 노드가 있는 것처럼 이용할 수 있지 않을까 싶어 VM을 띄워보기로 했다. 하지만 이번에는 단순히 GUI로 VM을 띄우는 것이 아니라 CLI로 VM을 띄우면서 LV(Logical Volume)을 이용해봤다. 해당 내용을 까먹을까봐 이 글을 통해 한 번 정리해본다.
실습 환경 호스트 환경은 아래와 같다."><title>VBoxManage(VirtualBox CLI)로 VM 생성하기</title><link rel=canonical href=https://umi0410.github.io/blog/companion-server/create-vm-by-vboxmanage/><link rel=stylesheet href=/scss/style.min.css><meta property="og:title" content="VBoxManage(VirtualBox CLI)로 VM 생성하기"><meta property="og:description" content="시작하며 홈서버를 직접 구성해보면서 실제 기기 개수가 많지 않아 좀 아쉬웠는데 최근에는 이를 VM으로 충당해볼까 싶은 생각이 들기도 했다. 갖고 있는 랩탑 하나에 여러 대의 VM을 띄우면 홈서버에서 좀 더 많은 수의 노드가 있는 것처럼 이용할 수 있지 않을까 싶어 VM을 띄워보기로 했다. 하지만 이번에는 단순히 GUI로 VM을 띄우는 것이 아니라 CLI로 VM을 띄우면서 LV(Logical Volume)을 이용해봤다. 해당 내용을 까먹을까봐 이 글을 통해 한 번 정리해본다.
실습 환경 호스트 환경은 아래와 같다."><meta property="og:url" content="https://umi0410.github.io/blog/companion-server/create-vm-by-vboxmanage/"><meta property="og:site_name" content="Jinsu Playground"><meta property="og:type" content="article"><meta property="article:section" content="Blog"><meta property="article:published_time" content="2022-12-06T01:35:00+09:00"><meta property="article:modified_time" content="2022-12-06T01:35:00+09:00"><meta property="og:image" content="https://umi0410.github.io/blog/companion-server/create-vm-by-vboxmanage/preview.png"><meta name=twitter:title content="VBoxManage(VirtualBox CLI)로 VM 생성하기"><meta name=twitter:description content="시작하며 홈서버를 직접 구성해보면서 실제 기기 개수가 많지 않아 좀 아쉬웠는데 최근에는 이를 VM으로 충당해볼까 싶은 생각이 들기도 했다. 갖고 있는 랩탑 하나에 여러 대의 VM을 띄우면 홈서버에서 좀 더 많은 수의 노드가 있는 것처럼 이용할 수 있지 않을까 싶어 VM을 띄워보기로 했다. 하지만 이번에는 단순히 GUI로 VM을 띄우는 것이 아니라 CLI로 VM을 띄우면서 LV(Logical Volume)을 이용해봤다. 해당 내용을 까먹을까봐 이 글을 통해 한 번 정리해본다.
실습 환경 호스트 환경은 아래와 같다."><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://umi0410.github.io/blog/companion-server/create-vm-by-vboxmanage/preview.png"><link rel="shortcut icon" href=https://emojipedia-us.s3.dualstack.us-west-1.amazonaws.com/thumbs/120/google/241/whale_1f40b.png><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-177403492-1","auto"),ga("send","pageview"))</script><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=East+Sea+Dokdo&family=Noto+Sans+KR:wght@400&display=swap" rel=stylesheet><style>@import 'https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css';:root{--body-background:#fafeff;--base-font-family:Pretendard, 'Noto Sans KR', sans-serif}.site-name{--site-name-font-family:'East Sea Dokdo', cursive;font-family:var(--site-name-font-family);font-size:3.2rem!important}.left-sidebar{--sidebar-avatar-size:200px}figure.site-avatar{margin-left:auto!important;margin-right:auto!important}</style></head><body class="article-page has-toc"><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex
extended"><div id=article-toolbar><a href=https://umi0410.github.io class=back-home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg><span>Back</span></a></div><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/blog/companion-server/create-vm-by-vboxmanage/><img src=/blog/companion-server/create-vm-by-vboxmanage/preview_hu13430b402fc78d1a17ca63e4738b897a_1461489_800x0_resize_box_3.png srcset="/blog/companion-server/create-vm-by-vboxmanage/preview_hu13430b402fc78d1a17ca63e4738b897a_1461489_800x0_resize_box_3.png 800w, /blog/companion-server/create-vm-by-vboxmanage/preview_hu13430b402fc78d1a17ca63e4738b897a_1461489_1600x0_resize_box_3.png 1600w" width=800 height=579 loading=lazy alt="Featured image of post VBoxManage(VirtualBox CLI)로 VM 생성하기"></a></div><div class=article-details><header class=article-category><a href=/categories/companion-server/>반려 서버 키우기</a></header><h2 class=article-title><a href=/blog/companion-server/create-vm-by-vboxmanage/>VBoxManage(VirtualBox CLI)로 VM 생성하기</a></h2><footer class=article-time><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--published>Dec 06, 2022</time></footer></div></header><section class=article-content><h2 id=시작하며>시작하며</h2><p>홈서버를 직접 구성해보면서 실제 기기 개수가 많지 않아 좀 아쉬웠는데 최근에는 이를 VM으로 충당해볼까 싶은 생각이 들기도 했다. 갖고 있는 랩탑 하나에 여러 대의 VM을 띄우면 홈서버에서 좀 더 많은 수의 노드가 있는 것처럼 이용할 수 있지 않을까 싶어 VM을 띄워보기로 했다. 하지만 이번에는 단순히 GUI로 VM을 띄우는 것이 아니라 CLI로 VM을 띄우면서 LV(Logical Volume)을 이용해봤다. 해당 내용을 까먹을까봐 이 글을 통해 한 번 정리해본다.</p><h2 id=실습-환경>실습 환경</h2><p>호스트 환경은 아래와 같다.</p><table><thead><tr><th>CPU</th><th>amd64, 8 Core</th></tr></thead><tbody><tr><td>RAM</td><td>16GB</td></tr><tr><td>Disk</td><td>256GB</td></tr><tr><td>OS</td><td>Ubuntu server 22.04</td></tr></tbody></table><p>구성하고자하는 VM은 다음과 같다.</p><table><thead><tr><th>CPU</th><th>amd64, 2 Core</th></tr></thead><tbody><tr><td>RAM</td><td>4GB</td></tr><tr><td>Disk</td><td>16GB</td></tr><tr><td>OS</td><td>Ubuntu server 22.04</td></tr></tbody></table><p>우선 내 랩탑의 OS는 Ubuntu server 22.04이기에 기본적으로 GUI 프로그램은 아예 실행이 안된다. 따라서 VirtualBox GUI는 이용할 수 없었고 VBoxManage라는 CLI 프로그램을 사용했다.</p><p>이번에 만들어볼 것은 Host machine의 Linux LV(Logical Volume)을 본인(VM)의 디스크 장치로 이용하는 VM이다.</p><p>굳이 LV를 이용하고자 했던 이유는 호스트 머신의 OS를 완전히 다시 설치하더라도 VM의 데이터는 보존되길 바랬기 때문이다. 사실 이렇게까지 할 필요는 딱히 없었는데 요즘 볼륨이나 마운트쪽이 궁금해져 이렇게 작업해봤다.</p><h2 id=lv-생성하기>LV 생성하기</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ lsblk
</span></span><span class=line><span class=cl>NAME                      MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS
</span></span><span class=line><span class=cl>...<span class=o>(</span>생략<span class=o>)</span>
</span></span><span class=line><span class=cl>sda                         8:0    <span class=m>0</span> 238.5G  <span class=m>0</span> disk
</span></span><span class=line><span class=cl>├─sda1                      8:1    <span class=m>0</span>     1G  <span class=m>0</span> part /boot/efi
</span></span><span class=line><span class=cl>├─sda2                      8:2    <span class=m>0</span>     2G  <span class=m>0</span> part /boot
</span></span><span class=line><span class=cl>└─sda3                      8:3    <span class=m>0</span> 235.4G  <span class=m>0</span> part
</span></span><span class=line><span class=cl>  └─ubuntu--vg-ubuntu--lv 253:0    <span class=m>0</span>   100G  <span class=m>0</span> lvm  /
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ sudo pvs
</span></span><span class=line><span class=cl>  PV         VG        Fmt  Attr PSize   PFree
</span></span><span class=line><span class=cl>  /dev/sda3  ubuntu-vg lvm2 a--  235.42g 135.42g
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ sudo vgs
</span></span><span class=line><span class=cl>  VG        <span class=c1>#PV #LV #SN Attr   VSize   VFree</span>
</span></span><span class=line><span class=cl>  ubuntu-vg   <span class=m>1</span>   <span class=m>1</span>   <span class=m>0</span> wz--n- 235.42g 135.42g
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ sudo lvs
</span></span><span class=line><span class=cl>  LV        VG        Attr       LSize   Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
</span></span><span class=line><span class=cl>  ubuntu-lv ubuntu-vg -wi-ao---- 100.00g
</span></span></code></pre></div><ul><li>sda라는 디스크 장치에 sda1, sda2, sda3라는 Physical Volume이 존재함.</li><li>ubuntu-vg라는 Volume Group은 sda3라는 Physical Volume으로 구성됨.</li><li>ubuntu-vg라는 Volume Group 아래에는 ubuntu-lv라는 Logical Volume이 존재함.</li></ul><p><code>lsblk</code> 로 랩탑의 디바이스 정보를 출력해본 내용은 위와 같다.</p><p>앞으로 만들 vm1이라는 VM에게 ubuntu-vg(sda3)에 남는 135.4G 중 16GB를 Logical Volume으로 할당해줄 것이다. 따라서 LV를 만들어주자.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ sudo lvcreate -n vm1-disk -L 16G ubuntu-vg
</span></span><span class=line><span class=cl>  Logical volume <span class=s2>&#34;vm1-disk&#34;</span> created.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ sudo lvs
</span></span><span class=line><span class=cl>  LV        VG        Attr       LSize   Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
</span></span><span class=line><span class=cl>  ubuntu-lv ubuntu-vg -wi-ao---- 100.00g
</span></span><span class=line><span class=cl>  vm1-disk  ubuntu-vg -wi-a-----  16.00g
</span></span></code></pre></div><p>vm1이 Disk로 사용할 LV가 잘 만들어진 모습이다. 포맷하며 파일시스템을 설정해줘야하려나 싶었는데 딱히 그렇지는 않고 그냥 바로 VirtualBox가 사용하도록 해줄 수 있는 듯하다.</p><h2 id=이미지-준비하기>이미지 준비하기</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo apt update
</span></span><span class=line><span class=cl>sudo apt install -y virtualbox virtualbox-ext-pack
</span></span></code></pre></div><p>우선 이제 슬슬 virtualbox가 필요할 것이기에 virtualbox를 설치해준다. ext-pack은 extension인데 학습할 때에는 웬만하면 있는 게 좋을 것이다. 아마 잠시 후 RDP(Remote Desktop Protocol)라는 프로토콜을 이용할 때에도 ext-pack이 있어야할 것이다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>sudo su
</span></span><span class=line><span class=cl><span class=nb>alias</span> <span class=nv>vb</span><span class=o>=</span>VBoxManage
</span></span></code></pre></div><p>이제부터는 많은 명령어들이 root 권한을 필요로 할 것이다. 따라서 대부분의 작업을 root로 수행할 것이다.</p><p>그리고 vboxmanage라는 커맨드가 상당히 마음에 들지 않아서 나는 <code>vb</code> 라는 alias를 이용했다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># vb internalcommands createrawvmdk \</span>
</span></span><span class=line><span class=cl>    -filename vm1-disk.vmdk <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -rawdisk /dev/ubuntu-vg/vm1-disk
</span></span><span class=line><span class=cl>RAW host disk access VMDK file vm1-disk.vmdk created successfully.
</span></span></code></pre></div><p>internal command를 이용해 호스트의 디스크 전체를 사용하는 VMDK 이미지를 <code>vm1-disk.vmdk</code> 생성했다. 생성되는 <code>.vmdk</code> 파일의 크기는 몇 백 바이트 정도로 상당히 작은데, 이 파일 자체가 데이터를 담는 것은 아니고 그냥 어떻게 호스트의 디스크(현재의 경우 vm1-disk)를 이용할 지에 대한 설정만 존재할 뿐이라서 그런 듯하다. 참고로 <code>cat</code> 을 통해 내용을 확인해볼 수도 있다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>curl -LO https://mirror.kakao.com/ubuntu-releases/22.04/ubuntu-22.04.1-live-server-amd64.iso
</span></span></code></pre></div><p>그리고 이제 Ubuntu Server 22.04에 대한 .iso 이미지 파일을 다운로드 해준다. 카카오의 미러링 페이지를 이용하면 와이파이로도 빠른 경우 약 30초만에 다운로드가 가능하다. 이 이미지는 설치용 이미지이다.</p><p>이제 이미지 준비는 완료 됐다 🙂</p><h2 id=vboxmanagevirtualbox-cli를-통해-vm-생성하기>VBoxManage(VirtualBox CLI)를 통해 VM 생성하기</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>mkdir -p vbox
</span></span></code></pre></div><p>현재의 로컬 경로에 virtualbox vm이 base folder로 사용할 디렉토리를 만들어준다. 사실 글 초반에 적은 취지에 맞추려면 이 경로도 별도의 볼륨쪽이면 좋을 듯하긴한데 일단은 그냥 <code>/root/vbox</code> 로 이용하려한다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># vb createvm --name vm1 \</span>
</span></span><span class=line><span class=cl>    --basefolder<span class=o>=</span>/root/vbox <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --ostype<span class=o>=</span>Ubuntu_64 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --register
</span></span><span class=line><span class=cl>Virtual machine <span class=s1>&#39;vm1&#39;</span> is created and registered.
</span></span><span class=line><span class=cl>UUID: 8ad1ab2c-1e7d-4e22-b65c-51ff7cacfc25
</span></span><span class=line><span class=cl>Settings file: <span class=s1>&#39;/root/vbox/vm1/vm1.vbox&#39;</span>
</span></span></code></pre></div><p>VM이 생성됐다고 한다! 하지만, VM을 실행하기 전에 몇 가지 설정을 더 해줘야한다.</p><p>아직 우리는 앞서 만든 image들을 mount하지도 않았기 때문이다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># vb storagectl vm1 \</span>
</span></span><span class=line><span class=cl>    --name <span class=s2>&#34;SATA Controller&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --add sata --bootable on
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># vb storageattach vm1 \</span>
</span></span><span class=line><span class=cl>    --storagectl <span class=s2>&#34;SATA Controller&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --port <span class=m>0</span> --device <span class=m>0</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --type dvddrive <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --medium ubuntu-22.04.1-live-server-amd64.iso
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># vb storageattach vm1 \</span>
</span></span><span class=line><span class=cl>    --storagectl <span class=s2>&#34;SATA Controller&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --port <span class=m>1</span> --device <span class=m>0</span> --type hdd <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --medium /root/vm1-disk.vmdk
</span></span></code></pre></div><p>SATA라는 Hard Disk Controller을 추가해준 뒤 생성해뒀던 <code>vm1-disk.vmdk</code> (16GB짜리 LV 관련) 이미지를 HDD로서 추가해준다.</p><p>그리고 bridge network를 통해 host와 같은 네트워크를 이용할 수 있게끔할 것이다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># ip addr show wlp2s0</span>
</span></span><span class=line><span class=cl>2: wlp2s0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class=m>1500</span> qdisc noqueue state UP group default qlen <span class=m>1000</span>
</span></span><span class=line><span class=cl>    link/ether 20:16:b9:9b:55:1e brd ff:ff:ff:ff:ff:ff
</span></span><span class=line><span class=cl>    inet 192.168.219.180/24 metric <span class=m>600</span> brd 192.168.219.255 scope global dynamic wlp2s0
</span></span><span class=line><span class=cl>       valid_lft 13790sec preferred_lft 13790sec
</span></span><span class=line><span class=cl>    inet6 fe80::2216:b9ff:fe9b:551e/64 scope link
</span></span><span class=line><span class=cl>       valid_lft forever preferred_lft forever
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># vb modifyvm vm1 --nic1 bridged --bridgeadapter1 wlp2s0</span>
</span></span></code></pre></div><p>내 경우에는 <code>wlp2s0</code> 라는 와이파이 네트워크 인터페이스에 bridge 할 수 있도록 설정했다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># vb modifyvm vm1 --memory 4092 \</span>
</span></span><span class=line><span class=cl>    --cpus <span class=m>2</span>
</span></span></code></pre></div><p>앞서 언급한 대로 Memory는 4GB, CPU는 2 Core로 설정했다.</p><p>이제 거의 다 왔다.</p><p>하지만 일반적인 GUI에서 VirtualBox를 통해 VM을 실행했을 때와 달리 나의 호스트 머신의 OS는 Ubuntu Server이기 때문에 나는 설치 이미지로 VM을 시작했을 때 VM의 화면을 볼 수 없다.</p><p>만약 Cloud image를 이용하거나 Auto installation 설정을 잘 해뒀다면 화면 없이 어떻게 어떻게 알아서 OS를 설치하고 설정한 Bridge adapter을 이용해 DHCP해서 네트워크에 조인하고 SSH 서버가 켜질 수 있을 것이다. 이렇게 되면 GUI 없이 Host machine 및 같은 네트워크 장비에서 SSH로 접속할 수 있는 게 맞긴하다.</p><p>하지만 지금 이용 중인 Ubuntu server 이미지는 Cloud image도 아니고 우리는 별도로 Auto installation 설정을 한 것도 아니기에 Display 장치를 통해 화면을 보면서 키보드로 설치를 진행해야할 것이다.</p><p>이때 사용할 수 있는 것이 RDP(Remote Desktop Protocol)이라는 기술이다. 자세한 내용은 따로 찾아보는 걸로하고 여기선 간단히 정리하자면 그냥 Remote에서 VM의 화면을 보면서 입출력을 할 수 있는 기술을 의미한다. 나의 경우 같은 공유기 아래의 맥북에서 RDP 접속을 통해 Ubuntu Server 호스트의 Ubuntu Server Guest(VM)의 설치를 진행할 수 있었다.</p><p><figure style=flex-grow:745;flex-basis:1790px><a href=/blog/companion-server/create-vm-by-vboxmanage/mermaid-connection-flow.png data-size=813x109><img src=/blog/companion-server/create-vm-by-vboxmanage/mermaid-connection-flow.png srcset="/blog/companion-server/create-vm-by-vboxmanage/mermaid-connection-flow_hu7749fb9e9bf25ce37e865f90ba2cc26c_14638_480x0_resize_box_3.png 480w, /blog/companion-server/create-vm-by-vboxmanage/mermaid-connection-flow_hu7749fb9e9bf25ce37e865f90ba2cc26c_14638_1024x0_resize_box_3.png 1024w" width=813 height=109 loading=lazy></a></figure></p><p>위의 그림과 같이 맥북을 통해 호스트 머신에 RDP로 접속하면 Guset에 연결될 수 있을 것이다.</p><p><figure style=flex-grow:227;flex-basis:544px><a href=/blog/companion-server/create-vm-by-vboxmanage/microsoft-remote-desktop.png data-size=1912x842><img src=/blog/companion-server/create-vm-by-vboxmanage/microsoft-remote-desktop.png srcset="/blog/companion-server/create-vm-by-vboxmanage/microsoft-remote-desktop_hu2524cf3bdcb3adef8cf4101d9218953f_210336_480x0_resize_box_3.png 480w, /blog/companion-server/create-vm-by-vboxmanage/microsoft-remote-desktop_hu2524cf3bdcb3adef8cf4101d9218953f_210336_1024x0_resize_box_3.png 1024w" width=1912 height=842 loading=lazy></a></figure></p><p>RDP를 이용하기 위해선 클라이언트 프로그램이 필요할 것이다.</p><p>OSX에서는 remote desktop 클라이언트로 Microsoft Remote Desktop이 가장 좋은 듯했다. 나머지는 유료거나 자기들이 개발한 자체 프로토콜 or http 등을 이용하는 것 같았다.</p><p>RDP 프로토콜에서 인증이 필수는 아닐 것 같은데 아쉽게도 이 훌륭한 클라이언트의 단점이 하나 있다면 인증이 강제되는 것 같다는 것이다.</p><p>따라서 VM에 RDP 설정을 켜고, 인증을 활성화 해야한다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># export VRDE_USERNAME=foo</span>
</span></span><span class=line><span class=cl><span class=c1># export VRDE_PASSWORD=bar</span>
</span></span></code></pre></div><p>위와 같이 RDP 인증에 사용할 username, password를 설정해준다. 이후 커맨드에서 사용하게 될 환경변수이다. 그냥 VRDE는 VirtualBox에서 RDP를 부르는 말 정도로만 알고 넘어가도 될 듯하다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># vb setproperty vrdeauthlibrary VBoxAuthSimple</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># vb modifyvm vm1 --vrde on \</span>
</span></span><span class=line><span class=cl>    --vrdeport <span class=m>3389</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --vrdeauthtype external
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># export PASSWORD_HASHED=$(vb internalcommands passwordhash $VRDE_PASSWORD | \</span>
</span></span><span class=line><span class=cl>    sed <span class=s1>&#39;s/^Password hash: //&#39;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># vb setextradata vm1 \</span>
</span></span><span class=line><span class=cl>    VBoxAuthSimple/users/<span class=nv>$VRDE_USERNAME</span> <span class=nv>$PASSWORD_HASHED</span>
</span></span><span class=line><span class=cl><span class=c1># vb getextradata vm1 enumerate | \</span>
</span></span><span class=line><span class=cl>    grep <span class=s2>&#34;VBoxAuthSimple/users/</span><span class=nv>$VRDE_USERNAME</span><span class=s2>&#34;</span>
</span></span></code></pre></div><p>좀 복잡하긴한데 쉽게 요약하면 그냥 RDP 인증을 VBoxAuthSimple이라는 방식을 통해 진행하겠다는 거고 그를 위한 username, password를 설정하는 작업이다.</p><p>좀 더 자세히 설명하자면 다음과 같다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># vb internalcommands passwordhash $VRDE_PASSWORD</span>
</span></span><span class=line><span class=cl>Password hash: fcde2b2edba56bf408601fb721fe9b5c338d10ee429ea04fae5511b68fbf8fb9
</span></span></code></pre></div><p>password를 설정하기 위해 password를 해시하는 커맨드이다. plain password를 그대로 설정하지 않고 한 번 미리 해시한 뒤에 그 값을 전달해줘야한다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># vb getextradata vm1 enumerate | \</span>
</span></span><span class=line><span class=cl>    grep <span class=s2>&#34;VBoxAuthSimple/users/</span><span class=nv>$VRDE_USERNAME</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>Key: VBoxAuthSimple/users/foo, Value: fcde2b2edba56bf408601fb721fe9b5c338d10ee429ea04fae5511b68fbf8fb9
</span></span></code></pre></div><p>extradata를 조회해봄으로써 <code>foo</code> 라는 유저의 해쉬된 패스워드 값을 확인해볼 수 있다.</p><p>이 값이 조회되지 않으면 인증 설정이 제대로 적용되지 않은 것이다.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=c1># vb startvm vm1 --type headless</span>
</span></span></code></pre></div><p>드디어! vm을 시작할 때가 됐다. <code>--type headless</code> 인자를 주게 되면 VM의 화면을 바로 GUI로 띄우지 않고 headless mode로 시작한다. GUI로 띄우기 위한 도구들이 호스트에 제대로 설치되어있지 않다면 에러가 날 것이고 나의 랩탑 또한 거의 순정 상태의 Ubuntu server였기 때문에 headless mode로 시작해야만 했다.</p><p><figure style=flex-grow:277;flex-basis:665px><a href=/blog/companion-server/create-vm-by-vboxmanage/microsoft-remote-desktop-connect.png data-size=1962x708><img src=/blog/companion-server/create-vm-by-vboxmanage/microsoft-remote-desktop-connect.png srcset="/blog/companion-server/create-vm-by-vboxmanage/microsoft-remote-desktop-connect_hu0135d8f9d5ad1022e5fa8dd0554fb333_367603_480x0_resize_box_3.png 480w, /blog/companion-server/create-vm-by-vboxmanage/microsoft-remote-desktop-connect_hu0135d8f9d5ad1022e5fa8dd0554fb333_367603_1024x0_resize_box_3.png 1024w" width=1962 height=708 loading=lazy></a></figure></p><p>RDP Client(e.g. Microsoft Remote Desktop)에서 위와 같이 설정해주면 될 것이다.</p><p><figure style=flex-grow:211;flex-basis:508px><a href=/blog/companion-server/create-vm-by-vboxmanage/installation-1.png data-size=1021x482><img src=/blog/companion-server/create-vm-by-vboxmanage/installation-1.png srcset="/blog/companion-server/create-vm-by-vboxmanage/installation-1_hu4618397b7581852c0b647ff44c653258_52041_480x0_resize_box_3.png 480w, /blog/companion-server/create-vm-by-vboxmanage/installation-1_hu4618397b7581852c0b647ff44c653258_52041_1024x0_resize_box_3.png 1024w" width=1021 height=482 loading=lazy></a></figure></p><p><figure style=flex-grow:384;flex-basis:922px><a href=/blog/companion-server/create-vm-by-vboxmanage/installation-2.png data-size=826x215><img src=/blog/companion-server/create-vm-by-vboxmanage/installation-2.png srcset="/blog/companion-server/create-vm-by-vboxmanage/installation-2_hu4d83c2a522737fa70c79baad2bc0090d_28789_480x0_resize_box_3.png 480w, /blog/companion-server/create-vm-by-vboxmanage/installation-2_hu4d83c2a522737fa70c79baad2bc0090d_28789_1024x0_resize_box_3.png 1024w" width=826 height=215 loading=lazy></a></figure></p><p>🎉 RDP를 통해 성공적으로 연결되면 이렇게 설치 화면을 볼 수 있을 것이다!</p><p>와우.. 드디어 VBoxManage로 VM을 띄우는 데에 성공했다. 호스트의 공유기에 붙은 인터페이스를 브릿지 어댑터로 설정하니 호스트와 같이 공유기에 DHCP로 IP를 할당받는 것도 성공한 모습이다.</p><p><figure style=flex-grow:211;flex-basis:508px><a href=/blog/companion-server/create-vm-by-vboxmanage/installation-1.png data-size=1021x482><img src=/blog/companion-server/create-vm-by-vboxmanage/installation-1.png srcset="/blog/companion-server/create-vm-by-vboxmanage/installation-1_hu4618397b7581852c0b647ff44c653258_52041_480x0_resize_box_3.png 480w, /blog/companion-server/create-vm-by-vboxmanage/installation-1_hu4618397b7581852c0b647ff44c653258_52041_1024x0_resize_box_3.png 1024w" width=1021 height=482 loading=lazy></a></figure></p><p>설치가 완료된 뒤 RDP로 연결된 화면에서 몇 가지 명령어를 사용해봤다. 🙂 설치가 완료되면 이제 RDP는 굳이 사용하지 않아도 된다. 기본적으로 같은 네트워크의 어떤 장비에서든 설치 시에 입력한 username, password로 SSH 접속이 가능할 것이다. 예를 들면 다음과 같이 말이다.</p><p><figure style=flex-grow:384;flex-basis:922px><a href=/blog/companion-server/create-vm-by-vboxmanage/installation-2.png data-size=826x215><img src=/blog/companion-server/create-vm-by-vboxmanage/installation-2.png srcset="/blog/companion-server/create-vm-by-vboxmanage/installation-2_hu4d83c2a522737fa70c79baad2bc0090d_28789_480x0_resize_box_3.png 480w, /blog/companion-server/create-vm-by-vboxmanage/installation-2_hu4d83c2a522737fa70c79baad2bc0090d_28789_1024x0_resize_box_3.png 1024w" width=826 height=215 loading=lazy></a></figure></p><p>👆 같은 네트워크의 맥북에서 VM에 SSH 접속을 해서 아무 명령어나 실행해본 예시</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># vb controlvm vm1 poweroff</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># vb storageattach vm1 \</span>
</span></span><span class=line><span class=cl>    --storagectl <span class=s2>&#34;SATA Controller&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --port <span class=m>0</span> --device <span class=m>0</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --medium none
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># vb storageattach vm1 \</span>
</span></span><span class=line><span class=cl>    --storagectl <span class=s2>&#34;SATA Controller&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --port <span class=m>1</span> --device <span class=m>0</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --medium none
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># vb storageattach vm1 \</span>
</span></span><span class=line><span class=cl>    --storagectl <span class=s2>&#34;SATA Controller&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --port <span class=m>0</span> --device <span class=m>0</span> --type hdd <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --medium /root/vm1-disk.vmdk
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># vb startvm vm1 --type headless</span>
</span></span></code></pre></div><p>그리고 이제 설치가 완료됐으니 더 이상 설치용 이미지인 <code>ubuntu-22.04.1-live-server-amd64.iso</code> 를 dvddrive로 붙여줄 필요도 없다. 꼭 해야하는 작업은 아니긴하지만 <code>--medium none</code> 을 통해 장치들을 모두 연결 해제한 뒤 그냥 <code>.vmdk</code> 를 0번 포트에 연결해줄 수 있다.</p><h2 id=배운-것-얻은-것>배운 것, 얻은 것</h2><ul><li>PV, VG, LV 등 Linux의 LVM(Logical Volume Manager)의 개념을 접해볼 수 있었다.</li><li>‘VirtualBox의 모든 기능을 VBoxManage로 사용할 수 있구나’싶었다.</li><li>RDP, VRDE라는 개념을 접해볼 수 있었다.</li><li>Bridge Adapter, NAT, NAT Network, Host only 등 VirtualBox에서 사용하는 네트워크 형태를 한 번 더 경험해볼 수 있었다.</li></ul><h2 id=글에서-다룬-내용-외에-더-해볼-만한-것>글에서 다룬 내용 외에 더 해볼 만한 것</h2><ul><li>cloud-init 볼륨을 통한 auto installation - cloud-init이라는 방식을 이용하면 직접 설치 과정을 하나 하나 진행할 필요 없이 설치와 초기 설정을 자동화 할 수 있다.</li><li>Live 이미지가 아닌 Cloud image 이용하기 - Cloud image를 이용하면 auto install하는 게 기본 설정인듯 함. 좀 더 손쉽게 auto install할 수 있는 느낌이랄까.</li><li>PXE 네트워크 부팅</li><li>qemu, lima 등 다른 가상화 도구를 통해 VM을 이용해보기</li><li>원하는 다양한 네트워크 토폴로지 구성해보기</li></ul><h2 id=마치며>마치며</h2><p>며칠 전에 VirtualBox로 VM을 만들 때 Ubuntu server에서 CLI인 VBoxManage로 만들어보겠다고 꽤나 많은 삽질을 했었다. 뿐만 아니라 요즘 pxe, qemu, bridge interface, kubespray 등등으로 인해 많은 삽질이 계속되고 있었다. 본업은 본업대로 하고 퇴근 후에 취미로 공부하다보니 시간이 많지 않다보니 계속 삽질만 하고 배운 내용을 복습/정리하지 못한 것 같아서 한 번 정리해봤다.</p><p>LVM, IDE와 SATA의 차이, RDP라는 새로운 프로토콜, img와 iso, 등등… 많은 새로운 개념 혹은 들어만 봤던 개념들을 직접 이용해보려하니 GUI에서는 정말 쉬웠던 작업을 진행하는 데에 많은 삽질이 수반됐다.</p><p>다음에는 qemu로 VM 띄우는 내용을 작성해볼까하는데 시간이 될지는 모르겠다 화이팅..! 💪</p></section><footer class=article-footer><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-contents--wrapper><h2 class=section-title>관련 글</h2><div class=related-contents><div class="flex article-list--tile"><article class=has-image><a href=/blog/companion-server/core-dns/><div class=article-image><img src=/blog/companion-server/core-dns/preview.06fa0a861baa356bcf9c11ca75ad3713_hudf745d9e6218ded522d0b9ff98b2db64_1519649_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy data-key data-hash="md5-BvoKhhuqNWvPnBHKda03Ew=="></div><div class=article-details><h2 class=article-title>[반려 서버 키우기 사전 작업] Core DNS를 홈랩의 커스텀 DNS 서버로 이용하기</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//umi0410.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{DISQUS&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2020 -
2022 Jinsu Playground</section><section class=powerby><a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a>로 만듦<br><a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a>의 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=2.4.0>Stack</a></b> 테마 사용 중</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous></main><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#시작하며>시작하며</a></li><li><a href=#실습-환경>실습 환경</a></li><li><a href=#lv-생성하기>LV 생성하기</a></li><li><a href=#이미지-준비하기>이미지 준비하기</a></li><li><a href=#vboxmanagevirtualbox-cli를-통해-vm-생성하기>VBoxManage(VirtualBox CLI)를 통해 VM 생성하기</a></li><li><a href=#배운-것-얻은-것>배운 것, 얻은 것</a></li><li><a href=#글에서-다룬-내용-외에-더-해볼-만한-것>글에서 다룬 내용 외에 더 해볼 만한 것</a></li><li><a href=#마치며>마치며</a></li></ol></nav></div></section></aside></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous defer></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>